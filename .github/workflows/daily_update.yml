name: Daily Market Update

on:
  # Chạy tự động lúc 08:30 UTC = 15:30 VN time (sau khi thị trường đóng cửa)
  schedule:
    - cron: '30 8 * * 1-5'  # Thứ 2-6, 15:30 VN

  # Cho phép chạy thủ công
  workflow_dispatch:
    inputs:
      force_collect:
        description: 'Force re-collect data'
        type: boolean
        default: false

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  UI_GLM_MIN_SUCCESS_ITEMS: "3"

permissions:
  contents: write
  pages: write
  id-token: write

# ==============================================================================
# JOB 1: Kiểm tra lịch nghỉ lễ trước khi chạy pipeline
# ==============================================================================
jobs:
  check-trading-day:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout holiday calendar
        uses: actions/checkout@v4
        with:
          sparse-checkout: market/trading_holidays.txt
          sparse-checkout-cone-mode: false

      - name: Check trading calendar
        id: check
        run: |
          VN_DATE=$(TZ='Asia/Ho_Chi_Minh' date +%Y-%m-%d)
          echo "Ngày hiện tại (VN): $VN_DATE"

          # Chạy thủ công → luôn chạy, bỏ qua lịch nghỉ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Chạy thủ công (workflow_dispatch) - bỏ qua kiểm tra nghỉ lễ"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Kiểm tra ngày nghỉ lễ (bỏ qua dòng comment và dòng trống)
          if [ -f market/trading_holidays.txt ] && grep -qE "^${VN_DATE}" market/trading_holidays.txt; then
            HOLIDAY_INFO=$(grep -E "^${VN_DATE}" market/trading_holidays.txt | head -1 | sed 's/.*#\s*//')
            echo "::notice::Hôm nay ($VN_DATE) là ngày nghỉ lễ: $HOLIDAY_INFO — Bỏ qua pipeline."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "Ngày giao dịch bình thường — Tiếp tục pipeline."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  # ==============================================================================
  # JOB 2: Pipeline chính - chỉ chạy nếu là ngày giao dịch
  # ==============================================================================
  update-dashboard:
    needs: check-trading-day
    if: needs.check-trading-day.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ====================================================================
      # SETUP
      # ====================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: market/requirements.txt

      - name: Install dependencies
        run: pip install -r market/requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ====================================================================
      # STEP 1: THU THẬP DATA
      # ====================================================================
      - name: Collect market data from dmanh-ai/vnstock
        run: python3 market/collect_data.py

      - name: Collect extra data (commodities, FX, gold, bonds, funds)
        run: python3 market/collect_extra_data.py

      # ====================================================================
      # STEP 2: AI VIẾT BÁO CÁO
      # ====================================================================
      - name: Generate AI report
        run: |
          OUTPUT=$(python3 market/generate_report.py)
          REPORT_PATH=$(echo "$OUTPUT" | grep "REPORT_PATH=" | cut -d= -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_ENV
          echo "Report generated: $REPORT_PATH"

      # ====================================================================
      # STEP 3: PARSE BÁO CÁO → JS
      # ====================================================================
      - name: Parse report to JavaScript
        run: |
          if [ -z "$REPORT_PATH" ]; then
            REPORT_PATH=$(ls -t reports/txt/BaoCao_*.txt 2>/dev/null | head -1)
          fi

          if [ -z "$REPORT_PATH" ]; then
            echo "No report file found!"
            exit 1
          fi

          echo "Parsing: $REPORT_PATH"
          TIMESTAMP=$(basename "$REPORT_PATH" .txt | sed 's/BaoCao_//')
          OUTPUT_JS="full_data_${TIMESTAMP}.js"

          python3 tools/auto_parse.py "$REPORT_PATH" "$OUTPUT_JS"

          # Validate JS syntax
          node --check "$OUTPUT_JS"

          # Copy to main
          cp "$OUTPUT_JS" full_data.js

          echo "Parsed successfully: $OUTPUT_JS"

      # ====================================================================
      # STEP 4: BUILD PUBLIC DATA
      # ====================================================================
      - name: Build public data
        run: |
          if [ -f tools/build_public_data.js ]; then
            node tools/build_public_data.js full_data.js full_data_public.js
            echo "Public data built"
          else
            echo "build_public_data.js not found, copying full_data.js"
            cp full_data.js full_data_public.js
          fi

      # ====================================================================
      # STEP 5: GENERATE JS DATA FILES
      # ====================================================================
      - name: Generate JS data files
        run: python3 market/generate_market_data_js.py

      # ====================================================================
      # STEP 5.5: ARCHIVE DAILY SNAPSHOT (lưu lịch sử)
      # ====================================================================
      - name: Archive daily snapshot
        run: python3 market/archive_daily.py

      # Re-generate JS to include history_data.js
      - name: Generate history JS
        run: python3 -c "
          import sys; sys.path.insert(0, 'market')
          from generate_market_data_js import generate_history
          generate_history()
          "

      # ====================================================================
      # STEP 6: GENERATE META
      # ====================================================================
      - name: Generate metadata
        run: |
          # Lấy asof date từ data thay vì current time
          ASOF_ISO=$(python3 -c "
          import json
          with open('market_cache/index_ohlcv.json') as f:
              d = json.load(f)
          print(d.get('asof', ''))
          " 2>/dev/null || date -u +"%Y-%m-%d")

          TODAY=$(date -u +"%Y%m%d_%H%M%S")
          HUMAN_DATE=$(echo $ASOF_ISO | awk -F- '{printf "%s/%s/%s", $3, $2, $1}')
          HUMAN_UPDATED=$(date -u +"%d/%m/%Y %H:%M")

          cat > ui_glm_meta.json << EOF
          {
            "stamp": "${TODAY}",
            "asof_iso": "${ASOF_ISO}",
            "human_date": "${HUMAN_DATE}",
            "human_updated_at": "${HUMAN_UPDATED}",
            "source_docx": "GitHub Actions Auto"
          }
          EOF

          echo "Meta generated for $ASOF_ISO"

      # ====================================================================
      # STEP 7: COMMIT & PUSH
      # ====================================================================
      - name: Commit and push
        run: |
          git config user.email "ducmanh.isg@gmail.com"
          git config user.name "Dmanh"

          # Add generated files individually (missing files must not block others)
          for f in full_data_public.js ui_glm_meta.json index_ohlcv.js market_breadth_snapshot.js vnindex_price_20d.js vnindex_heatmap_data.js index_heatmap_data.js foreign_flow_data.js bondlab_data.js researchlab_data.js commodities_data.js portfolio_data.js fund_data.js history_data.js history_data.json; do
            [ -f "$f" ] && git add -f "$f" && echo "Staged: $f" || echo "Skip (not found): $f"
          done

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          DATE=$(date -u +"%Y-%m-%d")
          git commit -m "Auto: Update market data for ${DATE}

          Generated by GitHub Actions
          Source: dmanh-ai/vnstock CSV + Claude Sonnet"

          git push origin main

          echo "Pushed to main successfully!"

      # ====================================================================
      # STEP 8: TRIGGER GITHUB PAGES REBUILD
      # ====================================================================
      - name: Trigger Pages deployment
        run: |
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pages/builds"
          echo "Pages rebuild triggered!"
