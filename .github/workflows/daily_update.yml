name: Daily Market Update

on:
  # Chạy tự động lúc 11:00 UTC = 18:00 VN time (sau khi thị trường đóng cửa)
  schedule:
    - cron: '0 11 * * 1-5'  # Thứ 2-6, 18:00 VN

  # Cho phép chạy thủ công
  workflow_dispatch:
    inputs:
      force_collect:
        description: 'Force re-collect data'
        type: boolean
        default: false

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ====================================================================
      # SETUP
      # ====================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: market/requirements.txt

      - name: Install dependencies
        run: pip install -r market/requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ====================================================================
      # STEP 1: THU THẬP DATA
      # ====================================================================
      - name: Collect market data from dmanh-ai/vnstock
        run: python market/collect_data.py
        continue-on-error: false

      # ====================================================================
      # STEP 2: AI VIẾT BÁO CÁO
      # ====================================================================
      - name: Generate AI report
        run: |
          OUTPUT=$(python market/generate_report.py)
          REPORT_PATH=$(echo "$OUTPUT" | grep "REPORT_PATH=" | cut -d= -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_ENV
          echo "Report generated: $REPORT_PATH"

      # ====================================================================
      # STEP 3: PARSE BÁO CÁO → JS
      # ====================================================================
      - name: Parse report to JavaScript
        run: |
          if [ -z "$REPORT_PATH" ]; then
            REPORT_PATH=$(ls -t reports/txt/BaoCao_*.txt 2>/dev/null | head -1)
          fi

          if [ -z "$REPORT_PATH" ]; then
            echo "No report file found!"
            exit 1
          fi

          echo "Parsing: $REPORT_PATH"
          TIMESTAMP=$(basename "$REPORT_PATH" .txt | sed 's/BaoCao_//')
          OUTPUT_JS="full_data_${TIMESTAMP}.js"

          python tools/auto_parse.py "$REPORT_PATH" "$OUTPUT_JS"

          # Validate
          node --check "$OUTPUT_JS"

          # Copy to main
          cp "$OUTPUT_JS" full_data.js

          echo "Parsed successfully: $OUTPUT_JS"

      # ====================================================================
      # STEP 4: BUILD PUBLIC DATA
      # ====================================================================
      - name: Build public data
        run: |
          if [ -f tools/build_public_data.js ]; then
            node tools/build_public_data.js full_data.js full_data_public.js
            echo "Public data built"
          else
            echo "build_public_data.js not found, copying full_data.js"
            cp full_data.js full_data_public.js
          fi

      # ====================================================================
      # STEP 5: GENERATE JS DATA FILES
      # ====================================================================
      - name: Generate JS data files
        run: python market/generate_market_data_js.py

      # ====================================================================
      # STEP 6: GENERATE META
      # ====================================================================
      - name: Generate metadata
        run: |
          TODAY=$(date -u +"%Y%m%d_%H%M%S")
          DATE_PART=$(echo $TODAY | cut -d_ -f1)
          TIME_PART=$(echo $TODAY | cut -d_ -f2)
          ASOF_ISO="${DATE_PART:0:4}-${DATE_PART:4:2}-${DATE_PART:6:2}"
          HUMAN_DATE="${DATE_PART:6:2}/${DATE_PART:4:2}/${DATE_PART:0:4}"
          HUMAN_UPDATED="${HUMAN_DATE} ${TIME_PART:0:2}:${TIME_PART:2:2}"

          cat > ui_glm_meta.js << EOF
          // AUTO-GENERATED by GitHub Actions
          window.UI_GLM_REPORT_META = {
            stamp: "${TODAY}",
            asof_iso: "${ASOF_ISO}",
            human_date: "${HUMAN_DATE}",
            human_updated_at: "${HUMAN_UPDATED}",
            source_docx: "GitHub Actions Auto"
          };
          EOF

          cat > ui_glm_meta.json << EOF
          {
            "stamp": "${TODAY}",
            "asof_iso": "${ASOF_ISO}",
            "human_date": "${HUMAN_DATE}",
            "human_updated_at": "${HUMAN_UPDATED}",
            "source_docx": "GitHub Actions Auto"
          }
          EOF

          echo "Meta generated for $ASOF_ISO"

      # ====================================================================
      # STEP 7: COMMIT & PUSH
      # ====================================================================
      - name: Commit and push
        run: |
          git config user.email "ducmanh.isg@gmail.com"
          git config user.name "Dmanh"

          # Add all generated files
          git add -f \
            full_data.js \
            full_data_public.js \
            ui_glm_meta.js \
            ui_glm_meta.json \
            index_ohlcv.js \
            index_drivers_20d.js \
            index_foreign_flow_20d.js \
            vnindex_heatmap_data.js \
            index_heatmap_data.js \
            vnindex_company_meta.js \
            vnindex_price_20d.js \
            market_breadth_snapshot.js \
            breadth_history.js \
            2>/dev/null || true

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          DATE=$(date -u +"%Y-%m-%d")
          git commit -m "Auto: Update market data for ${DATE}

          Generated by GitHub Actions
          Source: dmanh-ai/vnstock CSV + Claude Sonnet"

          git push origin main

          echo "Pushed to main successfully!"
