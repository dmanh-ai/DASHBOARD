"""
Tạo JS data files cho dashboard charts.
Chỉ generate các file có data thật từ index OHLCV + breadth.
"""

import json
import sys
import logging
from datetime import datetime
from pathlib import Path

logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
log = logging.getLogger(__name__)

sys.path.insert(0, str(Path(__file__).resolve().parent))

PROJECT_ROOT = Path(__file__).resolve().parent.parent
CACHE_DIR = PROJECT_ROOT / "market_cache"


def load_json(filename):
    path = CACHE_DIR / filename
    if not path.exists():
        log.warning(f"Not found: {path}")
        return {}
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)


def write_js(filename, var_name, data):
    """Ghi JS file: window.VAR_NAME = data;"""
    path = PROJECT_ROOT / filename
    content = f"// AUTO-GENERATED by market/generate_market_data_js.py\n"
    content += f"// Generated: {datetime.now().isoformat()}\n"
    content += f"window.{var_name} = {json.dumps(data, ensure_ascii=False)};\n"
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    log.info(f"Written: {path} ({path.stat().st_size:,} bytes)")


# ============================================================================
# 1. INDEX OHLCV (for TradingView charts)
# ============================================================================

def generate_index_ohlcv():
    """Tạo index_ohlcv.js - data OHLCV cho chart."""
    data = load_json("index_ohlcv.json")
    if not data:
        log.warning("No index_ohlcv.json, skipping")
        return

    output = {
        "asof": data.get("asof", ""),
        "updated_at": datetime.now().isoformat(),
        "indices": {},
    }

    for key, index_data in data.get("indices", {}).items():
        output["indices"][key] = {
            "name": index_data["name"],
            "method": "vnstock-VCI",
            "bars": index_data["bars"],
        }

    write_js("index_ohlcv.js", "UI_GLM_INDEX_OHLCV", output)


# ============================================================================
# 2. MARKET BREADTH SNAPSHOT (from index-level data)
# ============================================================================

def generate_breadth_snapshot():
    """Tạo market_breadth_snapshot.js từ breadth_snapshot.json."""
    breadth = load_json("breadth_snapshot.json")
    if not breadth:
        log.warning("No breadth data available, skipping")
        return

    write_js("market_breadth_snapshot.js", "UI_GLM_MARKET_BREADTH_SNAPSHOT", breadth)


# ============================================================================
# 3. VNINDEX PRICE 20D
# ============================================================================

def generate_vnindex_price_20d():
    """Tạo vnindex_price_20d.js"""
    index_ohlcv = load_json("index_ohlcv.json")
    if not index_ohlcv:
        log.warning("No index OHLCV, skipping vnindex_price_20d")
        return

    vnindex = index_ohlcv.get("indices", {}).get("vnindex", {})
    bars = vnindex.get("bars", [])[-20:]

    output = {
        "asof": bars[-1]["d"] if bars else "",
        "prices": bars,
    }

    write_js("vnindex_price_20d.js", "UI_GLM_VNINDEX_PRICE_20D", output)


# ============================================================================
# MAIN
# ============================================================================

def main():
    log.info("=" * 60)
    log.info("GENERATING JS DATA FILES...")
    log.info("=" * 60)

    generate_index_ohlcv()
    generate_breadth_snapshot()
    generate_vnindex_price_20d()

    log.info("=" * 60)
    log.info("ALL JS FILES GENERATED!")
    log.info("=" * 60)


if __name__ == "__main__":
    main()
