<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <title>ðŸ“Š Market Dashboard V3 - Premium</title>
	    <script src="full_data.js"></script>
		    <script src="vnindex_heatmap_data.js"></script>
		    <script src="index_heatmap_data.js"></script>
		    <script src="vnindex_company_meta.js"></script>
		    <script src="vnindex_price_20d.js"></script>
		    <script src="market_breadth_snapshot.js"></script>
		    <script src="index_ohlcv.js"></script>
		    <script src="vendor/lightweight-charts.standalone.production.js"></script>
		    <script src="scripts/content_formatter.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors */
            --primary: #3b82f6;
            --primary-light: #60a5fa;
            --primary-dark: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --purple: #8b5cf6;

            /* Light Theme */
            --bg-dark: #f1f5f9;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: rgba(226, 232, 240, 0.8);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.12);

            /* Gradients */
            --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-red: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            --gradient-purple: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);

            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            --blur-amount: 12px;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: rgba(71, 85, 105, 0.6);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.4);

            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-blue);
            opacity: 0.05;
            z-index: -1;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 0.05; transform: scale(1); }
            50% { opacity: 0.08; transform: scale(1.1); }
        }

        /* Layout - 3 Columns: Index | Content | Section */
        .dashboard {
            display: grid;
            grid-template-columns: 240px 1fr 280px;
            min-height: 100vh;
            gap: 0;
        }

        /* Glassmorphism Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Sidebar with Glassmorphism */
        .sidebar {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            overflow-y: auto;
            height: 100vh;
            position: sticky;
            top: 0;
            box-shadow: var(--glass-shadow);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .sidebar-header .date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .search-box {
            padding: 0 20px 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            background: var(--bg-card);
        }

        .index-list {
            padding: 0 10px;
        }

        .index-item {
            padding: 14px 16px;
            margin: 4px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-weight: 500;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .index-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--gradient-blue);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .index-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
        }

        .index-item:hover::before {
            transform: scaleY(1);
        }

        .index-item.active {
            background: var(--gradient-blue);
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            transform: translateX(4px);
        }

        .index-item.active::before {
            transform: scaleY(1);
            background: white;
        }

        /* Section Navigation Sidebar (Column 3 - Right) */
        .section-nav {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-left: 1px solid var(--border-color);
            padding: 20px 0;
            overflow-y: auto;
            height: 100vh;
            position: sticky;
            top: 0;
            box-shadow: -8px 0 32px rgba(31, 38, 135, 0.15);
        }

        .section-nav-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .section-nav-header h3 {
            font-size: 1rem;
            font-weight: 700;
            background: var(--gradient-purple);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .section-nav-header .subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-list {
            padding: 0 10px;
        }

        .section-item {
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-weight: 500;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-item .icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .section-item .title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .section-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--gradient-purple);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .section-item:hover {
            background: var(--bg-hover);
            transform: translateX(-4px);
        }

        .section-item:hover::before {
            transform: scaleY(1);
        }

        .section-item.active {
            background: var(--gradient-purple);
            color: white;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            transform: translateX(-4px);
        }

        .section-item.active::before {
            transform: scaleY(1);
            background: white;
        }

        .section-item.whatif {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .section-item.whatif.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #f59e0b;
        }

        .section-item.whatif .icon {
            color: #d97706;
        }

        .section-item.whatif.active .icon {
            color: white;
        }

        /* CONCLUSION SECTION - Highlight in section list */
        .section-item.conclusion-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 2px solid rgba(139, 92, 246, 0.4);
            border-left: 5px solid #8b5cf6;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.2);
        }

        .section-item.conclusion-section .icon {
            font-size: 1.3rem;
            color: #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.15) 100%);
            animation: iconPulse 2s ease-in-out infinite;
        }

        .section-item.conclusion-section .title {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .section-item.conclusion-section:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25) 0%, rgba(139, 92, 246, 0.2) 100%);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.35);
            transform: translateX(-4px) scale(1.02);
        }

        .section-item.conclusion-section.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border-color: #8b5cf6;
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.5);
        }

        .section-item.conclusion-section.active .icon {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .section-item.conclusion-section.active .title {
            color: white;
        }

        .no-sections {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            overflow-y: auto;
            height: 100vh;
        }

        .page-header {
            margin-bottom: 30px;
            position: relative;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInUp 0.6s ease;
        }

        .last-update {
            font-size: 0.85rem;
            color: var(--text-secondary);
            animation: fadeInUp 0.6s ease 0.1s backwards;
        }

        /* Donate Button - Cute & Friendly */
        .donate-btn {
            margin-top: 15px;
            padding: 12px 28px;
            background: linear-gradient(135deg, #ffb6c1 0%, #ff91a4 50%, #ff8fab 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4), 0 0 20px rgba(255, 145, 164, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease 0.2s backwards, pulse-glow 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .donate-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        .donate-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.6), 0 0 30px rgba(255, 145, 164, 0.5);
        }

        .donate-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4), 0 0 20px rgba(255, 145, 164, 0.3); }
            50% { box-shadow: 0 6px 25px rgba(255, 182, 193, 0.6), 0 0 30px rgba(255, 145, 164, 0.5); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Metrics Grid with Glassmorphism */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease backwards;
        }

        .metric-card:nth-child(1) { animation-delay: 0.1s; }
        .metric-card:nth-child(2) { animation-delay: 0.2s; }
        .metric-card:nth-child(3) { animation-delay: 0.3s; }
        .metric-card:nth-child(4) { animation-delay: 0.4s; }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-blue);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(99, 102, 241, 0.25);
        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .metric-card.positive::before {
            background: var(--gradient-green);
        }

        .metric-card.negative::before {
            background: var(--gradient-red);
        }

        .metric-card .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-card .change {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .metric-card .change.positive {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
            color: #10b981;
        }

        .metric-card .change.negative {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: #ef4444;
        }

        /* Section Cards with Glassmorphism */
        .sections-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--glass-shadow);
            animation: fadeInUp 0.6s ease backwards;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(99, 102, 241, 0.2);
        }

        .section-card.alert {
            border-left: 4px solid var(--warning);
        }

        .section-header {
            padding: 24px 28px;
            background: var(--gradient-glass);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
        }

        .section-header:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .section-header .title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .section-header .arrow {
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
        }

        .section-card.expanded .section-header .arrow {
            transform: rotate(180deg);
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease;
            opacity: 0;
        }

        .section-card.expanded .section-content {
            max-height: 5000px;
            opacity: 1;
        }

        .whatif-card.expanded .section-content {
            max-height: 5000px;
            opacity: 1;
        }

        .section-body {
            padding: 28px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-blue);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .theme-toggle {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
        }

        /* Additional utility styles from V2 */
        .content-paragraph {
            color: var(--text-secondary);
            line-height: 1.7;
            margin: 12px 0;
            font-size: 0.95rem;
        }

        .percentage {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            margin: 0 4px;
        }

        .percentage.bullish {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .percentage.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .metric-number {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--text-primary);
            padding: 0 4px;
        }

        /* Indicator Container */
        .indicator-container {
            margin: 10px 0;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Formatted Lists */
        .formatted-list {
            margin: 20px 0;
        }

        .list-item {
            padding: 12px 0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .list-number {
            background: var(--gradient-blue);
            color: white;
            min-width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .list-content {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.9rem;
        }

        .list-header {
            font-weight: 700;
            color: var(--text-primary);
            background: var(--bg-hover);
            padding: 6px 12px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            display: inline-block;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        /* Section Boxes */
        .conclusion-box, .evidence-box, .conditions-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            margin: 16px 0;
        }

        /* CONCLUSION BOX - Enhanced prominence */
        .conclusion-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-left: 6px solid #8b5cf6;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.2), 0 0 40px rgba(139, 92, 246, 0.1);
            position: relative;
            overflow: hidden;
            animation: conclusionGlow 3s ease-in-out infinite;
        }

        /* Animated gradient overlay */
        .conclusion-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: conclusionShine 4s ease-in-out infinite;
        }

        @keyframes conclusionGlow {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(139, 92, 246, 0.2), 0 0 40px rgba(139, 92, 246, 0.1);
            }
            50% {
                box-shadow: 0 4px 25px rgba(139, 92, 246, 0.3), 0 0 50px rgba(139, 92, 246, 0.15);
            }
        }

        @keyframes conclusionShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .conclusion-box .conclusion-icon {
            font-size: 1.8rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .conclusion-box .conclusion-text {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.6;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* EVIDENCE BOX - Keep moderate styling */
        .evidence-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.06) 100%);
            border-left: 5px solid var(--success);
        }

        .evidence-box .evidence-icon {
            font-size: 1.4rem;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
            flex-shrink: 0;
        }

        .evidence-box .evidence-text {
            font-weight: 600;
            color: var(--success);
        }

        /* CONDITIONS BOX - Warning style */
        .conditions-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.06) 100%);
            border-left: 5px solid var(--warning);
        }

        .conditions-box .conditions-icon {
            font-size: 1.4rem;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
            flex-shrink: 0;
        }

        .conditions-box .conditions-text {
            font-weight: 600;
            color: var(--warning);
        }

        /* Fallback for old class names */
        .conclusion-icon, .evidence-icon, .conditions-icon {
            font-size: 1.4rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-card);
            flex-shrink: 0;
        }

        /* Subsection Boxes */
        .subsection-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 10px;
            background: var(--bg-hover);
            border-left: 4px solid var(--primary);
            margin: 16px 0;
        }

        .subsection-icon {
            font-size: 1.3rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-card);
            flex-shrink: 0;
        }

        .subsection-header {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* MA Indicator */
        .ma-indicator {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            margin: 0 4px;
        }

        .ma-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Momentum */
        .momentum {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            margin: 0 4px;
        }

        .momentum.bullish {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .momentum.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* What-If Card */
        .whatif-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.2);
        }

        .whatif-card:hover {
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.5);
            transform: translateY(-2px);
        }

        .whatif-card-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .whatif-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #92400e;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .whatif-card .arrow {
            font-size: 0.7rem;
            color: #d97706;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
        }

        .whatif-card.expanded .arrow {
            transform: rotate(180deg);
            background: rgba(251, 191, 36, 0.3);
        }

        .whatif-card-body {
            padding: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
        }

        /* Text Highlights */
        .text-success {
            color: var(--success);
            font-weight: 600;
        }

        .text-danger {
            color: var(--danger);
            font-weight: 600;
        }

        .text-warning {
            color: var(--warning);
            font-weight: 600;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
        }

        .badge.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
            color: var(--warning);
        }

        /* Donate Modal Styles - Cute & Friendly */
        .donate-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .donate-modal-content {
            background: var(--bg-card);
            margin: 3% auto;
            padding: 40px 35px;
            border-radius: 30px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 182, 193, 0.2);
            position: relative;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid rgba(255, 182, 193, 0.2);
        }

        .donate-close {
            position: absolute;
            right: 20px;
            top: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.2);
            border: none;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .donate-close:hover {
            background: rgba(255, 105, 135, 0.3);
            color: #ff6987;
            transform: rotate(90deg) scale(1.1);
        }

        .donate-modal h2 {
            margin-bottom: 15px;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #ff91a4 0%, #ffb6c1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .donate-intro {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .donate-intro strong {
            color: #ff91a4;
            font-weight: 600;
        }

        .donate-options {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

        .donate-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 245, 247, 0.9) 100%);
            padding: 30px 25px;
            border-radius: 25px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid rgba(255, 182, 193, 0.3);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.2);
        }

        .donate-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(255, 182, 193, 0.4);
            border-color: rgba(255, 145, 164, 0.5);
        }

        .donate-card h3 {
            color: #ff6987;
            margin-bottom: 18px;
            font-size: 1.3rem;
        }

        .donate-card img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 15px auto;
            border-radius: 15px;
            background: white;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .donate-card:hover img {
            transform: scale(1.05);
        }

        .donate-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 8px 0;
        }

        .donate-note {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 238, 242, 0.6) 0%, rgba(255, 245, 247, 0.6) 100%);
            border-radius: 15px;
            border: 2px dashed rgba(255, 182, 193, 0.4);
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.8;
        }

        .donate-note strong {
            color: #ff6987;
        }

        .donate-hearts {
            text-align: center;
            font-size: 1.5rem;
            margin-top: 10px;
            animation: heartbeat 1.5s ease infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(0.95); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Overview extras (inside `Tá»”NG QUAN THá»Š TRÆ¯á»œNG`) */
        .overview-extras {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .overview-extras .block {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
        }

        .overview-extras .block-header {
            padding: 14px 16px;
            font-weight: 800;
            background: var(--gradient-glass);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .block-expand {
            border: 1px solid var(--glass-border);
            background: rgba(59, 130, 246, 0.10);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 6px 10px;
            font-weight: 800;
            cursor: pointer;
            white-space: nowrap;
        }

        .block-expand:hover {
            background: rgba(59, 130, 246, 0.16);
        }

        .overview-extras .block-body {
            padding: 14px 16px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th,
        .summary-table td {
            padding: 10px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.92rem;
            text-align: left;
        }

        .summary-table th {
            color: var(--text-secondary);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .summary-table td.right,
        .summary-table th.right {
            text-align: right;
            white-space: nowrap;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 800;
            font-size: 0.85rem;
            border: 1px solid var(--glass-border);
        }

        .chip.positive {
            color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        .chip.negative {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }

        .chip.neutral {
            color: var(--text-secondary);
            background: rgba(148, 163, 184, 0.12);
        }

        .heatmap-index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 12px;
        }

        .heatmap-tile {
            border-radius: 14px;
            border: 1px solid var(--glass-border);
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(148, 163, 184, 0.10);
            overflow: hidden;
        }

        .heatmap-tile-btn {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            text-align: left;
            border: 0;
            padding: 0;
            background: transparent;
            color: inherit;
            cursor: pointer;
        }

        .heatmap-tile .symbol {
            font-weight: 900;
            letter-spacing: 0.3px;
        }

        .heatmap-tile .metric {
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 8px;
        }

        .heatmap-cell {
            border-radius: 12px;
            padding: 10px 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            text-align: center;
        }

        .heatmap-cell-btn {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            border: 0;
            background: transparent;
            padding: 0;
            color: inherit;
            cursor: pointer;
        }

        .heatmap-symbol {
            font-weight: 900;
            letter-spacing: 0.3px;
        }

        .heatmap-metric {
            margin-top: 4px;
            color: rgba(15, 23, 42, 0.75);
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

	        /* Summary charts/cards */
	        .idx-cards {
	            display: grid;
	            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
	            gap: 12px;
	        }

	        .idx-card {
	            border: 0;
	            border-radius: 0;
	            padding: 0;
	            background: transparent;
	        }

        .idx-card-btn {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            display: block;
            text-align: left;
            cursor: pointer;
            color: inherit;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 10px 10px;
            background: var(--glass-bg);
            overflow: hidden;
        }

        .idx-card-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.10);
        }

        .idx-card-btn:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
        }

        [data-theme="dark"] .idx-card {
            background: transparent;
        }

        [data-theme="dark"] .idx-card-btn {
            background: rgba(255, 255, 255, 0.02);
        }

	        .idx-top {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 10px;
	        }

        .idx-code {
            font-weight: 900;
            letter-spacing: 0.4px;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .idx-change {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            white-space: nowrap;
        }

        .idx-card-btn {
            min-height: 54px;
        }

        .idx-bars {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mini-bar {
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 10px;
            align-items: center;
        }

        .mini-bar .label {
            color: var(--text-secondary);
            font-size: 0.78rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .bar-track {
            height: 10px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.18);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .bar-track {
            border-color: rgba(255, 255, 255, 0.08);
        }

        .bar-fill {
            height: 100%;
            border-radius: 999px;
        }

        .bar-fill.positive {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.85), rgba(16, 185, 129, 0.45));
        }

        .bar-fill.negative {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.85), rgba(239, 68, 68, 0.45));
        }

        .bar-fill.neutral {
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.85), rgba(148, 163, 184, 0.45));
        }

        /* Popup modal (for cards + heatmaps) */
        .ui-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease;
        }

        .ui-modal-content {
            background: var(--bg-card);
            margin: 3% auto;
            padding: 22px 18px;
            border-radius: 22px;
            width: 92%;
            max-width: 820px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.28);
            position: relative;
            border: 1px solid var(--glass-border);
            animation: slideUp 0.25s ease;
        }

        .ui-modal.positive .ui-modal-content { border-top: 5px solid rgba(16, 185, 129, 0.9); }
        .ui-modal.negative .ui-modal-content { border-top: 5px solid rgba(239, 68, 68, 0.9); }
        .ui-modal.neutral .ui-modal-content { border-top: 5px solid rgba(148, 163, 184, 0.9); }

        .ui-close {
            position: absolute;
            right: 14px;
            top: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.15);
            border: 1px solid var(--glass-border);
            font-size: 20px;
            font-weight: 900;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ui-close:hover {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            transform: rotate(90deg);
        }

        .ui-title {
            font-size: 1.1rem;
            font-weight: 900;
            letter-spacing: 0.3px;
        }

        .ui-subtitle {
            margin-top: 6px;
            color: var(--text-secondary);
            font-size: 0.92rem;
        }

        .ui-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 14px 0 18px;
        }

        .ui-actions button {
            border: 1px solid var(--glass-border);
            background: rgba(59, 130, 246, 0.10);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 10px 12px;
            font-weight: 800;
            cursor: pointer;
        }

        .ui-actions button:hover {
            background: rgba(59, 130, 246, 0.16);
        }

        .ui-metrics {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        @media (max-width: 720px) {
            .ui-metrics { grid-template-columns: 1fr; }
        }

        .ui-metric {
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
        }

        .ui-metric .k {
            color: var(--text-secondary);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: 800;
        }

        .ui-metric .v {
            margin-top: 8px;
            font-weight: 900;
        }

        .ui-large .heatmap-cell { padding: 14px 12px; }
        .ui-large .heatmap-table { border-spacing: 10px; }
        .ui-large .heatmap-symbol { font-size: 0.95rem; }
        .ui-large .heatmap-metric { font-size: 0.9rem; }

        .sparkline-wrap {
            margin-top: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 12px 12px;
            background: rgba(255, 255, 255, 0.04);
        }

        [data-theme="dark"] .sparkline-wrap {
            background: rgba(255, 255, 255, 0.02);
        }

        .sparkline-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .sparkline-title {
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .sparkline-sub {
            color: var(--text-secondary);
            font-weight: 800;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .sparkline-svg {
            width: 100%;
            height: 68px;
            display: block;
        }

        .sparkline-grid {
            stroke: rgba(148, 163, 184, 0.35);
            stroke-width: 1;
        }

        .sparkline-line {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .sparkline-line.positive { stroke: rgba(16, 185, 129, 0.95); }
        .sparkline-line.negative { stroke: rgba(239, 68, 68, 0.95); }
        .sparkline-line.neutral  { stroke: rgba(59, 130, 246, 0.95); }

        .ohlcv-panel {
            margin-top: 14px;
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.04);
            overflow: hidden;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
        }

        [data-theme="dark"] .ohlcv-panel {
            background: rgba(255, 255, 255, 0.02);
        }

        .ohlcv-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--glass-border);
            background: var(--gradient-glass);
        }

        .ohlcv-toolbar .title {
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .ohlcv-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ohlcv-controls label,
        .ohlcv-controls .fixed {
            color: var(--text-secondary);
            font-weight: 900;
            font-size: 0.85rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ohlcv-controls .fixed {
            border: 1px solid var(--glass-border);
            background: rgba(59, 130, 246, 0.08);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 6px 10px;
            font-weight: 900;
        }

        .ohlcv-body {
            padding: 12px 14px 14px;
        }

	        .ohlcv-canvas {
	            width: 100%;
	            display: block;
	            border-radius: 14px;
	            background: rgba(255, 255, 255, 0.02);
	            border: 1px solid rgba(0, 0, 0, 0.06);
	        }

        [data-theme="dark"] .ohlcv-canvas {
            border-color: rgba(255, 255, 255, 0.08);
        }

	        .ohlcv-meta {
	            margin-top: 10px;
	            color: var(--text-secondary);
	            font-size: 0.85rem;
	            font-weight: 800;
	            display: flex;
	            justify-content: space-between;
	            gap: 12px;
	            flex-wrap: wrap;
	        }

	        .ohlcv-chart {
	            width: 100%;
	            height: 240px;
	            border-radius: 14px;
	            background: rgba(255, 255, 255, 0.02);
	            border: 1px solid rgba(0, 0, 0, 0.06);
	            position: relative;
	            overflow: hidden;
	        }

	        [data-theme="dark"] .ohlcv-chart {
	            border-color: rgba(255, 255, 255, 0.08);
	        }

		        .ohlcv-tooltip {
		            position: absolute;
	            top: 10px;
	            left: 10px;
	            padding: 10px 12px;
	            border-radius: 12px;
	            background: rgba(255, 255, 255, 0.92);
	            border: 1px solid rgba(15, 23, 42, 0.10);
	            color: rgba(15, 23, 42, 0.86);
	            font-size: 0.85rem;
	            font-weight: 800;
	            box-shadow: 0 10px 26px rgba(2, 6, 23, 0.12);
	            pointer-events: none;
	            white-space: nowrap;
	        }

		        [data-theme="dark"] .ohlcv-tooltip {
		            background: rgba(2, 6, 23, 0.86);
		            border-color: rgba(226, 232, 240, 0.12);
		            color: rgba(226, 232, 240, 0.92);
		        }

		        .price-panel {
		            margin-top: 14px;
		            border: 1px solid var(--glass-border);
		            border-radius: 16px;
		            background: rgba(255, 255, 255, 0.04);
		            overflow: hidden;
		            max-width: 760px;
		            margin-left: auto;
		            margin-right: auto;
		        }

		        [data-theme="dark"] .price-panel {
		            background: rgba(255, 255, 255, 0.02);
		        }

		        .price-toolbar {
		            display: flex;
		            align-items: center;
		            justify-content: space-between;
		            gap: 12px;
		            padding: 12px 14px;
		            border-bottom: 1px solid var(--glass-border);
		            background: var(--gradient-glass);
		        }

		        .price-toolbar .title {
		            font-weight: 900;
		            letter-spacing: 0.2px;
		        }

		        .price-toolbar .note {
		            font-weight: 900;
		            font-size: 0.82rem;
		            color: var(--text-secondary);
		            white-space: nowrap;
		        }

		        .price-body {
		            padding: 12px 14px 14px;
		        }

		        .price-chart {
		            width: 100%;
		            height: 220px;
		            border-radius: 14px;
		            background: rgba(255, 255, 255, 0.02);
		            border: 1px solid rgba(0, 0, 0, 0.06);
		            position: relative;
		            overflow: hidden;
		        }

		        [data-theme="dark"] .price-chart {
		            border-color: rgba(255, 255, 255, 0.08);
		        }

		        @media (max-width: 900px) {
		            .price-panel { max-width: 100%; }
		            .price-chart { height: 190px; }
		        }

		        .breadth-panel {
		            margin-top: 14px;
		            border: 1px solid var(--glass-border);
		            border-radius: 16px;
		            background: rgba(255, 255, 255, 0.04);
		            overflow: hidden;
		            max-width: 760px;
		            margin-left: auto;
		            margin-right: auto;
		        }

		        [data-theme="dark"] .breadth-panel {
		            background: rgba(255, 255, 255, 0.02);
		        }

		        .breadth-toolbar {
		            display: flex;
		            align-items: center;
		            justify-content: space-between;
		            gap: 12px;
		            padding: 12px 14px;
		            border-bottom: 1px solid var(--glass-border);
		            background: var(--gradient-glass);
		        }

		        .breadth-toolbar .title {
		            font-weight: 900;
		            letter-spacing: 0.2px;
		        }

		        .breadth-grid {
		            padding: 12px 14px 14px;
		            display: grid;
		            grid-template-columns: repeat(2, minmax(0, 1fr));
		            gap: 12px;
		        }

		        @media (max-width: 700px) {
		            .breadth-grid { grid-template-columns: 1fr; }
		        }

		        .breadth-card {
		            border-radius: 14px;
		            border: 1px solid var(--glass-border);
		            background: rgba(255, 255, 255, 0.06);
		            padding: 12px 12px 10px;
		            cursor: pointer;
		            user-select: none;
		            transition: transform 120ms ease, box-shadow 120ms ease;
		        }

		        .breadth-card:hover {
		            transform: translateY(-1px);
		            box-shadow: 0 10px 26px rgba(2, 6, 23, 0.10);
		        }

		        .breadth-card .k {
		            font-weight: 950;
		            font-size: 0.82rem;
		            color: var(--text-secondary);
		            display: flex;
		            align-items: center;
		            gap: 8px;
		        }

		        .breadth-card .v {
		            margin-top: 6px;
		            font-weight: 950;
		            font-size: 1.12rem;
		            color: var(--text-primary);
		            display: flex;
		            align-items: baseline;
		            justify-content: space-between;
		            gap: 10px;
		        }

		        .breadth-card .hint {
		            margin-top: 6px;
		            font-size: 0.78rem;
		            font-weight: 800;
		            color: var(--text-secondary);
		        }

		        .mini-bar {
		            margin-top: 10px;
		            height: 10px;
		            border-radius: 999px;
		            overflow: hidden;
		            border: 1px solid rgba(0, 0, 0, 0.06);
		            background: rgba(148, 163, 184, 0.20);
		            display: flex;
		        }

		        [data-theme="dark"] .mini-bar {
		            border-color: rgba(255, 255, 255, 0.08);
		        }

		        .mini-bar > span { height: 100%; }
		        .mini-bar .pos { background: rgba(16, 185, 129, 0.85); }
		        .mini-bar .neg { background: rgba(239, 68, 68, 0.85); }
		        .mini-bar .neu { background: rgba(148, 163, 184, 0.70); }

		        .mini-gauge {
		            margin-top: 10px;
		            height: 10px;
		            border-radius: 999px;
		            border: 1px solid rgba(0, 0, 0, 0.06);
		            background: linear-gradient(90deg,
		                rgba(16, 185, 129, 0.25) 0%,
		                rgba(16, 185, 129, 0.25) 35%,
		                rgba(148, 163, 184, 0.22) 35%,
		                rgba(148, 163, 184, 0.22) 55%,
		                rgba(239, 68, 68, 0.22) 55%,
		                rgba(239, 68, 68, 0.22) 100%
		            );
		            position: relative;
		        }

		        [data-theme="dark"] .mini-gauge {
		            border-color: rgba(255, 255, 255, 0.08);
		        }

		        .mini-gauge .marker {
		            position: absolute;
		            top: -4px;
		            width: 3px;
		            height: 18px;
		            border-radius: 2px;
		            background: rgba(15, 23, 42, 0.72);
		        }

		        [data-theme="dark"] .mini-gauge .marker {
		            background: rgba(226, 232, 240, 0.78);
		        }

		        .mini-osc {
		            margin-top: 10px;
		            height: 12px;
		            border-radius: 999px;
		            border: 1px solid rgba(0, 0, 0, 0.06);
		            background: rgba(148, 163, 184, 0.20);
		            position: relative;
		            overflow: hidden;
		        }

		        [data-theme="dark"] .mini-osc {
		            border-color: rgba(255, 255, 255, 0.08);
		        }

		        .mini-osc .zero {
		            position: absolute;
		            left: 50%;
		            top: 0;
		            width: 2px;
		            height: 100%;
		            background: rgba(148, 163, 184, 0.65);
		        }

		        .mini-osc .fill {
		            position: absolute;
		            top: 0;
		            height: 100%;
		            background: rgba(148, 163, 184, 0.65);
		        }

		        .keylevels-panel,
		        .targetlevels-panel {
		            margin-top: 14px;
		            border: 1px solid var(--glass-border);
		            border-radius: 16px;
		            background: rgba(255, 255, 255, 0.04);
		            overflow: hidden;
		            max-width: 760px;
		            margin-left: auto;
		            margin-right: auto;
		        }

		        [data-theme="dark"] .keylevels-panel,
		        [data-theme="dark"] .targetlevels-panel {
		            background: rgba(255, 255, 255, 0.02);
		        }

	        .keylevels-toolbar {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 12px;
	            padding: 12px 14px;
	            border-bottom: 1px solid var(--glass-border);
	            background: var(--gradient-glass);
	        }

	        .keylevels-toolbar .title {
	            font-weight: 900;
	            letter-spacing: 0.2px;
	        }

	        .keylevels-body {
	            padding: 12px 14px 14px;
	        }

	        .keylevels-chart {
	            width: 100%;
	            height: 380px;
	            border-radius: 14px;
	            background: rgba(255, 255, 255, 0.02);
	            border: 1px solid rgba(0, 0, 0, 0.06);
	            position: relative;
	            overflow: hidden;
	        }

	        [data-theme="dark"] .keylevels-chart {
	            border-color: rgba(255, 255, 255, 0.08);
	        }

	        .keylevels-tags {
	            margin-top: 10px;
	            display: flex;
	            gap: 8px;
	            flex-wrap: wrap;
	        }

	        .keylevels-tag {
	            padding: 6px 10px;
	            border-radius: 999px;
	            font-weight: 900;
	            font-size: 0.8rem;
	            border: 1px solid var(--glass-border);
	            background: rgba(59, 130, 246, 0.08);
	            color: var(--text-primary);
	        }

	        .keylevels-tag.support {
	            background: rgba(16, 185, 129, 0.10);
	        }

	        .keylevels-tag.resistance {
	            background: rgba(239, 68, 68, 0.10);
	        }

	        .keylevels-controls {
	            display: flex;
	            align-items: center;
	            gap: 10px;
	            flex-wrap: wrap;
	            justify-content: flex-end;
	        }

	        .keylevels-segment {
	            display: inline-flex;
	            border: 1px solid var(--glass-border);
	            border-radius: 999px;
	            overflow: hidden;
	            background: rgba(59, 130, 246, 0.08);
	        }

	        .keylevels-segbtn {
	            appearance: none;
	            border: 0;
	            background: transparent;
	            padding: 6px 10px;
	            font-weight: 950;
	            font-size: 0.82rem;
	            color: var(--text-secondary);
	            cursor: pointer;
	            white-space: nowrap;
	        }

	        .keylevels-segbtn.active {
	            background: rgba(59, 130, 246, 0.16);
	            color: var(--text-primary);
	        }

	        .keylevels-checks {
	            display: flex;
	            gap: 8px;
	            flex-wrap: wrap;
	            align-items: center;
	        }

	        .keylevels-check {
	            display: inline-flex;
	            align-items: center;
	            gap: 6px;
	            padding: 6px 10px;
	            border-radius: 999px;
	            border: 1px solid var(--glass-border);
	            background: rgba(255, 255, 255, 0.06);
	            color: var(--text-primary);
	            font-weight: 900;
	            font-size: 0.82rem;
	            cursor: pointer;
	            user-select: none;
	        }

	        .keylevels-check input {
	            width: 14px;
	            height: 14px;
	        }

		        @media (max-width: 900px) {
		            .keylevels-panel, .targetlevels-panel { max-width: 100%; }
		            .keylevels-chart { height: 300px; }
		        }
    </style>
</head>
<body data-theme="light">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        ðŸŒ™
    </button>

    <div class="dashboard">
        <!-- Sidebar 1: Index List (Left) -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ðŸ“Š Index</h2>
                <div class="date">25/12/2025</div>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" placeholder="ðŸ” TÃ¬m chá»‰ sá»‘..." id="searchInput">
            </div>

            <div class="index-list" id="indexList">
                <!-- Indices sáº½ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y -->
            </div>
        </div>

        <!-- Main Content: Single Section Display (Center) -->
        <div class="main-content">
            <div class="page-header">
                <h1 id="pageTitle">Chá»n chá»‰ sá»‘ vÃ  má»¥c Ä‘á»ƒ xem</h1>
                <div class="last-update" id="lastUpdate">Cáº­p nháº­t: 25/12/2025 17:56</div>
                <button class="donate-btn" onclick="showDonateModal()">
                    ðŸ’ Má»i báº¡n cafe / á»¦ng há»™
                </button>
            </div>

            <!-- Single Section Content -->
            <div id="singleSectionContent" style="display: none;">
                <!-- Section content sáº½ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" style="display: block; text-align: center; padding: 100px 20px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ‘ˆ ðŸ‘‰</div>
                <h2 style="color: var(--text-secondary); margin-bottom: 10px;">ChÆ°a chá»n má»¥c phÃ¢n tÃ­ch</h2>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    1. Chá»n chá»‰ sá»‘ á»Ÿ cá»™t <strong>bÃªn trÃ¡i</strong><br>
                    2. Chá»n má»¥c phÃ¢n tÃ­ch á»Ÿ cá»™t <strong>bÃªn pháº£i</strong>
                </p>
            </div>
        </div>

        <!-- Sidebar 2: Section Navigation (Right) -->
        <div class="section-nav">
            <div class="section-nav-header">
                <h3 id="sectionNavTitle">Chá»n má»¥c</h3>
                <div class="subtitle">SECTIONS</div>
            </div>

            <div class="section-list" id="sectionList">
                <div class="no-sections">
                    Chá»n má»™t chá»‰ sá»‘ bÃªn trÃ¡i Ä‘á»ƒ xem cÃ¡c má»¥c phÃ¢n tÃ­ch
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle Logic
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        let currentTheme = localStorage.getItem('theme') || 'light';

        // Apply saved theme
        body.setAttribute('data-theme', currentTheme);
        updateThemeIcon(currentTheme);

		        themeToggle.addEventListener('click', () => {
		            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
		            body.setAttribute('data-theme', currentTheme);
		            localStorage.setItem('theme', currentTheme);
		            updateThemeIcon(currentTheme);
		            // Re-init trend charts to match theme
		            document.querySelectorAll('.price-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                const mode = panel.getAttribute('data-mode') || 'line';
		                if (panel.id && idxKey) {
		                    try { initIndexPricePanel(panel.id, idxKey, mode); } catch (_) {}
		                }
		            });
		            document.querySelectorAll('.ohlcv-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                if (panel.id && idxKey) {
		                    try { initIndexOhlcvPanel(panel.id, idxKey); } catch (_) {}
		                }
		            });
		            document.querySelectorAll('.keylevels-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                if (panel.id && idxKey) {
		                    const stored = (window.__uiGlmKeyLevelsStore || {})[panel.id];
		                    try { initKeyLevelsPanel(panel.id, idxKey, stored ? stored.sectionHtml : ''); } catch (_) {}
		                }
		            });
		            document.querySelectorAll('.targetlevels-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                if (panel.id && idxKey) {
		                    const stored = (window.__uiGlmTargetLevelsStore || {})[panel.id];
		                    try { initTargetLevelsPanel(panel.id, idxKey, stored ? stored.sectionHtml : ''); } catch (_) {}
		                }
		            });
			        });

        function updateThemeIcon(theme) {
            themeToggle.textContent = theme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
        }

        // Data tá»« full_data.js
        const data = FULL_DATA;

        // Render sidebar
        function renderSidebar() {
            const indices = [
                { key: 'overview', name: 'Tá»”NG Há»¢P' },
                { key: 'vnindex', name: 'VNINDEX' },
                { key: 'vn30', name: 'VN30' },
                { key: 'vn100', name: 'VN100' },
                { key: 'vnmidcap', name: 'VNMIDCAP' },
                { key: 'vnreal', name: 'VNREAL' },
                { key: 'vnit', name: 'VNIT' },
                { key: 'vnheal', name: 'VNHEAL' },
                { key: 'vnfin', name: 'VNFIN' },
                { key: 'vnene', name: 'VNENE' },
                { key: 'vncons', name: 'VNCONS' },
                { key: 'vnmat', name: 'VNMAT' },
                { key: 'vncond', name: 'VNCOND' },
                { key: 'vnsml', name: 'VNSML' },
                { key: 'vnfinselect', name: 'VNFINSELECT' },
                { key: 'vndiamond', name: 'VNDIAMOND' }
            ];

            const container = document.getElementById('indexList');
            container.innerHTML = indices.map(idx => `
                <div class="index-item ${idx.key === 'vnindex' ? 'active' : ''}"
                     onclick="selectIndex('${idx.key}')"
                     data-index="${idx.key}">
                    <span class="name">${idx.name}</span>
                </div>
            `).join('');
        }

        // State
        let currentIndex = null;
        let currentSectionIndex = null;

        function _getToneFromChange(changePct) {
            if (changePct == null || !Number.isFinite(changePct)) return 'neutral';
            if (changePct > 0) return 'positive';
            if (changePct < 0) return 'negative';
            return 'neutral';
        }

        function _updateBodyOverflow() {
            const donateModal = document.getElementById('donateModal');
            const uiModal = document.getElementById('uiModal');
            const donateOpen = donateModal && donateModal.style.display === 'block';
            const uiOpen = uiModal && uiModal.style.display === 'block';
            document.body.style.overflow = (donateOpen || uiOpen) ? 'hidden' : 'auto';
        }

        function openUiModal({ tone = 'neutral', title = '', subtitle = '', bodyHtml = '', large = false } = {}) {
            const modal = document.getElementById('uiModal');
            const body = document.getElementById('uiModalBody');
            const titleEl = document.getElementById('uiModalTitle');
            const subtitleEl = document.getElementById('uiModalSubtitle');

            if (!modal || !body || !titleEl || !subtitleEl) return;

            modal.classList.remove('positive', 'negative', 'neutral');
            modal.classList.add(tone === 'positive' ? 'positive' : (tone === 'negative' ? 'negative' : 'neutral'));

            titleEl.textContent = title || '';
            subtitleEl.textContent = subtitle || '';
            body.innerHTML = `<div class="${large ? 'ui-large' : ''}">${bodyHtml || ''}</div>`;

            modal.style.display = 'block';
            _updateBodyOverflow();
        }

        function closeUiModal() {
            const modal = document.getElementById('uiModal');
            if (!modal) return;
            modal.style.display = 'none';
            const body = document.getElementById('uiModalBody');
            if (body) body.innerHTML = '';
            _updateBodyOverflow();
        }

        function openIndexPopup(indexKey) {
            const idx = data[indexKey];
            const metrics = parseIndexMetrics(indexKey) || {};
            const tone = _getToneFromChange(metrics.changePct);

            const price = metrics.priceText || 'N/A';
            const change = metrics.changeText || 'N/A';
            const volText = metrics.volumeText || (metrics.volumeValue != null ? formatCompactNumber(metrics.volumeValue) : 'N/A');

            // Normalize bars within the summary set for nicer visuals.
            const rows = getSummaryIndexRows();
            const usableChange = rows.filter(r => r.changePct != null);
            const usableVol = rows.filter(r => r.volumeValue != null);
            const maxAbsChange = usableChange.length ? Math.max(...usableChange.map(r => Math.abs(r.changePct))) : 1;
            const maxVolume = usableVol.length ? Math.max(...usableVol.map(r => r.volumeValue)) : 1;

            const changeW = metrics.changePct == null ? 0 : Math.max(8, Math.round(100 * Math.min(Math.abs(metrics.changePct) / maxAbsChange, 1)));
            const volW = metrics.volumeValue == null ? 0 : Math.max(8, Math.round(100 * Math.min(metrics.volumeValue / maxVolume, 1)));

            const cls = tone;
            const subtitle = idx && idx.title ? idx.title : '';

            const bodyHtml = `
                <div class="ui-actions">
                    <button type="button" onclick="selectIndex('${indexKey}'); closeUiModal();">Má»Ÿ phÃ¢n tÃ­ch</button>
                    <button type="button" onclick="closeUiModal()">ÄÃ³ng</button>
                </div>
                <div class="ui-metrics">
                    <div class="ui-metric"><div class="k">GiÃ¡</div><div class="v">${price}</div></div>
                    <div class="ui-metric"><div class="k">Thay Ä‘á»•i</div><div class="v"><span class="chip ${cls}">${change}</span></div></div>
                    <div class="ui-metric"><div class="k">Khá»‘i lÆ°á»£ng</div><div class="v">${volText}</div></div>
                </div>
                <div class="idx-bars" style="margin-top: 0;">
                    <div class="mini-bar">
                        <div class="label">Change</div>
                        <div class="bar-track"><div class="bar-fill ${cls}" style="width:${changeW}%"></div></div>
                    </div>
                    <div class="mini-bar">
                        <div class="label">Volume</div>
                        <div class="bar-track"><div class="bar-fill neutral" style="width:${volW}%"></div></div>
                    </div>
                </div>
            `;

            const title = (indexKey || '').toUpperCase();
            openUiModal({ tone, title, subtitle, bodyHtml, large: false });
        }

	        function openVnindexStockPopupFromEl(el) {
	            if (!el || !el.dataset) return;

	            const symbol = el.dataset.symbol || 'N/A';
	            const price = el.dataset.price || 'N/A';
	            const value = el.dataset.value || 'N/A';
	            const volume = el.dataset.volume || 'N/A';

	            const changePct = Number(el.dataset.changePct);
	            const tone = _getToneFromChange(Number.isFinite(changePct) ? changePct : null);
	            const cls = tone;
	            const changeStr = Number.isFinite(changePct) ? ((changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%') : 'N/A';

	            const metaAll = (typeof window !== 'undefined' && window.UI_GLM_COMPANY_META) ? window.UI_GLM_COMPANY_META : null;
	            const meta = metaAll && symbol && metaAll[symbol] ? metaAll[symbol] : null;
	            const companyName = meta && meta.name ? String(meta.name) : 'N/A';
	            const sectorRaw = meta && meta.sector ? String(meta.sector) : 'N/A';
	            const sectorParts = sectorRaw && sectorRaw.includes('/') ? sectorRaw.split('/') : null;
	            const sectorVi = sectorParts && sectorParts[1] ? sectorParts[1] : sectorRaw;
	            const sectorEn = sectorParts && sectorParts[0] ? sectorParts[0] : '';

	            function _sparklinePath(values, width, height, pad) {
	                const pts = (values || []).map(v => Number(v)).filter(v => Number.isFinite(v));
	                if (pts.length < 2) return '';
	                const min = Math.min(...pts);
	                const max = Math.max(...pts);
	                const span = (max - min) || 1;
	                const n = pts.length;
	                const w = Math.max(10, width - pad * 2);
	                const h = Math.max(10, height - pad * 2);
	                return pts.map((v, i) => {
	                    const x = pad + (n === 1 ? 0 : (i * w / (n - 1)));
	                    const y = pad + (h - ((v - min) / span) * h);
	                    return `${x.toFixed(1)},${y.toFixed(1)}`;
	                }).join(' ');
	            }

	            function _renderSparkline(values, tone) {
	                const pts = (values || []).map(v => Number(v)).filter(v => Number.isFinite(v));
	                if (pts.length < 2) return '';
	                const w = 420;
	                const h = 68;
	                const pad = 6;
	                const poly = _sparklinePath(pts, w, h, pad);
	                if (!poly) return '';
	                const last = pts[pts.length - 1];
	                const first = pts[0];
	                const dPct = first ? ((last - first) / first) * 100 : null;
	                const deltaStr = dPct == null || !Number.isFinite(dPct) ? '' : `(${dPct >= 0 ? '+' : ''}${dPct.toFixed(2)}%)`;
	                return `
	                    <div class="sparkline-wrap">
	                        <div class="sparkline-header">
	                            <div class="sparkline-title">GiÃ¡ 20 phiÃªn</div>
	                            <div class="sparkline-sub">Close: ${escapeHtml(last.toFixed(2))} ${escapeHtml(deltaStr)}</div>
	                        </div>
	                        <svg class="sparkline-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="Sparkline 20 phiÃªn">
	                            <path class="sparkline-grid" d="M0 ${h - 1} H${w}" />
	                            <polyline class="sparkline-line ${tone}" points="${poly}"></polyline>
	                        </svg>
	                    </div>
	                `;
	            }

	            const p20 = (typeof window !== 'undefined' && window.UI_GLM_PRICE_20D && window.UI_GLM_PRICE_20D.series) ? window.UI_GLM_PRICE_20D.series : null;
	            const p20Series = p20 && symbol && p20[symbol] && Array.isArray(p20[symbol].c) ? p20[symbol].c : null;
	            const sparklineHtml = p20Series ? _renderSparkline(p20Series, tone) : '';

	            const bodyHtml = `
	                <div class="ui-actions">
	                    <button type="button" onclick="closeUiModal()">ÄÃ³ng</button>
	                </div>
	                <div class="ui-metrics">
	                    <div class="ui-metric"><div class="k">GiÃ¡</div><div class="v">${escapeHtml(price)}</div></div>
	                    <div class="ui-metric"><div class="k">Thay Ä‘á»•i</div><div class="v"><span class="chip ${cls}">${escapeHtml(changeStr)}</span></div></div>
	                    <div class="ui-metric"><div class="k">GiÃ¡ trá»‹ GD</div><div class="v">${escapeHtml(value)}</div></div>
	                </div>
	                <div class="ui-metrics">
	                    <div class="ui-metric"><div class="k">Doanh nghiá»‡p</div><div class="v">${escapeHtml(companyName)}</div></div>
	                    <div class="ui-metric"><div class="k">NgÃ nh</div><div class="v">${escapeHtml(sectorVi)}${sectorEn ? `<span style="color: var(--text-secondary); font-weight: 800;"> (${escapeHtml(sectorEn)})</span>` : ''}</div></div>
	                    <div class="ui-metric"><div class="k">MÃ£</div><div class="v">${escapeHtml(symbol)}</div></div>
	                </div>
	                <div class="ui-metrics">
	                    <div class="ui-metric"><div class="k">Khá»‘i lÆ°á»£ng</div><div class="v">${escapeHtml(volume)}</div></div>
	                    <div class="ui-metric"><div class="k">Nguá»“n</div><div class="v">HOSE monthly DB</div></div>
	                </div>
	                ${sparklineHtml}
	            `;

	            openUiModal({ tone, title: symbol, subtitle: 'Stock heatmap', bodyHtml, large: false });
	        }

        function openBlockPopup(btnEl) {
            if (!btnEl) return;
            const block = btnEl.closest('.block');
            if (!block) return;
            const title = block.getAttribute('data-popup-title') || 'Chi tiáº¿t';
            const body = block.querySelector('.block-body');
            const bodyHtml = body ? body.innerHTML : '';
            openUiModal({ tone: 'neutral', title, subtitle: '', bodyHtml, large: true });
        }

        // Process sections to extract what-if content
	        function processSections(indexData) {
	            const processedSections = [];
	            const whatIfSections = [];

            indexData.sections.forEach((section) => {
                const titleLower = section.title.toLowerCase();
                const contentLower = section.content.toLowerCase();

                const isWhatIfTitle =
                    titleLower.includes('what-if') ||
                    titleLower.includes('ká»‹ch báº£n') ||
                    (titleLower.includes('Ä‘iá»u kiá»‡n') && titleLower.includes('sai'));

                if (isWhatIfTitle) {
                    whatIfSections.push(section);
                } else if (contentLower.includes('ká»‹ch báº£n') && contentLower.includes('what-if')) {
                    const splitPattern = /ká»‹ch\s+báº£n[\s\S]{0,50}?what-if/i;
                    const splitMatch = section.content.match(splitPattern);

                    if (splitMatch && splitMatch.index !== undefined) {
                        const splitIndex = splitMatch.index;
                        const mainContent = section.content.substring(0, splitIndex).trim();
                        const whatIfContent = section.content.substring(splitIndex).trim();

                        processedSections.push({
                            ...section,
                            content: mainContent
                        });

                        whatIfSections.push({
                            title: 'Ká»‹ch Báº£n What-if',
                            content: whatIfContent,
                            alert: false
                        });
                    } else {
                        const keywordIndex = contentLower.indexOf('ká»‹ch báº£n');
                        if (keywordIndex !== -1) {
                            const whatIfIndex = contentLower.indexOf('what-if', keywordIndex);
                            if (whatIfIndex !== -1) {
                                const originalContent = section.content;
                                const actualKeywordIndex = originalContent.toLowerCase().indexOf('ká»‹ch báº£n');
                                const actualWhatIfIndex = originalContent.toLowerCase().indexOf('what-if', actualKeywordIndex);

                                const mainContent = originalContent.substring(0, actualWhatIfIndex).trim();
                                const whatIfContent = originalContent.substring(actualWhatIfIndex).trim();

                                processedSections.push({
                                    ...section,
                                    content: mainContent
                                });

                                whatIfSections.push({
                                    title: 'Ká»‹ch Báº£n What-if',
                                    content: whatIfContent,
                                    alert: false
                                });
                            } else {
                                processedSections.push(section);
                            }
                        } else {
                            processedSections.push(section);
                        }
                    }
                } else {
                    processedSections.push(section);
                }
            });

	            return [...processedSections, ...whatIfSections];
	        }

	        function indexKeyToHeatmapIndexName(indexKey) {
	            const map = {
	                vn30: 'VN30',
	                vn100: 'VN100',
	                vnmidcap: 'VNMID',
	                vnsml: 'VNSML',
	                vnfinselect: 'VNFINSELECT',
	                vndiamond: 'VNDIAMOND',
	                vnreal: 'VNREAL',
	                vnit: 'VNIT',
	                vnheal: 'VNHEAL',
	                vnfin: 'VNFIN',
	                vnene: 'VNENE',
	                vncons: 'VNCONS',
	                vnmat: 'VNMAT',
	                vncond: 'VNCOND',
	            };
	            return map[indexKey] || null;
	        }

	        function getIndexHeatmapPayload(indexKey) {
	            const idxName = indexKeyToHeatmapIndexName(indexKey);
	            const payload = (typeof window !== 'undefined' && window.UI_GLM_INDEX_HEATMAPS) ? window.UI_GLM_INDEX_HEATMAPS : null;
	            const indices = payload && payload.indices ? payload.indices : null;
	            const asof = payload && payload.asof ? payload.asof : '';
	            const idxData = idxName && indices && indices[idxName] ? indices[idxName] : null;
	            if (!idxName || !idxData) return null;
	            return {
	                indexName: idxName,
	                asof,
	                gainers: Array.isArray(idxData.gainers) ? idxData.gainers : [],
	                losers: Array.isArray(idxData.losers) ? idxData.losers : [],
	                countPos: idxData.count_pos,
	                countNeg: idxData.count_neg,
	            };
	        }

	        function getSectionsForIndex(indexKey) {
	            const indexData = data[indexKey];
	            const base = processSections(indexData);
	            if (!indexKey || indexKey === 'overview' || indexKey === 'vnindex') return base;

	            const payload = getIndexHeatmapPayload(indexKey);
	            if (!payload) return base;

	            return base.concat([
	                {
	                    title: 'ðŸ”¥ Heatmap cá»• phiáº¿u TÄ‚NG GIÃ',
	                    icon: 'ðŸ”¥',
	                    content: '',
	                    alert: false,
	                    __uiType: 'heatmap_gainers',
	                },
	                {
	                    title: 'ðŸ”¥ Heatmap cá»• phiáº¿u GIáº¢M GIÃ',
	                    icon: 'ðŸ”¥',
	                    content: '',
	                    alert: false,
	                    __uiType: 'heatmap_losers',
	                }
	            ]);
	        }

        // ---------------------------
        // Overview extras: summary table + heatmaps (inside `Tá»”NG QUAN THá»Š TRÆ¯á»œNG`)
        // ---------------------------

        function normalizeTitle(title) {
            return (title || '').replace(/`/g, '').trim().toUpperCase();
        }

	        function htmlToPlainText(html) {
	            const div = document.createElement('div');
	            div.innerHTML = html || '';
	            return (div.textContent || div.innerText || '').replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
	        }

	        function escapeHtml(text) {
	            return String(text == null ? '' : text)
	                .replace(/&/g, '&amp;')
	                .replace(/</g, '&lt;')
	                .replace(/>/g, '&gt;')
	                .replace(/\"/g, '&quot;')
	                .replace(/'/g, '&#39;');
	        }

	        function parseCompactNumberToFloat(text) {
	            if (!text) return null;
	            const raw = String(text).trim();
	            const m = raw.match(/^([0-9]+(?:[.,][0-9]+)?)\s*([KMB]|triá»‡u|tá»·)?$/i);
            if (!m) {
                // Fallback: strip commas
                const n = Number(raw.replace(/,/g, ''));
                return Number.isFinite(n) ? n : null;
            }
            const val = Number(String(m[1]).replace(/,/g, '.'));
            if (!Number.isFinite(val)) return null;
            const unit = (m[2] || '').toLowerCase();
            if (unit === 'k') return val * 1_000;
            if (unit === 'm' || unit === 'triá»‡u') return val * 1_000_000;
            if (unit === 'b' || unit === 'tá»·') return val * 1_000_000_000;
            return val;
        }

        function formatCompactNumber(num) {
            if (num == null || !Number.isFinite(num)) return 'N/A';
            const abs = Math.abs(num);
            if (abs >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1) + 'B';
            if (abs >= 1_000_000) return (num / 1_000_000).toFixed(1) + 'M';
            if (abs >= 1_000) return (num / 1_000).toFixed(1) + 'K';
            return String(Math.round(num));
        }

        function parseIndexMetrics(indexKey) {
            const idx = data[indexKey];
            if (!idx || !Array.isArray(idx.sections)) return null;
            const text = idx.sections.map(s => htmlToPlainText(s.content)).join('\n');

            const priceMatch = text.match(/GiÃ¡\s*hiá»‡n\s*táº¡i\s*(?:\(|:)?\s*([0-9][0-9.,]*)/i);
            const priceText = priceMatch ? String(priceMatch[1]).replace(/[,\.\)\]\s]+$/g, '').trim() : null;

            let changePct = null;
            let changeText = null;
            const changeMatch =
                text.match(/GiÃ¡\s*hiá»‡n\s*táº¡i[\s\S]{0,180}?(tÄƒng|giáº£m)\s*([+-]?\d+(?:\.\d+)?)\s*%/i) ||
                text.match(/\b(tÄƒng|giáº£m)\s*([+-]?\d+(?:\.\d+)?)\s*%/i);

            if (changeMatch) {
                const dir = (changeMatch[1] || '').toLowerCase();
                const raw = Number(changeMatch[2]);
                if (Number.isFinite(raw)) {
                    changePct = dir === 'giáº£m' ? -Math.abs(raw) : Math.abs(raw);
                    changeText = (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%';
                }
            }

            const volMatch =
                text.match(/Khá»‘i\s+lÆ°á»£ng(?:\s+phiÃªn)?\s+hiá»‡n\s+táº¡i\s*(?:\(|:)?\s*([0-9][0-9,\.]*\s*(?:[KMB]|triá»‡u|tá»·)?)?/i) ||
                text.match(/thanh\s*khoáº£n[^\n]{0,60}?\s+([0-9][0-9,\.]*\s*(?:triá»‡u|tá»·|[KMB])?)/i);

            const volumeText = volMatch ? String(volMatch[1] || '').trim() : null;
            const volumeValue = volumeText ? parseCompactNumberToFloat(volumeText.replace(/cá»•\s*phiáº¿u/i, '').trim()) : null;

            return { priceText, changePct, changeText, volumeText, volumeValue };
        }

	        function getSummaryIndexRows() {
	            const keys = [
	                ['vnindex', 'VNINDEX'],
	                ['vn30', 'VN30'],
                ['vn100', 'VN100'],
                ['vnmidcap', 'VNMIDCAP'],
                ['vnsml', 'VNSML'],
                ['vnfinselect', 'VNFINSELECT'],
                ['vndiamond', 'VNDIAMOND'],
                ['vnreal', 'VNREAL'],
                ['vnit', 'VNIT'],
                ['vnheal', 'VNHEAL'],
                ['vnfin', 'VNFIN'],
                ['vnene', 'VNENE'],
                ['vncons', 'VNCONS'],
                ['vnmat', 'VNMAT'],
                ['vncond', 'VNCOND'],
            ];

	            return keys.map(([key, label]) => ({ key, label, ...(parseIndexMetrics(key) || {}) }));
	        }

	        function renderSummaryCards(rows) {
	            const cards = rows.map(r => {
	                const cls =
	                    r.changePct == null ? 'neutral' :
	                    (r.changePct > 0 ? 'positive' : (r.changePct < 0 ? 'negative' : 'neutral'));

	                const change = r.changeText || 'â€”';

	                return `
	                    <button type="button" class="idx-card idx-card-btn" onclick="openIndexPopup('${r.key}')">
	                        <div class="idx-top">
	                            <div class="idx-code">${r.label}</div>
	                            <div class="idx-change"><span class="chip ${cls}">${change}</span></div>
	                        </div>
	                    </button>
	                `;
	            }).join('');

	            return `<div class="idx-cards">${cards}</div>`;
	        }

        function tileBackgroundForChangeVolume(changePct, volumeValue, maxAbsChange, maxVolume) {
            if (changePct == null || volumeValue == null) {
                return 'rgba(148, 163, 184, 0.10)';
            }
            const normChange = maxAbsChange ? Math.min(Math.abs(changePct) / maxAbsChange, 1) : 0;
            const normVol = maxVolume ? Math.min(volumeValue / maxVolume, 1) : 0;
            const intensity = 0.4 * normChange + 0.6 * normVol;
            const isUp = changePct >= 0;
            const base = isUp ? [16, 185, 129] : [239, 68, 68];
            // blend toward white based on intensity
            const mix = (c) => Math.round(255 - (255 - c) * (0.25 + 0.55 * intensity));
            const [r, g, b] = [mix(base[0]), mix(base[1]), mix(base[2])];
            return `rgb(${r}, ${g}, ${b})`;
        }

	        function renderIndexHeatmap(rows) {
	            const usable = rows.filter(r => r.changePct != null && r.volumeValue != null);
	            const maxAbsChange = usable.length ? Math.max(...usable.map(r => Math.abs(r.changePct))) : 1;
	            const maxVolume = usable.length ? Math.max(...usable.map(r => r.volumeValue)) : 1;

	            const tiles = rows.map(r => {
	                const bg = tileBackgroundForChangeVolume(r.changePct, r.volumeValue, maxAbsChange, maxVolume);
	                const change = r.changeText || 'N/A';
	                const vol = r.volumeText || 'N/A';
	                const title = `${r.label} | ${change} | Vol ${vol}`;
	                return `
	                    <button type="button" class="heatmap-tile heatmap-tile-btn" style="background:${bg}" title="${escapeHtml(title)}" onclick="openIndexPopup('${r.key}')">
	                        <div class="symbol">${r.label}</div>
	                        <div class="metric">${change}</div>
	                    </button>
	                `;
	            }).join('');

            return `<div class="heatmap-index-grid">${tiles}</div>`;
        }

	        function renderStockHeatmapTable(points, title) {
	            if (!points || !points.length) {
	                return `
	                    <div class="block">
	                        <div class="block-header">${escapeHtml(title)}</div>
	                        <div class="block-body"><div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u.</p></div></div>
	                    </div>
	                `;
	            }

	            const changeSeries = points
	                .map(p => Number(p && p.change_pct))
	                .filter(v => Number.isFinite(v));
	            const maxAbsChange = (changeSeries.length ? Math.max(...changeSeries.map(v => Math.abs(v))) : 0) || 1;
	            const cols = 6;
	            const rows = Math.ceil(points.length / cols);

            let html = '';
            let idx = 0;
            for (let r = 0; r < rows; r++) {
                let rowHtml = '';
                for (let c = 0; c < cols; c++) {
                    if (idx >= points.length) {
                        rowHtml += '<td></td>';
                        continue;
                    }
	                    const p = points[idx++];
	                    const symbol = (p && p.symbol != null ? String(p.symbol) : '').trim();
	                    const changePct = Number(p && p.change_pct);
	                    const changeOk = Number.isFinite(changePct);
	                    const isUp = changeOk ? changePct >= 0 : true;
	                    const bg = isUp ? '#d4efdf' : '#f9d6d5';
	                    const changeFactor = changeOk ? Math.min(Math.abs(changePct) / maxAbsChange, 1) : 0;
	                    const sizePercent = 60 + Math.round(40 * changeFactor);
	                    const changeStr = changeOk ? ((changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%') : 'N/A';
	                    const priceStr = (p && p.price != null && Number.isFinite(Number(p.price))) ? Number(p.price).toFixed(2) : 'N/A';
	                    const valueStr = p && p.value != null && Number.isFinite(Number(p.value)) ? formatCompactNumber(Number(p.value)) : 'N/A';
	                    const volumeStr = p && p.volume != null && Number.isFinite(Number(p.volume)) ? formatCompactNumber(Number(p.volume)) : 'N/A';
	                    const metaAll = (typeof window !== 'undefined' && window.UI_GLM_COMPANY_META) ? window.UI_GLM_COMPANY_META : null;
	                    const meta = metaAll && symbol && metaAll[symbol] ? metaAll[symbol] : null;
	                    const sectorRaw = meta && meta.sector ? String(meta.sector) : '';
	                    const sectorParts = sectorRaw && sectorRaw.includes('/') ? sectorRaw.split('/') : null;
	                    const sectorVi = sectorParts && sectorParts[1] ? sectorParts[1] : sectorRaw;
	                    const tooltip = `${symbol || 'N/A'} | ${changeStr}${sectorVi ? ' | ' + sectorVi : ''}`;

	                    rowHtml += `
	                        <td class="heatmap-cell" style="background-color:${bg}" title="${escapeHtml(tooltip)}">
	                            <button type="button" class="heatmap-cell-btn"
	                                    data-symbol="${escapeHtml(symbol || 'N/A')}"
	                                    data-change-pct="${changeOk ? String(changePct) : ''}"
	                                    data-price="${escapeHtml(priceStr)}"
	                                    data-value="${escapeHtml(valueStr)}"
	                                    data-volume="${escapeHtml(volumeStr)}"
	                                    onclick="openVnindexStockPopupFromEl(this)">
	                                <div class="heatmap-symbol" style="width:${sizePercent}%">${escapeHtml(symbol || 'N/A')}</div>
	                                <div class="heatmap-metric" style="width:${sizePercent}%">${changeStr}</div>
	                            </button>
	                        </td>
	                    `;
                }
                html += `<tr>${rowHtml}</tr>`;
            }

	            return `
	                <div class="block" data-popup-title="${escapeHtml(title)}">
	                    <div class="block-header">
	                        <span>${escapeHtml(title)}</span>
	                        <button type="button" class="block-expand" onclick="openBlockPopup(this)">Xem lá»›n</button>
	                    </div>
	                    <div class="block-body">
	                        <table class="heatmap-table" role="presentation" cellpadding="0" cellspacing="0">
	                            ${html}
	                        </table>
	                    </div>
	                </div>
	            `;
	        }

	        function renderIndexHeatmapSection(indexKey, kind) {
	            const payload = getIndexHeatmapPayload(indexKey);
	            if (!payload) {
	                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u heatmap cho index nÃ y.</p></div>`;
	            }

	            const dateText = payload.asof ? ` (date: ${payload.asof})` : '';
	            const points = kind === 'gainers' ? payload.gainers : payload.losers;
	            const title =
	                kind === 'gainers'
	                    ? `ðŸ”¥ Heatmap cá»• phiáº¿u TÄ‚NG GIÃ${dateText}`
	                    : `ðŸ”¥ Heatmap cá»• phiáº¿u GIáº¢M GIÃ${dateText}`;

	            return `<div class="overview-extras" style="margin-top: 0;">${renderStockHeatmapTable(points, title)}</div>`;
	        }

		        function getIndexOhlcvPayload(indexKey) {
		            const payload = (typeof window !== 'undefined' && window.UI_GLM_INDEX_OHLCV) ? window.UI_GLM_INDEX_OHLCV : null;
		            const indices = payload && payload.indices ? payload.indices : null;
		            const idx = indices && indexKey ? indices[indexKey] : null;
		            if (!idx || !Array.isArray(idx.bars) || !idx.bars.length) return null;
		            return {
		                asof: payload.asof || '',
		                name: idx.name || '',
		                method: idx.method || '',
		                constituents: idx.constituents || null,
		                bars: idx.bars,
		            };
		        }

			        function extractKeyPriceZonesFromHtml(html) {
			            const el = document.createElement('div');
			            el.innerHTML = html || '';
			            const text = (el.textContent || '').replace(/\s+/g, ' ').trim();
			            if (!text) return [];

			            const parseNumber = (raw) => {
			                if (!raw) return null;
			                let s = String(raw).trim();
			                s = s.replace(/\s/g, '');
			                s = s.replace(/[()]/g, '');
			                s = s.replace(/[^0-9,.\-â€“~]/g, '');
			                if (!s) return null;

			                const hasComma = s.includes(',');
			                const hasDot = s.includes('.');
			                if (hasComma && hasDot) {
			                    s = s.replace(/,/g, '');
			                } else if (hasComma && !hasDot) {
			                    const parts = s.split(',');
			                    const last = parts[parts.length - 1] || '';
			                    if (last.length !== 3) s = s.replace(/,/g, '.');
			                    else s = s.replace(/,/g, '');
			                } else if (!hasComma && hasDot) {
			                    const parts = s.split('.');
			                    const last = parts[parts.length - 1] || '';
			                    if (last.length === 3 && parts.length > 1) s = s.replace(/\./g, '');
			                }
			                const v = Number(s);
			                return Number.isFinite(v) ? v : null;
			            };

			            const parseRange = (raw) => {
			                if (!raw) return null;
			                const s = String(raw).replace(/[â€“~]/g, '-');
			                const m = s.match(/([0-9][0-9,.\s]*)\s*(?:-|Ä‘áº¿n|to)\s*([0-9][0-9,.\s]*)/i);
			                if (!m) return null;
			                const a = parseNumber(m[1]);
			                const b = parseNumber(m[2]);
			                if (a == null || b == null) return null;
			                const low = Math.min(a, b);
			                const high = Math.max(a, b);
			                if (!Number.isFinite(low) || !Number.isFinite(high) || low === high) return null;
			                return { low, high };
			            };

			            const zones = [];
			            const pushZone = (z) => {
			                if (!z) return;
			                const key = `${z.kind}|${z.label}|${z.low ?? ''}|${z.high ?? ''}|${z.price ?? ''}`;
			                zones.__seen = zones.__seen || new Set();
			                if (zones.__seen.has(key)) return;
			                zones.__seen.add(key);
			                zones.push(z);
			            };

			            // Focused core extractor: H1â€“H3 and R1â€“R3 from the "Má»¨C GIÃ QUAN TRá»ŒNG" section.
			            // Prefer ranges (zones) over single lines.
			            const hrRe = /\b(H|R)\s*(\d{1,2})\s*\(([^)]{1,80})\)/gi;
			            let m;
			            while ((m = hrRe.exec(text)) !== null) {
			                const idx = Number(m[2]);
			                if (![1, 2, 3].includes(idx)) continue;
			                const kind = (m[1] || '').toUpperCase() === 'H' ? 'support' : 'resistance';
			                const label = `${(m[1] || '').toUpperCase()}${idx}`;
			                const inside = (m[3] || '').trim();
			                const r = parseRange(inside);
			                if (r) {
			                    pushZone({ kind, label, low: r.low, high: r.high });
			                    continue;
			                }
			                const n = parseNumber(inside);
			                if (n != null) pushZone({ kind, label, price: n });
			            }

			            if (zones.__seen) delete zones.__seen;

			            const cleaned = zones.filter(z => {
			                const v = (z.price != null) ? z.price : ((z.low + z.high) / 2);
			                return typeof v === 'number' && Number.isFinite(v) && v > 0 && v < 1e7;
			            });
			            const rank = (k) => (k === 'support' ? 0 : 1);
			            cleaned.sort((a, b) => {
			                const ra = rank(a.kind), rb = rank(b.kind);
			                if (ra !== rb) return ra - rb;
			                const va = (a.price != null ? a.price : ((a.low + a.high) / 2));
			                const vb = (b.price != null ? b.price : ((b.low + b.high) / 2));
			                return va - vb;
			            });
			            return cleaned;
			        }

		        function renderKeyLevelsPanelHtml(panelId, indexKey) {
		            const payload = getIndexOhlcvPayload(indexKey);
		            if (!payload) {
		                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u giÃ¡ cho index nÃ y.</p></div>`;
		            }
		            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
		            const metaRight = payload.name ? `Index: ${escapeHtml(payload.name)}` : '';
		            return `
		                <div class="keylevels-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
		                    <div class="keylevels-toolbar">
		                        <div class="title">Biá»ƒu Ä‘á»“ giÃ¡ &amp; vÃ¹ng quan trá»ng</div>
		                        <div class="keylevels-controls">
		                            <div class="keylevels-segment" data-role="side">
		                                <button class="keylevels-segbtn active" data-side="both" type="button">Cáº£ hai</button>
		                                <button class="keylevels-segbtn" data-side="support" type="button">BÃªn Mua</button>
		                                <button class="keylevels-segbtn" data-side="resistance" type="button">BÃªn BÃ¡n</button>
		                            </div>
		                            <div class="keylevels-checks" data-role="levels">
		                                ${['H1','H2','H3','R1','R2','R3'].map(l => `
		                                    <label class="keylevels-check">
		                                        <input type="checkbox" data-level="${l}" checked />
		                                        <span>${l}</span>
		                                    </label>
		                                `).join('')}
		                            </div>
		                        </div>
		                    </div>
		                    <div class="keylevels-body">
		                        <div class="keylevels-chart" data-role="chart"></div>
		                        <div class="keylevels-tags" data-role="tags"></div>
		                        <div class="ohlcv-meta" style="margin-top:10px;">
		                            <div>${metaLeft}</div>
		                            <div>${metaRight}</div>
		                        </div>
		                    </div>
		                </div>
		            `;
		        }

			        function initKeyLevelsPanel(panelId, indexKey, sectionHtml) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
		            const payload = getIndexOhlcvPayload(indexKey);
		            if (!payload) return;
		            const chartEl = panelEl.querySelector('[data-role="chart"]');
		            const tagsEl = panelEl.querySelector('[data-role="tags"]');
		            if (!chartEl || typeof LightweightCharts === 'undefined') return;

		            const barsAll = payload.bars || [];
		            const bars = barsAll.slice(-Math.min(200, barsAll.length));
		            if (bars.length < 5) return;

		            const allZones = extractKeyPriceZonesFromHtml(sectionHtml || '');

		            const sideEl = panelEl.querySelector('[data-role="side"]');
		            const levelsEl = panelEl.querySelector('[data-role="levels"]');
		            const getSelectedSide = () => {
		                const btn = sideEl ? sideEl.querySelector('.keylevels-segbtn.active') : null;
		                const v = btn ? btn.getAttribute('data-side') : 'both';
		                return v || 'both';
		            };
		            const getSelectedLevels = () => {
		                const set = new Set();
		                if (!levelsEl) return set;
		                levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
		                    if (inp.checked) set.add(inp.getAttribute('data-level'));
		                });
		                return set;
		            };

		            const filterZones = () => {
		                const side = getSelectedSide();
		                const levels = getSelectedLevels();
		                return allZones.filter(z => {
		                    if (levels.size && !levels.has(z.label)) return false;
		                    if (side === 'support') return z.kind === 'support';
		                    if (side === 'resistance') return z.kind === 'resistance';
		                    return true;
		                });
		            };

		            const renderTags = (zones) => {
		                if (!tagsEl) return;
		                if (!zones.length) {
		                    tagsEl.innerHTML = `<span class="keylevels-tag">KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c H1â€“H3/R1â€“R3 tá»« bÃ¡o cÃ¡o.</span>`;
		                    return;
		                }
		                const toText = (z) => {
		                    if (z.low != null && z.high != null) return `${z.label}: ${z.low.toLocaleString()}â€“${z.high.toLocaleString()}`;
		                    return `${z.label}: ${(z.price ?? 0).toLocaleString()}`;
		                };
		                tagsEl.innerHTML = zones.map(z =>
		                    `<span class="keylevels-tag ${z.kind}">${escapeHtml(toText(z))}</span>`
		                ).join('');
		            };

		            const theme = document.body.getAttribute('data-theme') || 'light';
		            const isDark = theme === 'dark';
		            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
		            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
		            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';

		            const draw = () => {
		                const zones = filterZones();
		                renderTags(zones);

		                if (panelEl.__uiGlmKeyChart) {
		                    try { panelEl.__uiGlmKeyChart.remove(); } catch (_) {}
		                    panelEl.__uiGlmKeyChart = null;
		                }
		                const chart = LightweightCharts.createChart(chartEl, {
		                    layout: {
		                        background: { type: 'solid', color: chartBg },
		                        textColor: textCol,
		                        fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
		                        fontSize: 12,
		                    },
		                    grid: {
		                        vertLines: { color: gridCol },
		                        horzLines: { color: gridCol },
		                    },
		                    rightPriceScale: { borderVisible: false },
		                    timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
		                    crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
		                    handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
		                    handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
		                    height: chartEl.clientHeight || 380,
		                    width: chartEl.clientWidth || 700,
		                });
		                panelEl.__uiGlmKeyChart = chart;

		                const line = chart.addLineSeries({
		                    color: isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)',
		                    lineWidth: 2,
		                });
		                line.setData(bars.map(b => ({ time: b.d, value: b.c })));

		                const makeLine = (price, color, title, axisVisible, width, style) => {
		                    try {
		                        return line.createPriceLine({
		                            price,
		                            color,
		                            lineWidth: width,
		                            lineStyle: style,
		                            axisLabelVisible: axisVisible,
		                            title: title || '',
		                        });
		                    } catch (_) {
		                        return null;
		                    }
		                };

		                const supportCol = 'rgba(16,185,129,0.92)';
		                const resistCol = 'rgba(239,68,68,0.92)';

		                for (const z of zones) {
		                    const color = z.kind === 'support' ? supportCol : resistCol;
		                    const style = LightweightCharts.LineStyle.Dashed;
		                    if (z.low != null && z.high != null) {
		                        const mid = (z.low + z.high) / 2;
		                        makeLine(z.low, color.replace('0.92', '0.35'), '', false, 1, style);
		                        makeLine(z.high, color.replace('0.92', '0.35'), '', false, 1, style);
		                        makeLine(mid, color, z.label || '', true, 2, style);
		                    } else if (z.price != null) {
		                        makeLine(z.price, color, z.label || '', true, 2, style);
		                    }
		                }

		                chart.timeScale().fitContent();

		                if (panelEl.__uiGlmKeyResizeObs) {
		                    try { panelEl.__uiGlmKeyResizeObs.disconnect(); } catch (_) {}
		                    panelEl.__uiGlmKeyResizeObs = null;
		                }
		                const ro = new ResizeObserver(() => {
		                    try {
		                        chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
		                        chart.timeScale().fitContent();
		                    } catch (_) {}
		                });
		                ro.observe(chartEl);
		                panelEl.__uiGlmKeyResizeObs = ro;
		            };

		            const bindControls = () => {
		                if (sideEl) {
		                    sideEl.querySelectorAll('.keylevels-segbtn[data-side]').forEach(btn => {
		                        btn.addEventListener('click', () => {
		                            sideEl.querySelectorAll('.keylevels-segbtn').forEach(b => b.classList.remove('active'));
		                            btn.classList.add('active');
		                            draw();
		                        });
		                    });
		                }
		                if (levelsEl) {
		                    levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
		                        inp.addEventListener('change', () => draw());
		                    });
		                }
		            };

			            bindControls();
			            draw();
			        }

			        function extractTargetPriceZonesFromHtml(html) {
			            const base = extractKeyPriceZonesFromHtml(html);
			            const keep = new Set(['H1', 'H2', 'R1', 'R2']);
			            return (Array.isArray(base) ? base : []).filter(z => z && keep.has(z.label));
			        }

			        function renderTargetLevelsPanelHtml(panelId, indexKey) {
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) {
			                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u giÃ¡ cho index nÃ y.</p></div>`;
			            }
			            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
			            const metaRight = payload.name ? `Index: ${escapeHtml(payload.name)}` : '';
			            return `
			                <div class="targetlevels-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="keylevels-toolbar">
			                        <div class="title">Biá»ƒu Ä‘á»“ giÃ¡ &amp; vÃ¹ng má»¥c tiÃªu</div>
			                        <div class="keylevels-controls">
			                            <div class="keylevels-segment" data-role="side">
			                                <button class="keylevels-segbtn active" data-side="both" type="button">Cáº£ hai</button>
			                                <button class="keylevels-segbtn" data-side="support" type="button">BÃªn Mua</button>
			                                <button class="keylevels-segbtn" data-side="resistance" type="button">BÃªn BÃ¡n</button>
			                            </div>
			                            <div class="keylevels-checks" data-role="levels">
			                                ${['H1','H2','R1','R2'].map(l => `
			                                    <label class="keylevels-check">
			                                        <input type="checkbox" data-level="${l}" checked />
			                                        <span>${l}</span>
			                                    </label>
			                                `).join('')}
			                            </div>
			                        </div>
			                    </div>
			                    <div class="keylevels-body">
			                        <div class="keylevels-chart" data-role="chart"></div>
			                        <div class="keylevels-tags" data-role="tags"></div>
			                        <div class="ohlcv-meta" style="margin-top:10px;">
			                            <div>${metaLeft}</div>
			                            <div>${metaRight}</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function initTargetLevelsPanel(panelId, indexKey, sectionHtml) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) return;
			            const chartEl = panelEl.querySelector('[data-role="chart"]');
			            const tagsEl = panelEl.querySelector('[data-role="tags"]');
			            if (!chartEl || typeof LightweightCharts === 'undefined') return;

			            const barsAll = payload.bars || [];
			            const bars = barsAll.slice(-Math.min(200, barsAll.length));
			            if (bars.length < 5) return;

			            const allZones = extractTargetPriceZonesFromHtml(sectionHtml || '');

			            const sideEl = panelEl.querySelector('[data-role="side"]');
			            const levelsEl = panelEl.querySelector('[data-role="levels"]');
			            const getSelectedSide = () => {
			                const btn = sideEl ? sideEl.querySelector('.keylevels-segbtn.active') : null;
			                const v = btn ? btn.getAttribute('data-side') : 'both';
			                return v || 'both';
			            };
			            const getSelectedLevels = () => {
			                const set = new Set();
			                if (!levelsEl) return set;
			                levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
			                    if (inp.checked) set.add(inp.getAttribute('data-level'));
			                });
			                return set;
			            };

			            const filterZones = () => {
			                const side = getSelectedSide();
			                const levels = getSelectedLevels();
			                return allZones.filter(z => {
			                    if (levels.size && !levels.has(z.label)) return false;
			                    if (side === 'support') return z.kind === 'support';
			                    if (side === 'resistance') return z.kind === 'resistance';
			                    return true;
			                });
			            };

			            const renderTags = (zones) => {
			                if (!tagsEl) return;
			                if (!zones.length) {
			                    tagsEl.innerHTML = `<span class="keylevels-tag">KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c H1â€“H2/R1â€“R2 tá»« bÃ¡o cÃ¡o.</span>`;
			                    return;
			                }
			                const toText = (z) => {
			                    if (z.low != null && z.high != null) return `${z.label}: ${z.low.toLocaleString()}â€“${z.high.toLocaleString()}`;
			                    return `${z.label}: ${(z.price ?? 0).toLocaleString()}`;
			                };
			                tagsEl.innerHTML = zones.map(z =>
			                    `<span class="keylevels-tag ${z.kind}">${escapeHtml(toText(z))}</span>`
			                ).join('');
			            };

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';

			            const draw = () => {
			                const zones = filterZones();
			                renderTags(zones);

			                if (panelEl.__uiGlmTargetChart) {
			                    try { panelEl.__uiGlmTargetChart.remove(); } catch (_) {}
			                    panelEl.__uiGlmTargetChart = null;
			                }
			                const chart = LightweightCharts.createChart(chartEl, {
			                    layout: {
			                        background: { type: 'solid', color: chartBg },
			                        textColor: textCol,
			                        fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                        fontSize: 12,
			                    },
			                    grid: {
			                        vertLines: { color: gridCol },
			                        horzLines: { color: gridCol },
			                    },
			                    rightPriceScale: { borderVisible: false },
			                    timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
			                    crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
			                    handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                    handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                    height: chartEl.clientHeight || 380,
			                    width: chartEl.clientWidth || 700,
			                });
			                panelEl.__uiGlmTargetChart = chart;

			                const line = chart.addLineSeries({
			                    color: isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)',
			                    lineWidth: 2,
			                });
			                line.setData(bars.map(b => ({ time: b.d, value: b.c })));

			                const makeLine = (price, color, title, axisVisible, width, style) => {
			                    try {
			                        return line.createPriceLine({
			                            price,
			                            color,
			                            lineWidth: width,
			                            lineStyle: style,
			                            axisLabelVisible: axisVisible,
			                            title: title || '',
			                        });
			                    } catch (_) {
			                        return null;
			                    }
			                };

			                const supportCol = 'rgba(16,185,129,0.92)';
			                const resistCol = 'rgba(239,68,68,0.92)';

			                for (const z of zones) {
			                    const color = z.kind === 'support' ? supportCol : resistCol;
			                    const style = LightweightCharts.LineStyle.Dashed;
			                    if (z.low != null && z.high != null) {
			                        const mid = (z.low + z.high) / 2;
			                        makeLine(z.low, color.replace('0.92', '0.35'), '', false, 1, style);
			                        makeLine(z.high, color.replace('0.92', '0.35'), '', false, 1, style);
			                        makeLine(mid, color, z.label || '', true, 2, style);
			                    } else if (z.price != null) {
			                        makeLine(z.price, color, z.label || '', true, 2, style);
			                    }
			                }

			                chart.timeScale().fitContent();

			                if (panelEl.__uiGlmTargetResizeObs) {
			                    try { panelEl.__uiGlmTargetResizeObs.disconnect(); } catch (_) {}
			                    panelEl.__uiGlmTargetResizeObs = null;
			                }
			                const ro = new ResizeObserver(() => {
			                    try {
			                        chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
			                        chart.timeScale().fitContent();
			                    } catch (_) {}
			                });
			                ro.observe(chartEl);
			                panelEl.__uiGlmTargetResizeObs = ro;
			            };

			            const bindControls = () => {
			                if (sideEl) {
			                    sideEl.querySelectorAll('.keylevels-segbtn[data-side]').forEach(btn => {
			                        btn.addEventListener('click', () => {
			                            sideEl.querySelectorAll('.keylevels-segbtn').forEach(b => b.classList.remove('active'));
			                            btn.classList.add('active');
			                            draw();
			                        });
			                    });
			                }
			                if (levelsEl) {
			                    levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
			                        inp.addEventListener('change', () => draw());
			                    });
			                }
			            };

			            bindControls();
			            draw();
			        }

			        function renderIndexPricePanelHtml(panelId, indexKey, mode = 'line') {
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) {
			                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u giÃ¡ cho index nÃ y.</p></div>`;
			            }

			            const title = mode === 'candles' ? 'Biá»ƒu Ä‘á»“ náº¿n (giÃ¡)' : 'Biá»ƒu Ä‘á»“ giÃ¡ (Close)';
			            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
			            const metaRight = payload.name ? `Index: ${escapeHtml(payload.name)}` : '';

			            return `
			                <div class="price-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}" data-mode="${escapeHtml(mode)}">
			                    <div class="price-toolbar">
			                        <div class="title">${escapeHtml(title)}</div>
			                        <div class="note">100 phiÃªn (cá»‘ Ä‘á»‹nh)</div>
			                    </div>
			                    <div class="price-body">
			                        <div class="price-chart" data-role="chart"></div>
			                        <div class="ohlcv-meta" style="margin-top:10px;">
			                            <div>${metaLeft}</div>
			                            <div>${metaRight}</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function initIndexPricePanel(panelId, indexKey, mode = 'line') {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) return;
			            const chartEl = panelEl.querySelector('[data-role="chart"]');
			            if (!chartEl || typeof LightweightCharts === 'undefined') return;

			            const barsAll = payload.bars || [];
			            const bars = barsAll.slice(-Math.min(100, barsAll.length));
			            if (bars.length < 2) return;

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';
			            const upCol = 'rgba(16,185,129,0.95)';
			            const downCol = 'rgba(239,68,68,0.95)';

			            if (panelEl.__uiGlmPriceChart) {
			                try { panelEl.__uiGlmPriceChart.remove(); } catch (_) {}
			                panelEl.__uiGlmPriceChart = null;
			            }

			            const chart = LightweightCharts.createChart(chartEl, {
			                layout: {
			                    background: { type: 'solid', color: chartBg },
			                    textColor: textCol,
			                    fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                    fontSize: 12,
			                },
			                grid: {
			                    vertLines: { color: gridCol },
			                    horzLines: { color: gridCol },
			                },
			                rightPriceScale: { borderVisible: false },
			                timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
			                crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
			                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                height: chartEl.clientHeight || 220,
			                width: chartEl.clientWidth || 700,
			            });
			            panelEl.__uiGlmPriceChart = chart;

			            if (String(mode || 'line') === 'candles') {
			                const candles = chart.addCandlestickSeries({
			                    upColor: upCol,
			                    downColor: downCol,
			                    borderUpColor: upCol,
			                    borderDownColor: downCol,
			                    wickUpColor: 'rgba(148,163,184,0.85)',
			                    wickDownColor: 'rgba(148,163,184,0.85)',
			                });
			                candles.setData(bars.map(b => ({ time: b.d, open: b.o, high: b.h, low: b.l, close: b.c })));
			            } else {
			                const line = chart.addLineSeries({
			                    color: isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)',
			                    lineWidth: 2,
			                });
			                line.setData(bars.map(b => ({ time: b.d, value: b.c })));
			            }

			            chart.timeScale().fitContent();

			            if (panelEl.__uiGlmPriceResizeObs) {
			                try { panelEl.__uiGlmPriceResizeObs.disconnect(); } catch (_) {}
			                panelEl.__uiGlmPriceResizeObs = null;
			            }
			            const ro = new ResizeObserver(() => {
			                try {
			                    chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
			                    chart.timeScale().fitContent();
			                } catch (_) {}
			            });
			            ro.observe(chartEl);
			            panelEl.__uiGlmPriceResizeObs = ro;
			        }

			        function getMarketBreadthSnapshotPayload() {
			            const payload =
			                (typeof window !== 'undefined' && window.UI_GLM_MARKET_BREADTH_SNAPSHOT)
			                    ? window.UI_GLM_MARKET_BREADTH_SNAPSHOT
			                    : null;
			            if (!payload || typeof payload !== 'object') return null;
			            if (payload.advancing == null || payload.declining == null) return null;
			            return payload;
			        }

			        function parseBreadthMetricsFromReportHtml(sectionHtml) {
			            try {
			                const root = document.createElement('div');
			                root.innerHTML = sectionHtml || '';
			                const text = (root.textContent || '').replace(/\s+/g, ' ').trim();
			                if (!text) return null;

			                const parseNum = (raw) => {
			                    if (raw == null) return null;
			                    const v = Number(String(raw).replace(/,/g, '.'));
			                    return Number.isFinite(v) ? v : null;
			                };
			                const parseInt = (raw) => {
			                    if (raw == null) return null;
			                    const v = Number(String(raw).replace(/[^\d]/g, ''));
			                    return Number.isFinite(v) ? v : null;
			                };

			                let adv = null, dec = null, advPct = null;
			                let m = text.match(/\bA\s*\/\s*D\s*([0-9]{1,5})\s*\/\s*([0-9]{1,5})\b/i);
			                if (m) {
			                    adv = parseInt(m[1]);
			                    dec = parseInt(m[2]);
			                } else {
			                    m = text.match(/ch(?:á»‰|i)\s*c(?:Ã³|o)\s*([0-9]{1,5})\s*m(?:Ã£|a)\s*t(?:Äƒ|a)ng[^.]{0,120}?([0-9]{1,5})\s*m(?:Ã£|a)\s*gi(?:áº£|a)m/i);
			                    if (m) {
			                        adv = parseInt(m[1]);
			                        dec = parseInt(m[2]);
			                    }
			                }
			                m = text.match(/t(?:á»·|i)\s*l(?:á»‡|e)\s*t(?:Äƒ|a)ng[^0-9]{0,30}([0-9]+(?:[.,][0-9]+)?)\s*%/i);
			                if (m) advPct = parseNum(m[1]);

			                m = text.match(/\bTRIN\b[^0-9]{0,20}([0-9]+(?:[.,][0-9]+)?)\b/i);
			                const trin = m ? parseNum(m[1]) : null;

			                m = text.match(/volume\s*ratio[^0-9]{0,30}([0-9]+(?:[.,][0-9]+)?)\s*x?/i);
			                const volumeRatio = m ? parseNum(m[1]) : null;

			                const hasAny = (adv != null && dec != null) || trin != null || volumeRatio != null;
			                if (!hasAny) return null;

			                // Reconstruct total/unchanged if possible (keeps UI consistent with report text).
			                let total = null;
			                if (adv != null && advPct != null && advPct > 0) {
			                    total = Math.round((adv * 100) / advPct);
			                }
			                let unchanged = null;
			                if (total != null && adv != null && dec != null) {
			                    unchanged = total - adv - dec;
			                    if (!Number.isFinite(unchanged) || unchanged < 0) unchanged = null;
			                }

			                return { adv, dec, unchanged, total, trin, volumeRatio };
			            } catch (_) {
			                return null;
			            }
			        }

			        function extractBreadthEvidenceHtml(sectionHtml, kind) {
			            try {
			                const root = document.createElement('div');
			                root.innerHTML = sectionHtml || '';
			                const ps = Array.from(root.querySelectorAll('p'));
			                const texts = ps.map(p => (p.textContent || '').replace(/\s+/g, ' ').trim()).filter(Boolean);
			                if (!texts.length) return `<p>KhÃ´ng tÃ¬m tháº¥y Ä‘oáº¡n text liÃªn quan trong bÃ¡o cÃ¡o.</p>`;

			                const pickBy = (re) => texts.filter(t => re.test(t));
			                let picked = [];
			                if (kind === 'ad') {
			                    picked = pickBy(/tá»·\s*lá»‡\s*tÄƒng\/giáº£m|advance\/decline|\bA\/D\b/i);
			                } else if (kind === 'trin') {
			                    picked = pickBy(/\bTRIN\b/i);
			                } else if (kind === 'vr') {
			                    picked = pickBy(/volume\s*ratio/i);
			                } else if (kind === 'mcc') {
			                    picked = pickBy(/mcclellan/i);
			                }

			                // Limit to a few paragraphs to keep popup compact.
			                const out = (picked.length ? picked : []).slice(0, 3);
			                if (!out.length) return `<p>KhÃ´ng tÃ¬m tháº¥y Ä‘oáº¡n text liÃªn quan trong bÃ¡o cÃ¡o.</p>`;

			                return out.map(t => `<p>${escapeHtml(t)}</p>`).join('');
			            } catch (_) {
			                return `<p>KhÃ´ng tÃ¬m tháº¥y Ä‘oáº¡n text liÃªn quan trong bÃ¡o cÃ¡o.</p>`;
			            }
			        }

				        function buildBreadthSnapshotPanelHtml(panelId, indexKey, payload) {
				            if (!payload) return `<div class="info-box"><p>KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c dá»¯ liá»‡u breadth (snapshot) tá»« bÃ¡o cÃ¡o.</p></div>`;

				            const adv = payload.adv;
				            const dec = payload.dec;
				            const unchanged = payload.unchanged;
				            const total = payload.total;
				            const trin = payload.trin;
				            const volumeRatio = payload.volumeRatio;
				            const mcclellan = payload.mcclellan;

				            const totalKnown = (adv != null && dec != null)
				                ? (adv + dec + (unchanged != null ? unchanged : 0))
				                : null;
				            const denom = total != null ? total : (totalKnown != null ? totalKnown : null);

			            const pct = (x) => (denom && x != null ? Math.max(0, Math.min(100, 100 * (x / denom))) : 0);
			            const advPct = pct(adv);
			            const decPct = pct(dec);
			            const unPct = pct(unchanged);

			            const clamp01 = (v) => Math.max(0, Math.min(1, v));
				            const trinPos = trin == null ? 0.5 : clamp01(trin / 4.0);
				            const vrPos = volumeRatio == null ? 0.5 : clamp01(volumeRatio / 2.0);
				            const oscPos = mcclellan == null ? 0.5 : clamp01((mcclellan + 100) / 200);

			            const fmt2 = (v) => (v == null ? 'N/A' : Number(v).toFixed(2));
			            const fmt0 = (v) => (v == null ? 'N/A' : Number(v).toLocaleString());

			            return `
			                <div class="breadth-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="breadth-toolbar">
			                        <div class="title">Snapshot breadth (1 ngÃ y)</div>
			                        <div class="note">Nháº¥n Ä‘á»ƒ xem chi tiáº¿t</div>
			                    </div>
			                    <div class="breadth-grid">
			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="ad" data-adv="${adv ?? ''}" data-dec="${dec ?? ''}" data-unchanged="${unchanged ?? ''}" data-total="${total ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ“ˆ A/D (Advance/Decline)</div>
			                            <div class="v"><span>${fmt0(adv)}/${fmt0(dec)}</span><span>${denom ? `Total: ${fmt0(denom)}` : ''}</span></div>
			                            <div class="mini-bar" aria-hidden="true">
			                                <span class="pos" style="width:${advPct.toFixed(1)}%"></span>
			                                <span class="neu" style="width:${unPct.toFixed(1)}%"></span>
			                                <span class="neg" style="width:${decPct.toFixed(1)}%"></span>
			                            </div>
			                            <div class="hint">Tá»· lá»‡ tÄƒng/giáº£m + unchanged</div>
			                        </div>

			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="trin" data-trin="${trin ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ§­ TRIN</div>
			                            <div class="v"><span>${fmt2(trin)}</span><span>${trin != null ? (trin > 1.2 ? 'Ãp lá»±c bÃ¡n' : (trin < 0.8 ? 'Ãp lá»±c mua' : 'Trung tÃ­nh')) : 'N/A'}</span></div>
			                            <div class="mini-gauge" aria-hidden="true">
			                                <span class="marker" style="left: calc(${(trinPos * 100).toFixed(2)}% - 1px)"></span>
			                            </div>
			                            <div class="hint">NgÆ°á»¡ng tham chiáº¿u: 0.8 / 1.0 / 1.2 / 2.0+</div>
			                        </div>

			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="vr" data-volume-ratio="${volumeRatio ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ’§ Volume Ratio</div>
			                            <div class="v"><span>${volumeRatio != null ? `${fmt2(volumeRatio)}x` : 'N/A'}</span><span>${volumeRatio != null ? (volumeRatio > 1.2 ? 'UpVol trá»™i' : (volumeRatio < 0.8 ? 'DownVol trá»™i' : 'CÃ¢n báº±ng')) : 'N/A'}</span></div>
			                            <div class="mini-gauge" aria-hidden="true">
			                                <span class="marker" style="left: calc(${(vrPos * 100).toFixed(2)}% - 1px)"></span>
			                            </div>
			                            <div class="hint">AdvVol / DecVol (snapshot)</div>
			                        </div>

			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="mcc" data-mcclellan="${mcclellan ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ“Š McClellan Oscillator</div>
			                            <div class="v"><span>${mcclellan != null ? fmt2(mcclellan) : 'N/A'}</span><span>${mcclellan != null ? (mcclellan > 0 ? 'DÆ°Æ¡ng' : (mcclellan < 0 ? 'Ã‚m' : '0')) : 'N/A'}</span></div>
			                            <div class="mini-osc" aria-hidden="true">
			                                <span class="zero"></span>
			                                <span class="fill" style="${mcclellan == null ? 'display:none;' : (mcclellan >= 0 ? `left:50%; width:${((oscPos - 0.5) * 200).toFixed(1)}%; background: rgba(16,185,129,0.70);` : `left:${(oscPos * 100).toFixed(1)}%; width:${((0.5 - oscPos) * 200).toFixed(1)}%; background: rgba(239,68,68,0.70);`)}"></span>
			                            </div>
			                            <div class="hint">Snapshot value quanh 0</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function openBreadthDetailFromEl(el) {
			            try {
			                const kind = el.getAttribute('data-kind') || '';
			                const sectionHtml = (typeof window !== 'undefined' && window.__uiGlmBreadthSectionHtml) ? window.__uiGlmBreadthSectionHtml : '';
			                const evidenceHtml = extractBreadthEvidenceHtml(sectionHtml, kind);
			                const evidenceBlock = `
			                    <div style="height: 10px;"></div>
			                    <div class="info-box">
			                        <p><strong>TrÃ­ch Ä‘oáº¡n bÃ¡o cÃ¡o:</strong></p>
			                        ${evidenceHtml}
			                    </div>
			                `;
			                if (kind === 'ad') {
			                    const adv = el.getAttribute('data-adv') || 'N/A';
			                    const dec = el.getAttribute('data-dec') || 'N/A';
			                    const unchanged = el.getAttribute('data-unchanged') || 'N/A';
			                    const total = el.getAttribute('data-total') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'Advance/Decline (A/D)',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">MÃ£ tÄƒng</div><div class="v">${escapeHtml(adv)}</div></div>
			                                <div class="ui-metric"><div class="k">MÃ£ giáº£m</div><div class="v">${escapeHtml(dec)}</div></div>
			                                <div class="ui-metric"><div class="k">Unchanged</div><div class="v">${escapeHtml(unchanged)}</div></div>
			                                <div class="ui-metric"><div class="k">Total</div><div class="v">${escapeHtml(total)}</div></div>
			                            </div>
			                            <div style="margin-top:10px; color: var(--text-secondary); font-weight: 800; font-size: 0.9rem;">
			                                Advance/Decline pháº£n Ã¡nh Ä‘á»™ rá»™ng thá»‹ trÆ°á»ng trong ngÃ y.
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                    return;
			                }
			                if (kind === 'trin') {
			                    const trin = el.getAttribute('data-trin') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'TRIN',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">TRIN</div><div class="v">${escapeHtml(trin)}</div></div>
			                                <div class="ui-metric"><div class="k">Gá»£i Ã½</div><div class="v">0.8â€“1.2: trung tÃ­nh</div></div>
			                                <div class="ui-metric"><div class="k">BÃªn mua</div><div class="v">&lt; 0.8</div></div>
			                                <div class="ui-metric"><div class="k">BÃªn bÃ¡n</div><div class="v">&gt; 1.2</div></div>
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                    return;
			                }
			                if (kind === 'vr') {
			                    const vr = el.getAttribute('data-volume-ratio') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'Volume Ratio',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">Volume Ratio</div><div class="v">${escapeHtml(vr)}${vr !== 'N/A' ? 'x' : ''}</div></div>
			                                <div class="ui-metric"><div class="k">CÃ´ng thá»©c</div><div class="v">AdvVol / DecVol</div></div>
			                                <div class="ui-metric"><div class="k">Diá»…n giáº£i</div><div class="v">&lt;0.8: down-volume trá»™i</div></div>
			                                <div class="ui-metric"><div class="k">Trung tÃ­nh</div><div class="v">0.8â€“1.2</div></div>
			                                <div class="ui-metric"><div class="k">Up-volume</div><div class="v">&gt;1.2</div></div>
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                    return;
			                }
			                if (kind === 'mcc') {
			                    const v = el.getAttribute('data-mcclellan') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'McClellan Oscillator',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">GiÃ¡ trá»‹</div><div class="v">${escapeHtml(v)}</div></div>
			                                <div class="ui-metric"><div class="k">Diá»…n giáº£i</div><div class="v">DÆ°Æ¡ng: breadth cáº£i thiá»‡n</div></div>
			                                <div class="ui-metric"><div class="k">Ã‚m</div><div class="v">breadth suy yáº¿u</div></div>
			                                <div class="ui-metric"><div class="k">0</div><div class="v">cÃ¢n báº±ng</div></div>
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                }
			            } catch (_) {}
			        }

			        function renderIndexOhlcvPanelHtml(panelId, indexKey) {
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) {
			                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u OHLCV cho index nÃ y.</p></div>`;
			            }

			            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
			            const metaRight = payload.constituents ? `Constituents: ${escapeHtml(payload.constituents)} (${escapeHtml(payload.name)})` : '';
			            const metaNote = 'Trá»¥c Y: GiÃ¡ (OHLC).';

			            return `
			                <div class="ohlcv-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="ohlcv-toolbar">
			                        <div class="title">Biá»ƒu Ä‘á»“ náº¿n &amp; khá»‘i lÆ°á»£ng</div>
			                        <div class="ohlcv-controls">
			                            <div class="fixed">100 phiÃªn (cá»‘ Ä‘á»‹nh)</div>
			                        </div>
			                    </div>
			                    <div class="ohlcv-body">
			                        <div class="ohlcv-chart" data-role="chart"></div>
			                        <div class="ohlcv-tooltip" data-role="tooltip" style="display:none;"></div>
			                        <div class="ohlcv-meta">
			                            <div>${metaLeft}</div>
			                            <div>${metaRight}</div>
			                            <div>${metaNote}</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function initIndexOhlcvPanel(panelId, indexKey) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) return;

			            const chartEl = panelEl.querySelector('[data-role="chart"]');
			            const tooltipEl = panelEl.querySelector('[data-role="tooltip"]');
			            if (!chartEl || typeof LightweightCharts === 'undefined') return;

			            const barsAll = payload.bars || [];
			            const bars = barsAll.slice(-Math.min(100, barsAll.length));
			            if (bars.length < 2) return;

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';
			            const upCol = 'rgba(16,185,129,0.95)';
			            const downCol = 'rgba(239,68,68,0.95)';

			            // Cleanup previous instance if exists
			            if (panelEl.__uiGlmChart) {
			                try { panelEl.__uiGlmChart.remove(); } catch (_) {}
			                panelEl.__uiGlmChart = null;
			            }

			            const chart = LightweightCharts.createChart(chartEl, {
			                layout: {
			                    background: { type: 'solid', color: chartBg },
			                    textColor: textCol,
			                    fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                    fontSize: 12,
			                },
			                grid: {
			                    vertLines: { color: gridCol },
			                    horzLines: { color: gridCol },
			                },
			                rightPriceScale: {
			                    borderVisible: false,
			                },
			                timeScale: {
			                    borderVisible: false,
			                    rightOffset: 4,
			                    fixLeftEdge: true,
			                    fixRightEdge: true,
			                },
			                crosshair: {
			                    mode: LightweightCharts.CrosshairMode.Magnet,
			                },
			                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                height: chartEl.clientHeight || 260,
			                width: chartEl.clientWidth || 600,
			            });
			            panelEl.__uiGlmChart = chart;

			            const candle = chart.addCandlestickSeries({
			                upColor: upCol,
			                downColor: downCol,
			                borderUpColor: upCol,
			                borderDownColor: downCol,
			                wickUpColor: isDark ? 'rgba(226,232,240,0.55)' : 'rgba(15,23,42,0.35)',
			                wickDownColor: isDark ? 'rgba(226,232,240,0.55)' : 'rgba(15,23,42,0.35)',
			            });

			            const volume = chart.addHistogramSeries({
			                priceFormat: { type: 'volume' },
			                priceScaleId: '',
			                scaleMargins: { top: 0.78, bottom: 0 },
			            });

			            const candleData = bars.map(b => ({ time: b.d, open: b.o, high: b.h, low: b.l, close: b.c }));
			            candle.setData(candleData);
			            const volData = bars.map(b => ({
			                time: b.d,
			                value: b.v || 0,
			                color: (b.c >= b.o) ? 'rgba(16,185,129,0.45)' : 'rgba(239,68,68,0.45)',
			            }));
			            volume.setData(volData);
			            chart.timeScale().fitContent();

			            if (tooltipEl) {
			                const fmt = (x) => (typeof x === 'number' && Number.isFinite(x)) ? x.toLocaleString(undefined, { maximumFractionDigits: 2 }) : 'N/A';
			                const fmtVol = (x) => (typeof x === 'number' && Number.isFinite(x)) ? x.toLocaleString(undefined, { maximumFractionDigits: 0 }) : 'N/A';
			                const setTip = (t, o, h, l, c, v) => {
			                    tooltipEl.innerHTML = `<div style="font-weight:900;margin-bottom:4px;">${escapeHtml(String(t || ''))}</div>` +
			                        `<div>O: ${escapeHtml(fmt(o))}  H: ${escapeHtml(fmt(h))}  L: ${escapeHtml(fmt(l))}  C: ${escapeHtml(fmt(c))}</div>` +
			                        `<div style="margin-top:4px;">Vol: ${escapeHtml(fmtVol(v))}</div>`;
			                };
			                const last = bars[bars.length - 1];
			                setTip(last.d, last.o, last.h, last.l, last.c, last.v);
			                chart.subscribeCrosshairMove((param) => {
			                    if (!param || !param.time || !param.point) {
			                        tooltipEl.style.display = 'none';
			                        return;
			                    }
			                    tooltipEl.style.display = 'block';
			                    const t = param.time;
			                    const cData = param.seriesData.get(candle);
			                    const vData = param.seriesData.get(volume);
			                    if (cData) {
			                        setTip(t, cData.open, cData.high, cData.low, cData.close, vData ? vData.value : null);
			                    }
			                });
			                // Hide tooltip when leaving the chart area
			                chartEl.addEventListener('mouseleave', () => {
			                    tooltipEl.style.display = 'none';
			                });
			            }

			            // resize: per-panel observer
			            if (panelEl.__uiGlmResizeObs) {
			                try { panelEl.__uiGlmResizeObs.disconnect(); } catch (_) {}
			                panelEl.__uiGlmResizeObs = null;
			            }
			            const ro = new ResizeObserver(() => {
			                try {
			                    chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
			                    chart.timeScale().fitContent();
			                } catch (_) {}
			            });
			            ro.observe(chartEl);
			            panelEl.__uiGlmResizeObs = ro;
			        }

        function buildIndexSummaryHtml() {
            const rows = getSummaryIndexRows();
            const cardsHtml = renderSummaryCards(rows);
            return `
                <div class="overview-extras">
                    <div class="block">
                        <div class="block-header">ðŸ“Š THá»NG KÃŠ CÃC CHá»ˆ Sá»</div>
                        <div class="block-body">${cardsHtml}</div>
                    </div>
                </div>
            `;
        }

	        function buildMarketOverviewExtrasHtml() {
	            try {
	                const rows = getSummaryIndexRows();
	                const summaryCards = renderSummaryCards(rows);

	                const stockData = window.UI_GLM_VNINDEX_HEATMAP || null;
	                const gainers = stockData && Array.isArray(stockData.gainers) ? stockData.gainers : [];
	                const losers = stockData && Array.isArray(stockData.losers) ? stockData.losers : [];
	                const dateText = stockData && stockData.date ? ` (date: ${stockData.date})` : '';

	                const gainersBlock = renderStockHeatmapTable(
	                    gainers,
	                    `ðŸ”¥ Heatmap cá»• phiáº¿u VNINDEX TÄ‚NG GIÃ (giÃ¡ & giÃ¡ trá»‹ giao dá»‹ch)${dateText}`
	                );

	                const losersBlock = renderStockHeatmapTable(
	                    losers,
	                    `ðŸ”¥ Heatmap cá»• phiáº¿u VNINDEX GIáº¢M GIÃ (giÃ¡ & giÃ¡ trá»‹ giao dá»‹ch)${dateText}`
	                );

	                return `
	                    <div class="overview-extras">
	                        <div class="block">
	                            <div class="block-header">ðŸ“Š THá»NG KÃŠ CÃC CHá»ˆ Sá»</div>
	                            <div class="block-body">${summaryCards}</div>
	                        </div>
	                        ${gainersBlock}
	                        ${losersBlock}
	                    </div>
	                `;
	            } catch (err) {
	                const message = (err && err.message) ? err.message : String(err);
	                return `
	                    <div class="overview-extras">
	                        <div class="block">
	                            <div class="block-header">âš ï¸ Lá»—i render heatmap</div>
	                            <div class="block-body">
	                                <div class="info-box">
	                                    <p>KhÃ´ng render Ä‘Æ°á»£c heatmap do lá»—i JS.</p>
	                                    <p><strong>Chi tiáº¿t:</strong> ${escapeHtml(message)}</p>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                `;
	            }
	        }

	        function tryAutoSelectFromUrl() {
	            try {
	                const params = new URLSearchParams(window.location.search || '');
	                const indexKey = (params.get('index') || '').trim();
	                if (!indexKey) return;

	                const sectionIndexRaw = params.get('section');
	                const sectionTitleRaw = params.get('sectionTitle');

	                if (!data || !data[indexKey]) return;
	                selectIndex(indexKey);

	                const indexData = data[indexKey];
	                const sections = getSectionsForIndex(indexKey);

	                if (sectionTitleRaw) {
	                    const target = normalizeTitle(decodeURIComponent(sectionTitleRaw));
	                    const foundIndex = sections.findIndex(s => normalizeTitle(s.title) === target);
	                    if (foundIndex >= 0) selectSection(foundIndex);
	                    return;
	                }

	                if (sectionIndexRaw != null && sectionIndexRaw !== '') {
	                    const sectionIndex = Number(sectionIndexRaw);
	                    if (Number.isFinite(sectionIndex) && sectionIndex >= 0 && sectionIndex < sections.length) {
	                        selectSection(sectionIndex);
	                    }
	                }
	            } catch (e) {
	                // no-op
	            }
	        }

	        function tryAutoOpenStockPopupFromUrl() {
	            try {
	                if (!document.getElementById('uiModal')) {
	                    setTimeout(tryAutoOpenStockPopupFromUrl, 50);
	                    return;
	                }

	                const params = new URLSearchParams(window.location.search || '');
	                const symbol = (params.get('stockPopup') || '').trim().toUpperCase();
	                if (!symbol) return;

	                const stockData = (typeof window !== 'undefined' && window.UI_GLM_VNINDEX_HEATMAP) ? window.UI_GLM_VNINDEX_HEATMAP : null;
	                if (!stockData) {
	                    setTimeout(tryAutoOpenStockPopupFromUrl, 50);
	                    return;
	                }

	                const pool = []
	                    .concat(Array.isArray(stockData.gainers) ? stockData.gainers : [])
	                    .concat(Array.isArray(stockData.losers) ? stockData.losers : []);
	                const p = pool.find(x => x && String(x.symbol || '').toUpperCase() === symbol);
	                if (!p) return;

	                const btn = document.createElement('button');
	                btn.dataset.symbol = String(p.symbol || symbol);
	                btn.dataset.changePct = String(p.change_pct ?? '');
	                btn.dataset.price = (p.price != null && Number.isFinite(Number(p.price))) ? Number(p.price).toFixed(2) : 'N/A';
	                btn.dataset.value = (p.value != null && Number.isFinite(Number(p.value))) ? formatCompactNumber(Number(p.value)) : 'N/A';
	                btn.dataset.volume = (p.volume != null && Number.isFinite(Number(p.volume))) ? formatCompactNumber(Number(p.volume)) : 'N/A';
	                openVnindexStockPopupFromEl(btn);
	            } catch (e) {
	                // no-op
	            }
	        }

	        // Render section list in middle column
	        function renderSectionList(indexKey) {
	            const index = data[indexKey];
	            if (!index || !index.sections) {
	                document.getElementById('sectionList').innerHTML = '<div class="no-sections">KhÃ´ng cÃ³ dá»¯ liá»‡u</div>';
	                return;
	            }

            // Update section nav header
            document.getElementById('sectionNavTitle').textContent = index.title.split('-')[0].trim();

	            const sections = getSectionsForIndex(indexKey);
	            const container = document.getElementById('sectionList');

            let html = '';
            sections.forEach((section, idx) => {
                const isWhatIf = section.title.toLowerCase().includes('what-if') ||
                                section.title.toLowerCase().includes('ká»‹ch báº£n');
                const isConclusion = section.title.toLowerCase().includes('káº¿t luáº­n');

                html += `
                    <div class="section-item ${isWhatIf ? 'whatif' : ''} ${isConclusion ? 'conclusion-section' : ''}"
                         onclick="selectSection(${idx})"
                         data-section="${idx}">
                        <span class="icon">${section.icon || (isWhatIf ? 'âš ï¸' : (isConclusion ? 'ðŸ“Œ' : 'ðŸ“Š'))}</span>
                        <span class="title">${section.title.replace(/`/g, '')}</span>
                    </div>
                `;
            });

	            container.innerHTML = html;
	        }

        // Select and display a single section
	        function selectSection(sectionIndex) {
	            if (!currentIndex) return;

	            const index = data[currentIndex];
	            const sections = getSectionsForIndex(currentIndex);
	            const section = sections[sectionIndex];

	            if (!section) return;

            currentSectionIndex = sectionIndex;

            // Update active state in section list
            document.querySelectorAll('.section-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`[data-section="${sectionIndex}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // Update page title
            document.getElementById('pageTitle').textContent = section.title.replace(/`/g, '');

            // Show content, hide empty state
            document.getElementById('emptyState').style.display = 'none';
            const contentDiv = document.getElementById('singleSectionContent');
            contentDiv.style.display = 'block';

			            const isUiHeatmapSection = section.__uiType === 'heatmap_gainers' || section.__uiType === 'heatmap_losers';
			            const normalizedSectionTitle = normalizeTitle(section.title);
			            const isKeyLevelsSection = normalizedSectionTitle === 'Má»¨C GIÃ QUAN TRá»ŒNG';
			            const isTargetLevelsSection = normalizedSectionTitle === 'GIÃ Má»¤C TIÃŠU';
			            const isTrendChartSection =
			                normalizedSectionTitle === 'XU HÆ¯á»šNG GIÃ' ||
			                normalizedSectionTitle === 'XU HÆ¯á»šNG KHá»I LÆ¯á»¢NG';
			            const isBreadthSentimentSection = normalizedSectionTitle === 'MARKET BREADTH & TÃ‚M LÃ THá»Š TRÆ¯á»œNG';
			            const isPriceContextSection =
			                normalizedSectionTitle.includes('WHAT-IF') ||
			                normalizedSectionTitle === 'CUNG-Cáº¦U' ||
			                (normalizedSectionTitle.includes('MÃ” HÃŒNH') && normalizedSectionTitle.includes('Náº¾N'));
			            const pricePanelMode =
			                (normalizedSectionTitle.includes('MÃ” HÃŒNH') && normalizedSectionTitle.includes('Náº¾N'))
			                    ? 'candles'
			                    : 'line';

	            // Clean and format content
	            const formatter = new ContentFormatter();
	            let cleanContent = section.content
	                .replace(/\\n/g, '\n')
	                .replace(/\\t/g, '')
	                .replace(/\s+/g, ' ')
	                .replace(/<\/p>\s*<p>/g, '</p><p>')
	                .replace(/<p>\s*/g, '<p>')
	                .replace(/\s*<\/p>/g, '</p>')
	                .trim();

            // Render content
            const isWhatIf = section.title.toLowerCase().includes('what-if') ||
                            section.title.toLowerCase().includes('ká»‹ch báº£n');

	            if (isUiHeatmapSection) {
	                const heatmapHtml = renderIndexHeatmapSection(
	                    currentIndex,
	                    section.__uiType === 'heatmap_gainers' ? 'gainers' : 'losers'
	                );
	                contentDiv.innerHTML = `
	                    <div class="section-card">
	                        <div class="section-body">
	                            ${heatmapHtml}
	                        </div>
	                    </div>
	                `;
			            } else if (isWhatIf) {
			                const pricePanelId = isPriceContextSection ? `price_${currentIndex}_${sectionIndex}` : null;
			                const pricePanelHtml = isPriceContextSection ? renderIndexPricePanelHtml(pricePanelId, currentIndex, pricePanelMode) : '';
			                contentDiv.innerHTML = `
			                    <div class="whatif-card">
			                        <div class="whatif-card-body">
			                            ${formatter.format(cleanContent)}
			                            ${isPriceContextSection ? `<div style="height: 12px;"></div>${pricePanelHtml}` : ''}
			                        </div>
			                    </div>
			                `;
			                if (isPriceContextSection && pricePanelId) {
			                    setTimeout(() => initIndexPricePanel(pricePanelId, currentIndex, pricePanelMode), 0);
			                }
			            } else if (isKeyLevelsSection) {
			                const panelId = `keylevels_${currentIndex}_${sectionIndex}`;
			                const panelHtml = renderKeyLevelsPanelHtml(panelId, currentIndex);

			                window.__uiGlmKeyLevelsStore = window.__uiGlmKeyLevelsStore || {};
			                window.__uiGlmKeyLevelsStore[panelId] = { sectionHtml: cleanContent };

		                contentDiv.innerHTML = `
		                    <div class="section-card">
		                        <div class="section-body">
		                            ${formatter.format(cleanContent)}
		                            <div style="height: 12px;"></div>
		                            ${panelHtml}
		                        </div>
		                    </div>
			                `;
			                setTimeout(() => initKeyLevelsPanel(panelId, currentIndex, cleanContent), 0);
			            } else if (isTargetLevelsSection) {
			                const panelId = `targetlevels_${currentIndex}_${sectionIndex}`;
			                const panelHtml = renderTargetLevelsPanelHtml(panelId, currentIndex);

			                window.__uiGlmTargetLevelsStore = window.__uiGlmTargetLevelsStore || {};
			                window.__uiGlmTargetLevelsStore[panelId] = { sectionHtml: cleanContent };

			                contentDiv.innerHTML = `
			                    <div class="section-card">
			                        <div class="section-body">
			                            ${formatter.format(cleanContent)}
			                            <div style="height: 12px;"></div>
			                            ${panelHtml}
			                        </div>
			                    </div>
			                `;
			                setTimeout(() => initTargetLevelsPanel(panelId, currentIndex, cleanContent), 0);
				            } else if (isTrendChartSection) {
				                const panelId = `ohlcv_${currentIndex}_${sectionIndex}`;
				                const panelHtml = renderIndexOhlcvPanelHtml(panelId, currentIndex);

		                contentDiv.innerHTML = `
		                    <div class="section-card">
		                        <div class="section-body">
		                            ${formatter.format(cleanContent)}
		                            <div style="height: 12px;"></div>
		                            ${panelHtml}
		                        </div>
		                    </div>
		                `;
		                setTimeout(() => initIndexOhlcvPanel(panelId, currentIndex), 0);
			            } else {
		                const isMarketOverview =
		                    currentIndex === 'overview' &&
		                    normalizeTitle(section.title) === 'Tá»”NG QUAN THá»Š TRÆ¯á»œNG';
		                const extras = isMarketOverview ? buildMarketOverviewExtrasHtml() : '';

	                const isRanking =
	                    currentIndex === 'overview' &&
	                    normalizeTitle(section.title) === 'Xáº¾P Háº NG';
	                const rankingExtras = isRanking ? buildIndexSummaryHtml() : '';
		                const pricePanelId = isPriceContextSection ? `price_${currentIndex}_${sectionIndex}` : null;
		                const pricePanelHtml = isPriceContextSection ? renderIndexPricePanelHtml(pricePanelId, currentIndex, pricePanelMode) : '';
		                const breadthPanelId = isBreadthSentimentSection ? `breadth_${currentIndex}_${sectionIndex}` : null;
		                const breadthReport = isBreadthSentimentSection ? parseBreadthMetricsFromReportHtml(cleanContent) : null;
		                const breadthSnap = isBreadthSentimentSection ? getMarketBreadthSnapshotPayload() : null;
		                const breadthPayload = isBreadthSentimentSection && breadthReport
		                    ? {
		                        ...breadthReport,
		                        mcclellan: (breadthSnap && typeof breadthSnap.mcclellan === 'number') ? breadthSnap.mcclellan : null,
		                        mcclellan_type: breadthSnap ? breadthSnap.mcclellan_type : '',
		                    }
		                    : null;
		                const breadthPanelHtml = isBreadthSentimentSection ? buildBreadthSnapshotPanelHtml(breadthPanelId, currentIndex, breadthPayload) : '';
		                if (isBreadthSentimentSection) {
		                    window.__uiGlmBreadthSectionHtml = cleanContent || '';
		                }

		                contentDiv.innerHTML = `
		                    <div class="section-card ${section.alert ? 'alert' : ''}">
		                        <div class="section-body">
	                            ${formatter.format(cleanContent)}
	                            ${extras}
	                            ${rankingExtras}
	                            ${isPriceContextSection ? `<div style="height: 12px;"></div>${pricePanelHtml}` : ''}
	                            ${isBreadthSentimentSection ? `<div style="height: 12px;"></div>${breadthPanelHtml}` : ''}
	                        </div>
	                    </div>
		                `;
		                if (isPriceContextSection && pricePanelId) {
		                    setTimeout(() => initIndexPricePanel(pricePanelId, currentIndex, pricePanelMode), 0);
		                }
		            }
		        }

        // Select index (left sidebar)
        function selectIndex(key) {
            currentIndex = key;
            currentSectionIndex = null;

            // Update active state in index list
            document.querySelectorAll('.index-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-index="${key}"]`).classList.add('active');

            // Render section list
            renderSectionList(key);

            // Reset main content
            document.getElementById('pageTitle').textContent = 'Chá»n má»¥c phÃ¢n tÃ­ch Ä‘á»ƒ xem';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('singleSectionContent').style.display = 'none';
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.index-item').forEach(item => {
                const name = item.querySelector('.name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        });

			        // Initialize
			        renderSidebar();
			        setTimeout(() => {
			            tryAutoSelectFromUrl();
			            tryAutoOpenStockPopupFromUrl();
			        }, 0);
			        // Don't auto-select any index by default - let user choose

        // ========== DONATE MODAL FUNCTIONS ==========
        function showDonateModal() {
            const modal = document.getElementById('donateModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeDonateModal() {
            const modal = document.getElementById('donateModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Enable scrolling
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const donateModal = document.getElementById('donateModal');
            if (event.target === donateModal) closeDonateModal();

            const uiModal = document.getElementById('uiModal');
            if (event.target === uiModal) closeUiModal();
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key !== 'Escape') return;
            closeDonateModal();
            closeUiModal();
        });
    </script>

    <!-- UI Modal (cards + heatmaps) -->
    <div id="uiModal" class="ui-modal neutral">
        <div class="ui-modal-content">
            <button class="ui-close" onclick="closeUiModal()">&times;</button>
            <div class="ui-title" id="uiModalTitle"></div>
            <div class="ui-subtitle" id="uiModalSubtitle"></div>
            <div id="uiModalBody"></div>
        </div>
    </div>

    <!-- Donate Modal -->
    <div id="donateModal" class="donate-modal">
        <div class="donate-modal-content">
            <button class="donate-close" onclick="closeDonateModal()">&times;</button>

            <h2>ðŸ’ Má»i báº¡n má»™t ly cafe!</h2>

            <div class="donate-intro">
                ChÃ o báº¡n! ðŸ‘‹<br>
                Cáº£m Æ¡n báº¡n Ä‘Ã£ sá»­ dá»¥ng dashboard. Náº¿u báº¡n tháº¥y <strong>há»¯u Ã­ch</strong>,<br>
                má»™t ly cafe nhá» sáº½ giÃºp tÃ´i cÃ³ thÃªm Ä‘á»™ng lá»±c Ä‘á»ƒ phÃ¡t triá»ƒn thÃªm tÃ­nh nÄƒng má»›i! âœ¨
            </div>

            <div class="donate-options">
                <!-- MoMo -->
                <div class="donate-card">
                    <h3>ðŸ”µ MoMo</h3>
                    <img src="images/donate/momo_qr.jpg" alt="MoMo QR Code" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <p style="display: none; color: var(--warning);">ChÆ°a thÃªm QR code MoMo</p>
                    <p><strong>Email:</strong> stevetransg@gmail.com</p>
                    <p style="font-size: 0.85rem; margin-top: 12px; color: var(--text-secondary);">
                        ðŸ“± Scan QR hoáº·c chuyá»ƒn khoáº£n
                    </p>
                </div>
            </div>

            <div class="donate-note">
                ðŸ’– <strong>Cáº£m Æ¡n báº¡n tháº­t nhiá»u!</strong><br><br>
                Má»i sá»± á»§ng há»™ dÃ¹ nhá» Ä‘á»u lÃ  Ä‘á»™ng lá»±c lá»›n Ä‘á»ƒ tÃ´i tiáº¿p tá»¥c phÃ¡t triá»ƒn vÃ  cáº£i thiá»‡n dashboard má»—i ngÃ y! ðŸš€
            </div>

            <div class="donate-hearts">
                ðŸ’• ðŸŒ¸ âœ¨ ðŸŒ· ðŸ’—
            </div>
        </div>
    </div>
</body>
</html>
