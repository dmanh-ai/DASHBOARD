<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
				    <title>ðŸ“Š Market Dashboard V3 - Premium</title>
				    <script src="full_data.js"></script>
					    <script src="vnindex_heatmap_data.js"></script>
					    <script src="index_heatmap_data.js"></script>
						    <script src="vnindex_company_meta.js"></script>
						    <script src="vnindex_price_20d.js"></script>
						    <script src="market_breadth_snapshot.js"></script>
						    <script src="breadth_history.js"></script>
						    <script src="index_ohlcv.js"></script>
						    <script src="vendor/lightweight-charts.standalone.production.js"></script>
						    <script src="scripts/content_formatter.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @media (prefers-reduced-motion: reduce) {
            html:focus-within { scroll-behavior: auto; }
            *, *::before, *::after {
                animation-duration: 0.001ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.001ms !important;
                transition-delay: 0ms !important;
            }
        }

			        /* Dark Theme (Liquid Glass) */
				        [data-theme="dark"] {
					            --lg-radius-card: 20px;
					            --lg-blur: 8px;
				            --lg-glass-surface: rgba(2, 6, 23, 0.38);
				            --lg-glass-surface-2: rgba(2, 6, 23, 0.62);
				            --lg-glass-border: rgba(226, 232, 240, 0.14);
				            --lg-glass-highlight-top: rgba(255, 255, 255, 0.10);
				            --lg-glass-highlight-bottom: rgba(2, 6, 23, 0.55);
				            --lg-glass-shadow: 0 24px 90px rgba(0, 0, 0, 0.50);
				            --lg-surface-glass: var(--lg-glass-surface);
				            --lg-surface-semi: var(--lg-glass-surface-2);
				            --lg-surface-solid: var(--bg-dark);
				            --lg-surface-ghost: rgba(255, 255, 255, 0.03);
				            --overlay-scrim: rgba(0, 0, 0, 0.55);
				            --text-on-accent: #ffffff;
				            --indigo: #6366f1;
				            --warning-dark: #d97706;
				            --warning-ink: #fbbf24;
				            --donate-pink-1: #ffb6c1;
				            --donate-pink-2: #ff91a4;
				            --donate-pink-3: #ff8fab;
				            --donate-pink-ink: #ff6987;
				            --donate-gradient: linear-gradient(135deg, var(--donate-pink-1) 0%, var(--donate-pink-2) 50%, var(--donate-pink-3) 100%);
				            --donate-shadow: 0 6px 20px color-mix(in srgb, var(--donate-pink-2) 35%, transparent),
				                             0 0 20px color-mix(in srgb, var(--donate-pink-2) 25%, transparent);
				            --donate-shadow-hover: 0 8px 25px color-mix(in srgb, var(--donate-pink-2) 45%, transparent),
				                                   0 0 30px color-mix(in srgb, var(--donate-pink-2) 35%, transparent);
				            --qr-surface: #ffffff;
				            --shadow-modal: 0 20px 60px rgba(0, 0, 0, 0.45);
				            --shadow-text: 0 1px 2px rgba(0, 0, 0, 0.45);
				            --heatmap-surface: var(--lg-surface-semi);
				            --heatmap-border: var(--lg-glass-border);
				            --heatmap-shadow: var(--shadow-sm);
				            --heatmap-tile-overlay: rgba(2, 6, 23, 0.38);
				            --heatmap-tile-overlay-hover: rgba(2, 6, 23, 0.28);
				            --heatmap-text-positive: var(--text-on-accent);
				            --heatmap-text-negative: var(--text-on-accent);
				            --heatmap-text-neutral: var(--text-primary);
					            --heatmap-bg-positive: var(--success);
					            --heatmap-bg-negative: var(--danger);
					            --heatmap-text-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
					            --chart-up: rgba(16, 185, 129, 0.95);
					            --chart-down: rgba(239, 68, 68, 0.95);
					            --chart-up-soft: rgba(16, 185, 129, 0.45);
					            --chart-down-soft: rgba(239, 68, 68, 0.45);
					            --chart-up-mid: rgba(16, 185, 129, 0.70);
					            --chart-down-mid: rgba(239, 68, 68, 0.70);
					            --chart-wick: rgba(226, 232, 240, 0.55);
					            --chart-level-support: rgba(16, 185, 129, 0.92);
					            --chart-level-resist: rgba(239, 68, 68, 0.92);
					            --heatmap-cell-bg: var(--lg-surface-semi);

			            --bg-dark: #070b17;
		            --bg-card: var(--lg-glass-surface-2);
		            --bg-hover: rgba(148, 163, 184, 0.12);
		            --text-primary: #f8fafc;
		            --text-secondary: #b6c2d2;
		            --border-color: var(--lg-glass-border);
		            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.35);
		            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.45);
		            --shadow-lg: 0 24px 90px rgba(0, 0, 0, 0.50);

			            --glass-bg: var(--lg-glass-surface);
			            --glass-border: var(--lg-glass-border);
			            --glass-shadow: var(--lg-glass-shadow);
			            --blur-amount: var(--lg-blur);

			            /* Motion (moderate) */
			            --motion-fast: 120ms;
			            --motion-med: 180ms;
			            --motion-slow: 260ms;
			            --motion-ease: cubic-bezier(0.2, 0.8, 0.2, 1);
			            --motion-ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
			        }

			        :root {
		            /* Colors */
		            --primary: #3b82f6;
	            --primary-light: #60a5fa;
	            --primary-dark: #2563eb;
	            --success: #10b981;
	            --danger: #ef4444;
	            --warning: #f59e0b;
	            --info: #06b6d4;
		            --purple: #8b5cf6;
		            --chart-up: rgba(16, 185, 129, 0.95);
		            --chart-down: rgba(239, 68, 68, 0.95);
		            --chart-up-soft: rgba(16, 185, 129, 0.45);
		            --chart-down-soft: rgba(239, 68, 68, 0.45);
		            --chart-up-mid: rgba(16, 185, 129, 0.70);
		            --chart-down-mid: rgba(239, 68, 68, 0.70);
		            --chart-wick: rgba(15, 23, 42, 0.35);
		            --chart-level-support: rgba(16, 185, 129, 0.92);
		            --chart-level-resist: rgba(239, 68, 68, 0.92);
		            --heatmap-cell-bg: var(--lg-surface-semi);

				            /* Liquid Glass (Light) */
			            --lg-radius-card: 20px;
				            --lg-blur: 8px;
				            --lg-glass-surface: rgba(255, 255, 255, 0.55);
				            --lg-glass-surface-2: rgba(255, 255, 255, 0.82);
				            --lg-glass-border: rgba(15, 23, 42, 0.08);
				            --lg-glass-highlight-top: rgba(255, 255, 255, 0.55);
				            --lg-glass-highlight-bottom: rgba(2, 6, 23, 0.10);
				            --lg-glass-shadow: 0 20px 70px rgba(2, 6, 23, 0.12);
			            --lg-surface-glass: var(--lg-glass-surface);
			            --lg-surface-semi: var(--lg-glass-surface-2);
			            --lg-surface-solid: #ffffff;
			            --lg-surface-ghost: rgba(15, 23, 42, 0.03);
			            --overlay-scrim: rgba(15, 23, 42, 0.45);
			            --text-on-accent: #ffffff;
			            --indigo: #6366f1;
			            --warning-dark: #d97706;
			            --warning-ink: #92400e;
			            --donate-pink-1: #ffb6c1;
			            --donate-pink-2: #ff91a4;
			            --donate-pink-3: #ff8fab;
			            --donate-pink-ink: #ff6987;
			            --donate-gradient: linear-gradient(135deg, var(--donate-pink-1) 0%, var(--donate-pink-2) 50%, var(--donate-pink-3) 100%);
			            --donate-shadow: 0 6px 20px color-mix(in srgb, var(--donate-pink-2) 28%, transparent),
			                             0 0 20px color-mix(in srgb, var(--donate-pink-2) 20%, transparent);
			            --donate-shadow-hover: 0 8px 25px color-mix(in srgb, var(--donate-pink-2) 38%, transparent),
			                                   0 0 30px color-mix(in srgb, var(--donate-pink-2) 28%, transparent);
			            --qr-surface: #ffffff;
			            --shadow-modal: 0 20px 60px rgba(2, 6, 23, 0.18);
			            --shadow-text: 0 1px 2px rgba(2, 6, 23, 0.12);
			            --heatmap-surface: var(--lg-surface-semi);
			            --heatmap-border: var(--lg-glass-border);
			            --heatmap-shadow: var(--shadow-sm);
			            --heatmap-tile-overlay: rgba(255, 255, 255, 0.28);
			            --heatmap-tile-overlay-hover: rgba(255, 255, 255, 0.20);
			            --heatmap-text-positive: var(--text-primary);
			            --heatmap-text-negative: var(--text-on-accent);
			            --heatmap-text-neutral: var(--text-primary);
			            --heatmap-bg-positive: color-mix(in srgb, var(--success) 80%, #000 20%);
			            --heatmap-bg-negative: color-mix(in srgb, var(--danger) 80%, #000 20%);
			            --heatmap-text-shadow: 0 0 3px rgba(0, 0, 0, 0.4);

		            /* Light Theme */
		            --bg-dark: #f1f5f9;
		            --bg-card: var(--lg-glass-surface-2);
		            --bg-hover: rgba(15, 23, 42, 0.05);
		            --text-primary: #0f172a;
		            --text-secondary: #334155;
		            --border-color: var(--lg-glass-border);
		            --shadow-sm: 0 1px 2px rgba(2, 6, 23, 0.08);
		            --shadow-md: 0 8px 24px rgba(2, 6, 23, 0.10);
		            --shadow-lg: 0 18px 60px rgba(2, 6, 23, 0.12);

	            /* Gradients */
	            --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	            --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
	            --gradient-red: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
	            --gradient-purple: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	            --gradient-glass: linear-gradient(180deg, rgba(255, 255, 255, 0.16) 0%, rgba(255, 255, 255, 0.06) 100%);

	            /* Legacy aliases (wired to Liquid Glass tokens) */
	            --glass-bg: var(--lg-glass-surface);
	            --glass-border: var(--lg-glass-border);
	            --glass-shadow: var(--lg-glass-shadow);
	            --blur-amount: var(--lg-blur);

	            /* Motion (moderate) */
	            --motion-fast: 120ms;
	            --motion-med: 180ms;
	            --motion-slow: 260ms;
	            --motion-ease: cubic-bezier(0.2, 0.8, 0.2, 1);
	            --motion-ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
	        }

	        body {
	            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
	            background: var(--bg-dark);
	            color: var(--text-primary);
	            line-height: 1.6;
	            overflow-x: hidden;
	            transition: background-color var(--motion-slow) var(--motion-ease),
	                        color var(--motion-slow) var(--motion-ease);
	        }

	        html { font-size: 16px; }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-blue);
            opacity: 0.05;
            z-index: -1;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 0.05; transform: scale(1); }
            50% { opacity: 0.08; transform: scale(1.1); }
        }

        /* Layout - 3 Columns: Index | Content | Section */
        .dashboard {
            display: grid;
            grid-template-columns: 240px 1fr 280px;
            min-height: 100vh;
            gap: 0;
            transition: background-color var(--motion-slow) var(--motion-ease);
        }

        /* Glassmorphism Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
            box-shadow: var(--lg-glass-shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

	        .theme-toggle:hover {
	            transform: scale(1.1) rotate(15deg);
	            box-shadow: 0 12px 40px color-mix(in srgb, var(--primary) 35%, transparent);
	        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .mobile-menu-fab {
            position: fixed;
            right: calc(14px + env(safe-area-inset-right, 0px));
            bottom: calc(14px + env(safe-area-inset-bottom, 0px));
            z-index: 9000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px 14px;
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
            font-weight: 900;
            letter-spacing: 0.2px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            transition: transform var(--motion-fast) var(--motion-ease),
                        box-shadow var(--motion-fast) var(--motion-ease),
                        border-color var(--motion-fast) var(--motion-ease),
                        background-color var(--motion-fast) var(--motion-ease),
                        opacity var(--motion-fast) var(--motion-ease);
        }

        .mobile-menu-fab:hover {
            box-shadow: var(--shadow-md), 0 0 0 2px color-mix(in srgb, var(--primary) 22%, transparent);
            border-color: color-mix(in srgb, var(--primary) 35%, var(--lg-glass-border));
        }

        .mobile-menu-fab:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: var(--shadow-sm);
        }

        /* Sidebar with Glassmorphism */
        .sidebar {
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
            padding: 20px 0;
            overflow-y: auto;
            height: 100vh;
            position: sticky;
            top: 0;
            box-shadow: var(--lg-glass-shadow);
            transition: border-color var(--motion-slow) var(--motion-ease),
                        box-shadow var(--motion-slow) var(--motion-ease),
                        background-color var(--motion-slow) var(--motion-ease);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .sidebar-header .date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .plan-toggle {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            padding: 10px;
            border-radius: 14px;
            background: var(--lg-surface-ghost);
            border: 1px solid var(--lg-glass-border);
        }

        .plan-btn {
            flex: 1;
            appearance: none;
            -webkit-appearance: none;
            border: 1px solid var(--lg-glass-border);
            background: var(--lg-surface-semi);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 8px 10px;
            font-weight: 900;
            font-size: 0.82rem;
            cursor: pointer;
            transition: transform var(--motion-med) var(--motion-ease),
                        box-shadow var(--motion-med) var(--motion-ease),
                        border-color var(--motion-med) var(--motion-ease),
                        background-color var(--motion-med) var(--motion-ease),
                        color var(--motion-med) var(--motion-ease);
        }

        .plan-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
            border-color: color-mix(in srgb, var(--lg-glass-border) 60%, var(--text-primary) 10%);
        }

        .plan-btn.active {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 55%, var(--primary-light) 100%);
            border-color: var(--primary-light);
            color: var(--text-on-accent);
            box-shadow: 0 14px 34px color-mix(in srgb, var(--primary) 34%, transparent);
        }

        .plan-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 22%, transparent);
        }

        .plan-note {
            margin-top: 8px;
            font-size: 0.74rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .plan-chooser {
            display: grid;
            gap: 12px;
        }

        .plan-choice-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        @media (max-width: 520px) {
            .plan-choice-grid { grid-template-columns: 1fr; }
        }

        .plan-choice-card {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-semi);
            color: var(--text-primary);
            text-align: left;
            padding: 14px 14px;
            cursor: pointer;
            transition: transform var(--motion-med) var(--motion-ease),
                        box-shadow var(--motion-med) var(--motion-ease),
                        border-color var(--motion-med) var(--motion-ease),
                        background-color var(--motion-med) var(--motion-ease);
        }

        .plan-choice-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
        }

        .plan-choice-card:focus-visible {
            outline: none;
            box-shadow: var(--shadow-md), 0 0 0 3px color-mix(in srgb, var(--primary) 22%, transparent);
            border-color: color-mix(in srgb, var(--primary) 45%, var(--lg-glass-border));
        }

        .plan-choice-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .plan-choice-title {
            font-weight: 950;
            letter-spacing: 0.2px;
            font-size: 1rem;
        }

        .plan-choice-badge {
            font-size: 0.78rem;
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--lg-glass-border);
            background: var(--lg-surface-ghost);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .plan-choice-badge.pro {
            background: color-mix(in srgb, var(--primary) 12%, transparent);
            border-color: color-mix(in srgb, var(--primary) 30%, var(--lg-glass-border));
            color: var(--text-primary);
        }

        .plan-choice-desc {
            margin-top: 10px;
            color: var(--text-secondary);
            font-weight: 800;
            line-height: 1.55;
            font-size: 0.9rem;
        }

        .plan-choice-foot {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .plan-choice-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--lg-glass-border);
            background: var(--lg-surface-ghost);
            color: var(--text-secondary);
            font-weight: 900;
            font-size: 0.78rem;
        }

        .plan-choice-pill.ok { color: var(--success); border-color: color-mix(in srgb, var(--success) 35%, var(--lg-glass-border)); }
        .plan-choice-pill.lock { color: var(--warning); border-color: color-mix(in srgb, var(--warning) 35%, var(--lg-glass-border)); }

        .plan-pass {
            display: grid;
            gap: 12px;
        }

        .plan-pass-label {
            color: var(--text-secondary);
            font-weight: 900;
            font-size: 0.82rem;
            letter-spacing: 0.2px;
        }

        .plan-pass-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 520px) {
            .plan-pass-row { grid-template-columns: 1fr; }
        }

        .plan-pass-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--lg-surface-semi);
            border: 1px solid var(--lg-glass-border);
            border-radius: 14px;
            color: var(--text-primary);
            font-weight: 850;
            letter-spacing: 0.2px;
            transition: border-color var(--motion-med) var(--motion-ease),
                        box-shadow var(--motion-med) var(--motion-ease),
                        background-color var(--motion-med) var(--motion-ease);
        }

        .plan-pass-input::placeholder { color: color-mix(in srgb, var(--text-secondary) 75%, transparent); }

        .plan-pass-input:focus {
            outline: none;
            border-color: color-mix(in srgb, var(--primary) 55%, var(--lg-glass-border));
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 22%, transparent);
            background: color-mix(in srgb, var(--lg-surface-semi) 80%, var(--lg-surface-ghost));
        }

        .plan-pass-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .plan-pass-hint {
            color: var(--text-secondary);
            font-weight: 800;
            font-size: 0.82rem;
            line-height: 1.5;
        }

        .plan-pass-error {
            color: var(--danger);
            font-weight: 900;
            font-size: 0.84rem;
        }

        .search-box {
            padding: 0 20px 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

	        .search-input:focus {
	            outline: none;
	            border-color: var(--primary);
	            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 22%, transparent);
	            background: var(--bg-card);
	        }

        .index-list {
            padding: 0 10px;
        }

	        .index-item {
	            padding: 14px 16px;
	            margin: 4px 0;
	            border-radius: var(--lg-radius-card);
	            cursor: pointer;
	            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	            background: var(--lg-surface-semi);
	            border: 1px solid var(--lg-glass-border);
	            box-shadow: 0 6px 18px color-mix(in srgb, var(--primary-dark) 18%, transparent);
	            font-weight: 500;
	            font-size: 0.9rem;
	            position: relative;
	            overflow: hidden;
	        }

	        .index-item::before {
	            content: '';
	            position: absolute;
	            left: 0;
	            top: 0;
	            width: 3px;
	            height: 100%;
	            background: var(--primary);
	            transform: scaleY(0);
	            transition: transform 0.3s ease;
	        }

	        .index-item:hover {
	            background: var(--lg-surface-semi);
	            background: color-mix(in srgb, var(--lg-surface-semi) 70%, var(--primary) 30%);
	            border-color: color-mix(in srgb, var(--lg-glass-border) 55%, var(--primary-light) 45%);
	            box-shadow: 0 10px 26px color-mix(in srgb, var(--primary-dark) 22%, transparent);
	            transform: translateX(4px);
	        }

        .index-item:hover::before {
            transform: scaleY(1);
        }

		        .index-item.active {
		            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 55%, var(--primary-light) 100%);
		            border-color: var(--primary-light);
		            color: var(--text-on-accent);
		            box-shadow: 0 14px 34px color-mix(in srgb, var(--primary) 34%, transparent);
		            transform: translateX(4px);
		        }

		        .index-item.active::before {
		            transform: scaleY(1);
		            background: var(--text-on-accent);
		        }

        /* Section Navigation Sidebar (Column 3 - Right) */
	        .section-nav {
	            background: var(--lg-surface-glass);
	            border: 1px solid var(--lg-glass-border);
	            border-radius: var(--lg-radius-card);
	            backdrop-filter: blur(var(--lg-blur));
	            -webkit-backdrop-filter: blur(var(--lg-blur));
	            padding: 20px 0;
	            overflow-y: auto;
	            height: 100vh;
	            position: sticky;
	            top: 0;
	            box-shadow: var(--lg-glass-shadow);
	            transition: border-color var(--motion-slow) var(--motion-ease),
	                        box-shadow var(--motion-slow) var(--motion-ease),
	                        background-color var(--motion-slow) var(--motion-ease);
	        }

        .section-nav-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .section-nav-header h3 {
            font-size: 1rem;
            font-weight: 700;
            background: var(--gradient-purple);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .section-nav-header .subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-list {
            padding: 0 10px;
        }

	        .section-item {
	            padding: 12px 16px;
	            margin: 4px 0;
	            border-radius: var(--lg-radius-card);
	            cursor: pointer;
	            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	            background: var(--lg-surface-semi);
	            border: 1px solid var(--lg-glass-border);
	            box-shadow: 0 6px 18px color-mix(in srgb, var(--primary-dark) 18%, transparent);
	            font-weight: 500;
	            font-size: 0.85rem;
	            position: relative;
	            overflow: hidden;
	            display: flex;
	            align-items: center;
	            gap: 10px;
	        }

        .section-item .icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .section-item .title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

	        .section-item::before {
	            content: '';
	            position: absolute;
	            right: 0;
	            top: 0;
	            width: 3px;
	            height: 100%;
	            background: var(--primary);
	            transform: scaleY(0);
	            transition: transform 0.3s ease;
	        }

	        .section-item:hover {
	            background: var(--lg-surface-semi);
	            background: color-mix(in srgb, var(--lg-surface-semi) 70%, var(--primary) 30%);
	            border-color: color-mix(in srgb, var(--lg-glass-border) 55%, var(--primary-light) 45%);
	            box-shadow: 0 10px 26px color-mix(in srgb, var(--primary-dark) 22%, transparent);
	            transform: translateX(-4px);
	        }

        .section-item:hover::before {
            transform: scaleY(1);
        }

		        .section-item.active {
		            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 55%, var(--primary-light) 100%);
		            border-color: var(--primary-light);
		            color: var(--text-on-accent);
		            box-shadow: 0 14px 34px color-mix(in srgb, var(--primary) 34%, transparent);
		            transform: translateX(-4px);
		        }

		        .section-item.active::before {
		            transform: scaleY(1);
		            background: var(--text-on-accent);
		        }

	        .section-item.whatif {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--warning) 16%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 8%, transparent) 100%
	            );
	            border: 1px solid color-mix(in srgb, var(--warning) 35%, transparent);
	        }

	        .section-item.whatif.active {
	            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
	            border-color: var(--warning);
	        }

	        .section-item.whatif .icon {
	            color: var(--warning-dark);
	        }

	        .section-item.whatif.active .icon {
	            color: var(--text-on-accent);
	        }

        /* CONCLUSION SECTION - Highlight in section list */
	        .section-item.conclusion-section {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--indigo) 18%, transparent) 0%,
	                color-mix(in srgb, var(--purple) 14%, transparent) 100%
	            );
	            border: 2px solid color-mix(in srgb, var(--purple) 45%, transparent);
	            border-left: 5px solid var(--purple);
	            box-shadow: 0 4px 16px color-mix(in srgb, var(--purple) 25%, transparent);
	        }

	        .section-item.conclusion-section .icon {
	            font-size: 1.3rem;
	            color: var(--purple);
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--purple) 18%, transparent) 0%,
	                color-mix(in srgb, var(--indigo) 14%, transparent) 100%
	            );
	            animation: iconPulse 2s ease-in-out infinite;
	        }

        .section-item.conclusion-section .title {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
        }

	        .section-item.conclusion-section:hover {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--indigo) 28%, transparent) 0%,
	                color-mix(in srgb, var(--purple) 20%, transparent) 100%
	            );
	            box-shadow: 0 6px 20px color-mix(in srgb, var(--purple) 35%, transparent);
	            transform: translateX(-4px) scale(1.02);
	        }

	        .section-item.conclusion-section.active {
	            background: linear-gradient(135deg, var(--purple) 0%, var(--indigo) 100%);
	            color: var(--text-on-accent);
	            border-color: var(--purple);
	            box-shadow: 0 8px 24px color-mix(in srgb, var(--purple) 50%, transparent);
	        }

	        .section-item.conclusion-section.active .icon {
	            color: var(--text-on-accent);
	            background: color-mix(in srgb, var(--text-on-accent) 20%, transparent);
	        }

	        .section-item.conclusion-section.active .title {
	            color: var(--text-on-accent);
	        }

        .no-sections {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            overflow-y: auto;
            height: 100vh;
        }

        .page-header {
            margin-bottom: 30px;
            position: relative;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInUp 0.6s ease;
        }

        .last-update {
            font-size: 0.85rem;
            color: var(--text-secondary);
            animation: fadeInUp 0.6s ease 0.1s backwards;
        }

        /* Donate Button - Cute & Friendly */
	        .donate-btn {
	            margin-top: 15px;
	            padding: 12px 28px;
	            background: var(--donate-gradient);
	            color: var(--text-on-accent);
	            border: none;
	            border-radius: 50px;
	            font-size: 1rem;
	            font-weight: 600;
	            cursor: pointer;
	            box-shadow: var(--donate-shadow);
	            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	            animation: fadeInUp 0.6s ease 0.2s backwards, pulse-glow 2s ease-in-out infinite;
	            position: relative;
	            overflow: hidden;
	        }

	        .donate-btn::before {
	            content: '';
	            position: absolute;
	            top: -50%;
	            left: -50%;
	            width: 200%;
	            height: 200%;
	            background: linear-gradient(45deg, transparent, color-mix(in srgb, var(--text-on-accent) 35%, transparent), transparent);
	            transform: rotate(45deg);
	            animation: shimmer 3s infinite;
	        }

	        .donate-btn:hover {
	            transform: translateY(-3px) scale(1.05);
	            box-shadow: var(--donate-shadow-hover);
	        }

        .donate-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .donate-footer {
            display: none;
            margin-top: 18px;
            padding: 0 12px calc(28px + env(safe-area-inset-bottom, 0px));
            justify-content: center;
        }

        .donate-footer .donate-btn {
            width: min(520px, 100%);
        }

		        @keyframes pulse-glow {
		            0%, 100% { box-shadow: var(--donate-shadow); }
		            50% { box-shadow: var(--donate-shadow-hover); }
		        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Metrics Grid with Glassmorphism */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--lg-surface-semi);
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--lg-glass-shadow);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease backwards;
        }

        .metric-card:nth-child(1) { animation-delay: 0.1s; }
        .metric-card:nth-child(2) { animation-delay: 0.2s; }
        .metric-card:nth-child(3) { animation-delay: 0.3s; }
        .metric-card:nth-child(4) { animation-delay: 0.4s; }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-blue);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

	        .metric-card:hover {
	            transform: translateY(-4px);
	            box-shadow: 0 16px 40px color-mix(in srgb, var(--primary) 25%, transparent);
	        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .metric-card.positive::before {
            background: var(--gradient-green);
        }

        .metric-card.negative::before {
            background: var(--gradient-red);
        }

        .metric-card .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-card .change {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }

	        .metric-card .change.positive {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--success) 20%, transparent) 0%,
	                color-mix(in srgb, var(--success) 10%, transparent) 100%
	            );
	            color: var(--success);
	        }

	        .metric-card .change.negative {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--danger) 20%, transparent) 0%,
	                color-mix(in srgb, var(--danger) 10%, transparent) 100%
	            );
	            color: var(--danger);
	        }

        /* Section Cards with Glassmorphism */
        .sections-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-card {
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--lg-glass-shadow);
            animation: fadeInUp 0.6s ease backwards;
        }

	        .section-card:hover {
	            transform: translateY(-2px);
	            box-shadow: 0 16px 40px color-mix(in srgb, var(--primary) 20%, transparent);
	        }

        .section-card.alert {
            border-left: 4px solid var(--warning);
        }

        .section-header {
            padding: 24px 28px;
            background: var(--gradient-glass);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
        }

	        .section-header:hover {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--primary) 10%, transparent) 0%,
	                color-mix(in srgb, var(--primary) 5%, transparent) 100%
	            );
	        }

        .section-header .title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

	        .section-header .arrow {
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px;
            border-radius: 50%;
	            background: var(--lg-surface-ghost);
	        }

	        .section-card.expanded .section-header .arrow {
	            transform: rotate(180deg);
	            background: color-mix(in srgb, var(--primary) 20%, transparent);
	            color: var(--primary);
	        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease;
            opacity: 0;
        }

        .section-card.expanded .section-content {
            max-height: 5000px;
            opacity: 1;
        }

        .whatif-card.expanded .section-content {
            max-height: 5000px;
            opacity: 1;
        }

	        .section-body {
	            padding: 28px;
	            background: var(--lg-surface-semi);
	            animation: fadeIn 0.4s ease;
	        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-blue);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Responsive */
	        @media (max-width: 768px) {
	            /* Mobile: make index + sections accessible (no hidden sidebar) */
	            .dashboard {
	                display: flex;
	                flex-direction: column;
	                gap: 12px;
	                padding: 12px;
	                min-height: auto;
	            }

	            /* Mobile: hide heatmaps (space constrained) */
	            .heatmap-block,
	            .heatmap-index-grid,
	            .heatmap-table {
	                display: none !important;
	            }

		            /* Mobile: reduce background animation repaints */
		            body::before { animation: none; }

		            /* Mobile: reduce blur cost */
		            :root { --lg-blur: 6px; }
		            [data-theme="dark"] { --lg-blur: 6px; }

		            /* Mobile: reduce long-running animations */
		            .section-item.conclusion-section .icon { animation: none; }
		            .donate-btn { animation: none; }
		            .donate-btn::before { animation: none; }

		            .mobile-menu-fab {
		                display: inline-flex;
		                right: 12px;
		                bottom: 84px;
	            }

	            @supports (right: max(12px, env(safe-area-inset-right))) {
	                .mobile-menu-fab {
	                    right: max(12px, env(safe-area-inset-right));
	                    bottom: max(84px, env(safe-area-inset-bottom));
	                }
	            }

	            /* Mobile: hide empty-state instructions (index/section lists are already visible above) */
	            #emptyState {
	                display: none !important;
	                padding: 0 !important;
	            }

	            /* Mobile: keep donate CTA at the bottom, not in the header */
	            .page-header .donate-btn {
	                display: none;
	            }

	            .donate-footer {
	                display: flex;
	            }

	            .sidebar,
	            .section-nav {
	                display: block;
	                position: relative;
	                top: auto;
                height: auto;
                overflow: visible;
            }

            .sidebar {
                padding: 14px 0;
            }

            .section-nav {
                padding: 14px 0;
            }

	            /* Put section list above content for faster flow: pick index â†’ pick section â†’ read */
	            .sidebar { order: 1; }
	            .section-nav { order: 2; }
	            .main-content { order: 3; }

	            /* Mobile reading mode: after picking a section, focus only on content */
	            body.mobile-reading .sidebar,
	            body.mobile-reading .section-nav {
	                display: none;
	            }

	            body.mobile-reading .main-content {
	                order: 1;
	            }

	            /* Avoid nested 100vh scrolling containers on iOS */
	            .main-content {
	                height: auto;
	                overflow: visible;
                padding: 16px;
            }

            .index-list,
            #sectionList {
                max-height: 52vh;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

	            .theme-toggle {
	                width: 45px;
	                height: 45px;
	                font-size: 1.3rem;
	                top: 12px;
	                right: 12px;
	            }

	            @supports (right: max(12px, env(safe-area-inset-right))) {
	                .theme-toggle {
	                    top: max(12px, env(safe-area-inset-top));
	                    right: max(12px, env(safe-area-inset-right));
	                }
	            }
	        }

        /* Additional utility styles from V2 */
        .content-paragraph {
            color: var(--text-secondary);
            line-height: 1.7;
            margin: 12px 0;
            font-size: 0.95rem;
        }

        .percentage {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            margin: 0 4px;
        }

	        .percentage.bullish {
	            background: color-mix(in srgb, var(--success) 20%, transparent);
	            color: var(--success);
	        }

	        .percentage.bearish {
	            background: color-mix(in srgb, var(--danger) 20%, transparent);
	            color: var(--danger);
	        }

        .metric-number {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--text-primary);
            padding: 0 4px;
        }

        /* Indicator Container */
        .indicator-container {
            margin: 10px 0;
            padding: 12px;
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Formatted Lists */
        .formatted-list {
            margin: 20px 0;
        }

        .list-item {
            padding: 12px 0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

	        .list-number {
	            background: var(--gradient-blue);
	            color: var(--text-on-accent);
	            min-width: 28px;
	            height: 28px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .list-content {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.9rem;
        }

        .list-header {
            font-weight: 700;
            color: var(--text-primary);
            background: var(--bg-hover);
            padding: 6px 12px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            display: inline-block;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        /* Section Boxes */
        .conclusion-box,
        .evidence-box,
        .conditions-box,
        .action-box,
        .risk-box,
        .levels-box,
        .scenario-box,
        .confidence-box,
        .metrics-box,
        .hero-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            margin: 16px 0;
        }

        /* CONCLUSION BOX - Enhanced prominence */
	        .conclusion-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--indigo) 18%, transparent) 0%,
	                color-mix(in srgb, var(--purple) 14%, transparent) 100%
	            );
	            border: 2px solid color-mix(in srgb, var(--indigo) 30%, transparent);
	            border-left: 6px solid var(--purple);
	            box-shadow: 0 4px 20px color-mix(in srgb, var(--purple) 22%, transparent),
	                        0 0 40px color-mix(in srgb, var(--purple) 12%, transparent);
	            position: relative;
	            overflow: hidden;
	            animation: conclusionGlow 3s ease-in-out infinite;
	        }

        /* Animated gradient overlay */
	        .conclusion-box::before {
	            content: '';
	            position: absolute;
	            top: 0;
	            left: -100%;
	            width: 100%;
	            height: 100%;
	            background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--text-on-accent) 10%, transparent), transparent);
	            animation: conclusionShine 4s ease-in-out infinite;
	        }

	        @keyframes conclusionGlow {
	            0%, 100% {
	                box-shadow: 0 4px 20px color-mix(in srgb, var(--purple) 22%, transparent),
	                            0 0 40px color-mix(in srgb, var(--purple) 12%, transparent);
	            }
	            50% {
	                box-shadow: 0 4px 25px color-mix(in srgb, var(--purple) 30%, transparent),
	                            0 0 50px color-mix(in srgb, var(--purple) 18%, transparent);
	            }
	        }

        @keyframes conclusionShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

	        .conclusion-box .conclusion-icon {
	            font-size: 1.8rem;
	            width: 48px;
	            height: 48px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 12px;
	            background: linear-gradient(135deg, var(--purple) 0%, var(--indigo) 100%);
	            color: var(--text-on-accent);
	            flex-shrink: 0;
	            box-shadow: 0 4px 12px color-mix(in srgb, var(--purple) 30%, transparent);
	            animation: iconPulse 2s ease-in-out infinite;
	        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

	        .conclusion-box .conclusion-text {
	            font-size: 1.05rem;
	            font-weight: 700;
	            color: var(--primary);
	            line-height: 1.6;
	            text-shadow: var(--shadow-text);
	        }

        /* EVIDENCE BOX - Keep moderate styling */
	        .evidence-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--success) 12%, transparent) 0%,
	                color-mix(in srgb, var(--success) 6%, transparent) 100%
	            );
	            border-left: 5px solid var(--success);
	        }

	        .evidence-box .evidence-icon {
            font-size: 1.4rem;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--success) 20%, transparent) 0%,
	                color-mix(in srgb, var(--success) 10%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

        .evidence-box .evidence-text {
            font-weight: 600;
            color: var(--success);
        }

        /* CONDITIONS BOX - Warning style */
	        .conditions-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--warning) 12%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 6%, transparent) 100%
	            );
	            border-left: 5px solid var(--warning);
	        }

	        .conditions-box .conditions-icon {
            font-size: 1.4rem;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--warning) 20%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 10%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

        .conditions-box .conditions-text {
            font-weight: 600;
            color: var(--warning);
        }

        /* ACTION BOX - recommendations & next steps */
	        .action-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--primary) 14%, transparent) 0%,
	                color-mix(in srgb, var(--indigo) 10%, transparent) 100%
	            );
	            border-left: 5px solid var(--primary);
	        }

	        .action-box .action-icon {
	            font-size: 1.4rem;
	            width: 38px;
	            height: 38px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--primary) 22%, transparent) 0%,
	                color-mix(in srgb, var(--indigo) 12%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

	        .action-box .action-text {
	            font-weight: 650;
	            color: var(--text-primary);
	        }

        /* RISK BOX - warnings, stop-loss, black swan */
	        .risk-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--danger) 14%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 8%, transparent) 100%
	            );
	            border-left: 5px solid var(--danger);
	        }

	        .risk-box .risk-icon {
	            font-size: 1.4rem;
	            width: 38px;
	            height: 38px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--danger) 22%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 12%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

	        .risk-box .risk-text {
	            font-weight: 650;
	            color: var(--danger);
	        }

        /* LEVELS BOX - support/resistance, MA/VWAP/POC */
	        .levels-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--primary) 10%, transparent) 0%,
	                color-mix(in srgb, var(--text-primary) 4%, transparent) 100%
	            );
	            border-left: 5px solid color-mix(in srgb, var(--primary) 65%, transparent);
	        }

	        .levels-box .levels-icon {
	            font-size: 1.4rem;
	            width: 38px;
	            height: 38px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--primary) 20%, transparent) 0%,
	                color-mix(in srgb, var(--primary-light) 12%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

	        .levels-box .levels-text {
	            font-weight: 650;
	            color: var(--text-primary);
	        }

        /* SCENARIO BOX - what-if + probabilities */
	        .scenario-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--indigo) 14%, transparent) 0%,
	                color-mix(in srgb, var(--purple) 10%, transparent) 100%
	            );
	            border-left: 5px solid var(--indigo);
	        }

	        .scenario-box .scenario-icon {
	            font-size: 1.4rem;
	            width: 38px;
	            height: 38px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--indigo) 22%, transparent) 0%,
	                color-mix(in srgb, var(--purple) 14%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

	        .scenario-box .scenario-text {
	            font-weight: 650;
	            color: var(--text-primary);
	        }

        /* CONFIDENCE BOX - confidence/quality badges */
	        .confidence-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--success) 12%, transparent) 0%,
	                color-mix(in srgb, var(--success) 6%, transparent) 100%
	            );
	            border-left: 5px solid var(--success);
	        }

	        .confidence-box .confidence-icon {
	            font-size: 1.4rem;
	            width: 38px;
	            height: 38px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 10px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--success) 20%, transparent) 0%,
	                color-mix(in srgb, var(--success) 10%, transparent) 100%
	            );
	            flex-shrink: 0;
	        }

	        .confidence-box .confidence-text {
	            font-weight: 650;
	            color: var(--success);
	        }

        /* METRICS BOX - A/D, TRIN, Volume Ratio snapshot */
	        .metrics-box {
	            background: color-mix(in srgb, var(--lg-surface-ghost) 70%, transparent 30%);
	            border: 1px solid var(--lg-glass-border);
	            box-shadow: var(--shadow-sm);
	        }

	        .metrics-box .metrics-icon {
	            font-size: 1.4rem;
	            width: 38px;
	            height: 38px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 10px;
	            background: color-mix(in srgb, var(--lg-surface-semi) 65%, transparent);
	            flex-shrink: 0;
	        }

	        .metrics-box .metrics-text {
	            font-weight: 650;
	            color: var(--text-primary);
	        }

        /* HERO BOX - one-line high-signal headline */
	        .hero-box {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--indigo) 18%, transparent) 0%,
	                color-mix(in srgb, var(--primary) 10%, transparent) 100%
	            );
	            border: 1px solid color-mix(in srgb, var(--indigo) 30%, transparent);
	            box-shadow: 0 12px 40px color-mix(in srgb, var(--indigo) 16%, transparent);
	        }

	        .hero-box .hero-icon {
	            font-size: 1.5rem;
	            width: 40px;
	            height: 40px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: 12px;
	            background: linear-gradient(135deg, var(--indigo) 0%, var(--primary) 100%);
	            color: var(--text-on-accent);
	            flex-shrink: 0;
	        }

	        .hero-box .hero-text {
	            font-weight: 750;
	            color: var(--text-primary);
	            letter-spacing: 0.2px;
	        }

        /* Fallback for old class names */
        .conclusion-icon, .evidence-icon, .conditions-icon {
            font-size: 1.4rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-card);
            flex-shrink: 0;
        }

        /* Subsection Boxes */
        .subsection-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
            margin: 16px 0;
        }

	        .subsection-icon {
	            font-size: 1.3rem;
	            width: 32px;
	            height: 32px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            border-radius: var(--lg-radius-card);
	            background: var(--lg-surface-glass);
	            border: 1px solid var(--lg-glass-border);
	            backdrop-filter: blur(var(--lg-blur));
	            -webkit-backdrop-filter: blur(var(--lg-blur));
	            flex-shrink: 0;
	        }

        .subsection-header {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* MA Indicator */
	        .ma-indicator {
	            display: inline-block;
	            padding: 4px 12px;
	            background: color-mix(in srgb, var(--primary) 10%, transparent);
	            border-radius: 6px;
	            margin: 0 4px;
	        }

        .ma-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Momentum */
        .momentum {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            margin: 0 4px;
        }

	        .momentum.bullish {
	            background: color-mix(in srgb, var(--success) 20%, transparent);
	            color: var(--success);
	        }

	        .momentum.bearish {
	            background: color-mix(in srgb, var(--danger) 20%, transparent);
	            color: var(--danger);
	        }

        /* What-If Card */
        .whatif-card {
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--lg-glass-shadow);
        }

	        .whatif-card:hover {
	            box-shadow: 0 8px 24px color-mix(in srgb, var(--warning) 30%, transparent);
	            border-color: color-mix(in srgb, var(--warning) 50%, transparent);
	            transform: translateY(-2px);
	        }

	        .whatif-card-header {
	            padding: 20px 24px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--warning) 12%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 6%, transparent) 100%
	            );
	            cursor: pointer;
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	        }

	        .whatif-title {
	            font-size: 1.1rem;
	            font-weight: 700;
	            color: var(--warning-ink);
	            text-transform: uppercase;
	            letter-spacing: 0.3px;
	        }

	        .whatif-card .arrow {
	            font-size: 0.7rem;
	            color: var(--warning-ink);
	            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	            padding: 8px;
	            border-radius: 50%;
	            background: var(--lg-surface-ghost);
	        }

	        .whatif-card.expanded .arrow {
	            transform: rotate(180deg);
	            background: color-mix(in srgb, var(--warning) 30%, transparent);
	        }

        .whatif-card-body {
            padding: 24px;
            background: var(--lg-surface-semi);
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
        }

        /* Text Highlights */
        .text-success {
            color: var(--success);
            font-weight: 600;
        }

        .text-danger {
            color: var(--danger);
            font-weight: 600;
        }

        .text-warning {
            color: var(--warning);
            font-weight: 600;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
        }

	        .badge.warning {
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--warning) 20%, transparent) 0%,
	                color-mix(in srgb, var(--warning) 10%, transparent) 100%
	            );
	            color: var(--warning);
	        }

        /* Donate Modal Styles - Cute & Friendly */
	        .donate-modal {
	            display: none;
	            position: fixed;
	            z-index: 10000;
	            left: 0;
	            top: 0;
	            width: 100%;
	            height: 100%;
	            background-color: var(--overlay-scrim);
	            backdrop-filter: blur(var(--lg-blur));
	            animation: fadeIn 0.3s ease;
	        }

	        .donate-modal-content {
	            background: var(--lg-surface-solid);
	            margin: 3% auto;
	            padding: 40px 35px;
	            border-radius: var(--lg-radius-card);
	            width: 90%;
	            max-width: 550px;
	            box-shadow: var(--shadow-modal), 0 0 40px color-mix(in srgb, var(--donate-pink-2) 18%, transparent);
	            position: relative;
	            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
	            border: 1px solid var(--lg-glass-border);
	        }

	        .donate-close {
            position: absolute;
            right: 20px;
            top: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
	            background: color-mix(in srgb, var(--donate-pink-1) 20%, transparent);
	            border: none;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

	        .donate-close:hover {
	            background: color-mix(in srgb, var(--donate-pink-ink) 30%, transparent);
	            color: var(--donate-pink-ink);
	            transform: rotate(90deg) scale(1.1);
	        }

	        .donate-modal h2 {
            margin-bottom: 15px;
            font-size: 1.8rem;
	            background: linear-gradient(135deg, var(--donate-pink-2) 0%, var(--donate-pink-1) 100%);
	            -webkit-background-clip: text;
	            -webkit-text-fill-color: transparent;
	            background-clip: text;
	            text-align: center;
	        }

        .donate-intro {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-size: 0.95rem;
            line-height: 1.7;
        }

	        .donate-intro strong {
	            color: var(--donate-pink-2);
	            font-weight: 600;
	        }

        .donate-options {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

	        .donate-card {
            background: var(--lg-surface-solid);
            padding: 30px 25px;
            border-radius: var(--lg-radius-card);
            text-align: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--lg-glass-border);
	            box-shadow: 0 8px 25px color-mix(in srgb, var(--donate-pink-2) 16%, transparent);
	        }

	        .donate-card:hover {
	            transform: translateY(-8px) scale(1.02);
	            box-shadow: 0 15px 40px color-mix(in srgb, var(--donate-pink-2) 30%, transparent);
	            border-color: color-mix(in srgb, var(--donate-pink-2) 55%, transparent);
	        }

	        .donate-card h3 {
	            color: var(--donate-pink-ink);
	            margin-bottom: 18px;
	            font-size: 1.3rem;
	        }

	        .donate-card img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 15px auto;
            border-radius: 15px;
	            background: var(--qr-surface);
	            padding: 12px;
	            box-shadow: var(--shadow-sm);
	            transition: transform 0.3s;
	        }

        .donate-card:hover img {
            transform: scale(1.05);
        }

        .donate-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 8px 0;
        }

	        .donate-note {
            margin-top: 25px;
            padding: 20px;
	            background: linear-gradient(135deg,
	                color-mix(in srgb, var(--donate-pink-1) 22%, transparent) 0%,
	                color-mix(in srgb, var(--donate-pink-1) 14%, transparent) 100%
	            );
	            border-radius: 15px;
	            border: 2px dashed color-mix(in srgb, var(--donate-pink-1) 40%, transparent);
	            font-size: 0.9rem;
	            color: var(--text-secondary);
	            text-align: center;
	            line-height: 1.8;
	        }

	        .donate-note strong {
	            color: var(--donate-pink-ink);
	        }

        .donate-hearts {
            text-align: center;
            font-size: 1.5rem;
            margin-top: 10px;
            animation: heartbeat 1.5s ease infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(0.95); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Overview extras (inside `Tá»”NG QUAN THá»Š TRÆ¯á»œNG`) */
        .overview-extras {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

	        .overview-extras .block {
	            background: var(--lg-surface-semi);
	            border: 1px solid var(--lg-glass-border);
	            border-radius: var(--lg-radius-card);
	            overflow: hidden;
	            box-shadow: var(--lg-glass-shadow);
	            transition: transform var(--motion-med) var(--motion-ease),
	                        box-shadow var(--motion-med) var(--motion-ease),
	                        border-color var(--motion-med) var(--motion-ease),
	                        background-color var(--motion-med) var(--motion-ease);
	        }

	        .overview-extras .block:hover {
	            transform: translateY(-1px);
	            box-shadow: var(--shadow-md);
	            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
	        }

        .overview-extras .block-header {
            padding: 14px 16px;
            font-weight: 800;
            background: var(--gradient-glass);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

	        .block-expand {
	            border: 1px solid var(--glass-border);
	            background: color-mix(in srgb, var(--primary) 10%, transparent);
	            color: var(--text-primary);
	            border-radius: 999px;
	            padding: 6px 10px;
	            font-weight: 800;
	            cursor: pointer;
	            white-space: nowrap;
	        }

	        .block-expand:hover {
	            background: color-mix(in srgb, var(--primary) 16%, transparent);
	        }

        .overview-extras .block-body {
            padding: 14px 16px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th,
        .summary-table td {
            padding: 10px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.92rem;
            text-align: left;
        }

        .summary-table th {
            color: var(--text-secondary);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .summary-table td.right,
        .summary-table th.right {
            text-align: right;
            white-space: nowrap;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 800;
            font-size: 0.85rem;
            border: 1px solid var(--glass-border);
        }

	        .chip.positive {
	            color: var(--success);
	            background: color-mix(in srgb, var(--success) 15%, transparent);
	        }

	        .chip.negative {
	            color: var(--danger);
	            background: color-mix(in srgb, var(--danger) 15%, transparent);
	        }

	        .chip.neutral {
	            color: var(--text-secondary);
	            background: color-mix(in srgb, var(--text-secondary) 12%, transparent);
	        }

	        .heatmap-index-grid {
	            display: grid;
	            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
	            gap: 12px;
	            background: transparent;
	            border: 0;
	            border-radius: 0;
	            box-shadow: none;
	        }

	        [data-theme="dark"] .heatmap-index-grid {
	            background: transparent;
	            border-color: transparent;
	            box-shadow: none;
	        }

	        .heatmap-tile {
	            border-radius: var(--lg-radius-card);
	            border: 1px solid var(--lg-glass-border);
	            padding: 10px 12px;
	            display: flex;
	            flex-direction: column;
	            gap: 6px;
	            background: var(--lg-surface-semi) !important;
	            color: var(--text-primary);
	            overflow: hidden;
	            position: relative;
	            isolation: isolate;
	            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
	        }

	        .heatmap-tile-btn {
	            appearance: none;
	            -webkit-appearance: none;
	            width: 100%;
	            text-align: left;
	            color: inherit;
	            cursor: pointer;
	        }

		        .heatmap-tile:hover {
		            transform: translateY(-1px);
		            box-shadow: var(--shadow-md);
		            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
		        }

		        @media (prefers-reduced-motion: reduce) {
		            body::before { animation: none !important; }
		            .section-card,
		            .donate-btn,
		            .donate-btn::before,
		            .section-item.conclusion-section .icon,
		            .page-header h1,
		            .last-update { animation: none !important; }
		        }

		        .heatmap-tile:focus-visible {
		            box-shadow: var(--shadow-md), 0 0 0 2px color-mix(in srgb, var(--primary) 45%, transparent);
		            border-color: color-mix(in srgb, var(--primary) 45%, var(--lg-glass-border));
		        }

		        .heatmap-tile-btn:focus-visible { outline: none; }

	        /* Index heatmap tiles: keep neutral surface, use neon-like metric + small indicator */
	        .heatmap-tile[title*="| +"] .metric { color: var(--success); }
	        .heatmap-tile[title*="| -"] .metric { color: var(--danger); }

	        .heatmap-tile::before {
	            content: '';
	            position: absolute;
	            top: 10px;
	            right: 10px;
	            width: 8px;
	            height: 8px;
	            border-radius: 999px;
	            background: color-mix(in srgb, var(--text-secondary) 60%, transparent);
	            box-shadow: 0 0 0 1px color-mix(in srgb, var(--lg-glass-border) 85%, transparent);
	        }

	        .heatmap-tile[title*="| +"]::before {
	            background: var(--success);
	            box-shadow: 0 0 10px color-mix(in srgb, var(--success) 45%, transparent), 0 0 0 1px color-mix(in srgb, var(--success) 55%, transparent);
	        }

	        .heatmap-tile[title*="| -"]::before {
	            background: var(--danger);
	            box-shadow: 0 0 10px color-mix(in srgb, var(--danger) 45%, transparent), 0 0 0 1px color-mix(in srgb, var(--danger) 55%, transparent);
	        }

	        .heatmap-tile .symbol {
	            font-weight: 900;
	            letter-spacing: 0.3px;
	        }

	        .heatmap-tile .metric {
	            color: var(--text-secondary);
	            font-size: 0.9rem;
	            white-space: nowrap;
	            overflow: hidden;
	            text-overflow: ellipsis;
	        }

	        .heatmap-table {
	            width: 100%;
	            border-collapse: separate;
	            border-spacing: 8px;
	            background: transparent;
	            border: 0;
	            border-radius: 0;
	            box-shadow: none;
	        }

	        [data-theme="dark"] .heatmap-table { background: transparent; border-color: transparent; box-shadow: none; }

		        .heatmap-cell {
		            border-radius: var(--lg-radius-card);
		            padding: 10px 10px;
		            border: 1px solid var(--lg-glass-border);
		            background: var(--heatmap-cell-bg, var(--lg-surface-semi)) !important;
		            text-align: center;
		            color: var(--heatmap-text-neutral);
		            position: relative;
		            overflow: hidden;
	            isolation: isolate;
	            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
	        }

	        .heatmap-cell:hover {
	            transform: translateY(-1px);
	            box-shadow: var(--shadow-md);
	            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
	        }

		        .heatmap-symbol { color: var(--text-primary); }

		        /* Stock heatmap cells (state inferred from data-change-pct attribute): neutral background, colored metric + dot */
		        .heatmap-cell-btn::before {
		            content: '';
		            position: absolute;
		            top: 10px;
		            right: 10px;
		            width: 8px;
		            height: 8px;
		            border-radius: 999px;
		            background: color-mix(in srgb, var(--text-secondary) 60%, transparent);
		            box-shadow: 0 0 0 1px color-mix(in srgb, var(--lg-glass-border) 85%, transparent);
		            pointer-events: none;
		        }

		        .heatmap-cell-btn[data-change-pct^="-"] .heatmap-metric {
		            color: var(--danger);
		        }

		        .heatmap-cell-btn[data-change-pct^="-"]::before {
		            background: var(--danger);
		            box-shadow: 0 0 10px color-mix(in srgb, var(--danger) 45%, transparent), 0 0 0 1px color-mix(in srgb, var(--danger) 55%, transparent);
		        }

		        .heatmap-cell-btn[data-change-pct]:not([data-change-pct^="-"]):not([data-change-pct=""]):not([data-change-pct="0"]):not([data-change-pct="0.0"]):not([data-change-pct="0.00"]) .heatmap-metric {
		            color: var(--success);
		        }

		        .heatmap-cell-btn[data-change-pct]:not([data-change-pct^="-"]):not([data-change-pct=""]):not([data-change-pct="0"]):not([data-change-pct="0.0"]):not([data-change-pct="0.00"])::before {
		            background: var(--success);
		            box-shadow: 0 0 10px color-mix(in srgb, var(--success) 45%, transparent), 0 0 0 1px color-mix(in srgb, var(--success) 55%, transparent);
		        }

		        .heatmap-cell-btn {
		            appearance: none;
		            -webkit-appearance: none;
		            display: block;
		            width: 100%;
		            border: 0;
		            background: transparent;
		            padding: 0;
		            color: inherit;
		            cursor: pointer;
		            position: relative;
		            z-index: 1;
		        }

		        .heatmap-cell:focus-within {
		            box-shadow: var(--shadow-md), 0 0 0 2px color-mix(in srgb, var(--primary) 45%, transparent);
		            border-color: color-mix(in srgb, var(--primary) 45%, var(--lg-glass-border));
		        }

	        .heatmap-cell-btn:focus-visible {
	            outline: none;
	        }

        .heatmap-symbol {
            font-weight: 900;
            letter-spacing: 0.3px;
        }

	        .heatmap-metric {
	            margin-top: 4px;
	            color: var(--text-secondary);
	            font-size: 0.85rem;
	            font-weight: 700;
	            white-space: nowrap;
	            overflow: hidden;
	            text-overflow: ellipsis;
	        }

	        /* Summary charts/cards */
	        .idx-cards {
	            display: grid;
	            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
	            gap: 12px;
	        }

	        .idx-card {
	            border: 0;
	            border-radius: 0;
	            padding: 0;
	            background: transparent;
	        }

        .idx-card-btn {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            display: block;
            text-align: left;
            cursor: pointer;
            color: inherit;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            padding: 10px 10px;
            background: var(--lg-surface-semi);
            overflow: hidden;
        }

	        .idx-card-btn:hover {
	            transform: translateY(-1px);
	            box-shadow: var(--shadow-md);
	        }

	        .idx-card-btn:focus {
	            outline: none;
	            border-color: var(--primary);
	            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 22%, transparent);
	        }

        [data-theme="dark"] .idx-card {
            background: transparent;
        }

        [data-theme="dark"] .idx-card-btn {
            background: var(--lg-surface-semi);
        }

	        .idx-top {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 10px;
	        }

        .idx-code {
            font-weight: 900;
            letter-spacing: 0.4px;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .idx-change {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            white-space: nowrap;
        }

        .idx-card-btn {
            min-height: 54px;
        }

        .idx-bars {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mini-bar {
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 10px;
            align-items: center;
        }

        .mini-bar .label {
            color: var(--text-secondary);
            font-size: 0.78rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

	        .bar-track {
	            height: 10px;
	            border-radius: 999px;
	            background: color-mix(in srgb, var(--text-secondary) 18%, transparent);
	            overflow: hidden;
	            border: 1px solid var(--lg-glass-border);
	        }

	        [data-theme="dark"] .bar-track {
	            border-color: var(--lg-glass-border);
	        }

        .bar-fill {
            height: 100%;
            border-radius: 999px;
        }

	        .bar-fill.positive {
	            background: linear-gradient(90deg,
	                color-mix(in srgb, var(--success) 85%, transparent),
	                color-mix(in srgb, var(--success) 45%, transparent)
	            );
	        }

	        .bar-fill.negative {
	            background: linear-gradient(90deg,
	                color-mix(in srgb, var(--danger) 85%, transparent),
	                color-mix(in srgb, var(--danger) 45%, transparent)
	            );
	        }

	        .bar-fill.neutral {
	            background: linear-gradient(90deg,
	                color-mix(in srgb, var(--text-secondary) 85%, transparent),
	                color-mix(in srgb, var(--text-secondary) 45%, transparent)
	            );
	        }

        /* Popup modal (for cards + heatmaps) */
	        .ui-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
	            background-color: var(--overlay-scrim);
	            backdrop-filter: blur(var(--lg-blur));
	            animation: fadeIn 0.2s ease;
	        }

	        .ui-modal-content {
            background: var(--lg-surface-solid);
            margin: 3% auto;
            padding: 22px 18px;
            border-radius: var(--lg-radius-card);
            width: 92%;
            max-width: 820px;
	            box-shadow: var(--shadow-modal);
	            position: relative;
	            border: 1px solid var(--lg-glass-border);
	            animation: slideUp 0.25s ease;
	        }

	        .ui-modal.positive .ui-modal-content { border-top: 5px solid var(--success); }
	        .ui-modal.negative .ui-modal-content { border-top: 5px solid var(--danger); }
	        .ui-modal.neutral .ui-modal-content { border-top: 5px solid var(--text-secondary); }

	        .ui-close {
            position: absolute;
            right: 14px;
            top: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
	            background: var(--lg-surface-ghost);
	            border: 1px solid var(--glass-border);
            font-size: 20px;
            font-weight: 900;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

	        .ui-close:hover {
	            background: color-mix(in srgb, var(--primary) 15%, transparent);
	            color: var(--primary);
	            transform: rotate(90deg);
	        }

        .ui-title {
            font-size: 1.1rem;
            font-weight: 900;
            letter-spacing: 0.3px;
        }

        .ui-subtitle {
            margin-top: 6px;
            color: var(--text-secondary);
            font-size: 0.92rem;
        }

        .ui-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 14px 0 18px;
        }

	        .ui-actions button {
	            border: 1px solid var(--glass-border);
	            background: color-mix(in srgb, var(--primary) 10%, transparent);
	            color: var(--text-primary);
	            border-radius: 12px;
	            padding: 10px 12px;
	            font-weight: 800;
	            cursor: pointer;
	        }

	        .ui-actions button:hover {
	            background: color-mix(in srgb, var(--primary) 16%, transparent);
	        }

        .ui-metrics {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        @media (max-width: 720px) {
            .ui-metrics { grid-template-columns: 1fr; }
        }

	        .ui-metric {
	            border: 1px solid var(--glass-border);
	            border-radius: 14px;
	            padding: 12px;
	            background: var(--lg-surface-ghost);
	        }

        .ui-metric .k {
            color: var(--text-secondary);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: 800;
        }

        .ui-metric .v {
            margin-top: 8px;
            font-weight: 900;
        }

        .ui-large .heatmap-cell { padding: 14px 12px; }
        .ui-large .heatmap-table { border-spacing: 10px; }
        .ui-large .heatmap-symbol { font-size: 0.95rem; }
        .ui-large .heatmap-metric { font-size: 0.9rem; }

        .sparkline-wrap {
            margin-top: 12px;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            padding: 12px 12px;
            background: var(--lg-surface-semi);
        }

        [data-theme="dark"] .sparkline-wrap {
            background: var(--lg-surface-semi);
        }

        .sparkline-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .sparkline-title {
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .sparkline-sub {
            color: var(--text-secondary);
            font-weight: 800;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .sparkline-svg {
            width: 100%;
            height: 68px;
            display: block;
        }

	        .sparkline-grid {
	            stroke: color-mix(in srgb, var(--text-secondary) 35%, transparent);
	            stroke-width: 1;
	        }

        .sparkline-line {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

	        .sparkline-line.positive { stroke: var(--success); }
	        .sparkline-line.negative { stroke: var(--danger); }
	        .sparkline-line.neutral  { stroke: var(--primary); }

        .ohlcv-panel {
            margin-top: 14px;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-semi);
            overflow: hidden;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
            transition: transform var(--motion-med) var(--motion-ease),
                        box-shadow var(--motion-med) var(--motion-ease),
                        border-color var(--motion-med) var(--motion-ease),
                        background-color var(--motion-med) var(--motion-ease);
        }

        [data-theme="dark"] .ohlcv-panel {
            background: var(--lg-surface-semi);
        }

        .ohlcv-panel:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
        }

        .ohlcv-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--glass-border);
            background: var(--gradient-glass);
        }

        .ohlcv-toolbar .title {
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .ohlcv-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ohlcv-controls label,
        .ohlcv-controls .fixed {
            color: var(--text-secondary);
            font-weight: 900;
            font-size: 0.85rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

	        .ohlcv-controls .fixed {
	            border: 1px solid var(--glass-border);
	            background: color-mix(in srgb, var(--primary) 8%, transparent);
	            color: var(--text-primary);
	            border-radius: 12px;
	            padding: 6px 10px;
	            font-weight: 900;
	        }

        .ohlcv-body {
            padding: 12px 14px 14px;
        }

		        .ohlcv-canvas {
		            width: 100%;
		            display: block;
		            border-radius: 14px;
		            background: var(--lg-surface-ghost);
		            border: 1px solid var(--lg-glass-border);
		        }

	        [data-theme="dark"] .ohlcv-canvas {
	            border-color: var(--lg-glass-border);
	        }

	        .ohlcv-meta {
	            margin-top: 10px;
	            color: var(--text-secondary);
	            font-size: 0.85rem;
	            font-weight: 800;
	            display: flex;
	            justify-content: space-between;
	            gap: 12px;
	            flex-wrap: wrap;
	        }

		        .ohlcv-chart {
		            width: 100%;
		            height: 240px;
		            border-radius: 14px;
		            background: var(--lg-surface-ghost);
		            border: 1px solid var(--lg-glass-border);
		            position: relative;
		            overflow: hidden;
		        }

		        [data-theme="dark"] .ohlcv-chart {
		            border-color: var(--lg-glass-border);
		        }

	        .ohlcv-tooltip {
		            position: absolute;
	            top: 10px;
	            left: 10px;
	            padding: 10px 12px;
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-glass);
            border: 1px solid var(--lg-glass-border);
		            color: var(--text-primary);
		            font-size: 0.85rem;
	            font-weight: 800;
            box-shadow: var(--lg-glass-shadow);
            pointer-events: none;
            white-space: nowrap;
            backdrop-filter: blur(var(--lg-blur));
            -webkit-backdrop-filter: blur(var(--lg-blur));
        }

	        [data-theme="dark"] .ohlcv-tooltip {
	            background: var(--lg-surface-glass);
	            border-color: var(--lg-glass-border);
	            color: var(--text-primary);
	        }

        .price-panel {
            margin-top: 14px;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-semi);
            overflow: hidden;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
            transition: transform var(--motion-med) var(--motion-ease),
                        box-shadow var(--motion-med) var(--motion-ease),
                        border-color var(--motion-med) var(--motion-ease),
                        background-color var(--motion-med) var(--motion-ease);
        }

        [data-theme="dark"] .price-panel {
            background: var(--lg-surface-semi);
        }

        .price-panel:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
        }

		        .price-toolbar {
		            display: flex;
		            align-items: center;
		            justify-content: space-between;
		            gap: 12px;
		            padding: 12px 14px;
		            border-bottom: 1px solid var(--glass-border);
		            background: var(--gradient-glass);
		        }

		        .price-toolbar .title {
		            font-weight: 900;
		            letter-spacing: 0.2px;
		        }

		        .price-toolbar .note {
		            font-weight: 900;
		            font-size: 0.82rem;
		            color: var(--text-secondary);
		            white-space: nowrap;
		        }

		        .price-body {
		            padding: 12px 14px 14px;
		        }

			        .price-chart {
			            width: 100%;
			            height: 220px;
			            border-radius: 14px;
			            background: var(--lg-surface-ghost);
			            border: 1px solid var(--lg-glass-border);
			            position: relative;
			            overflow: hidden;
			        }

			        [data-theme="dark"] .price-chart {
			            border-color: var(--lg-glass-border);
			        }

		        @media (max-width: 900px) {
		            .price-panel { max-width: 100%; }
		            .price-chart { height: 190px; }
		        }

        .breadth-panel {
            margin-top: 14px;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-semi);
            overflow: hidden;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
            transition: transform var(--motion-med) var(--motion-ease),
                        box-shadow var(--motion-med) var(--motion-ease),
                        border-color var(--motion-med) var(--motion-ease),
                        background-color var(--motion-med) var(--motion-ease);
        }

        [data-theme="dark"] .breadth-panel {
            background: var(--lg-surface-semi);
        }

        .breadth-panel:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: color-mix(in srgb, var(--lg-glass-border) 70%, var(--text-primary) 10%);
        }

		        .breadth-toolbar {
		            display: flex;
		            align-items: center;
		            justify-content: space-between;
		            gap: 12px;
		            padding: 12px 14px;
		            border-bottom: 1px solid var(--glass-border);
		            background: var(--gradient-glass);
		        }

		        .breadth-toolbar .title {
		            font-weight: 900;
		            letter-spacing: 0.2px;
		        }

		        .breadth-grid {
		            padding: 12px 14px 14px;
		            display: grid;
		            grid-template-columns: repeat(2, minmax(0, 1fr));
		            gap: 12px;
		        }

		        @media (max-width: 700px) {
		            .breadth-grid { grid-template-columns: 1fr; }
		        }

        .breadth-card {
            border-radius: var(--lg-radius-card);
            border: 1px solid var(--lg-glass-border);
            background: var(--lg-surface-semi);
            padding: 12px 12px 10px;
            cursor: pointer;
            user-select: none;
            transition: transform 120ms ease, box-shadow 120ms ease;
        }

			        .breadth-card:hover {
			            transform: translateY(-1px);
			            box-shadow: var(--shadow-md);
			        }

		        .breadth-card .k {
		            font-weight: 950;
		            font-size: 0.82rem;
		            color: var(--text-secondary);
		            display: flex;
		            align-items: center;
		            gap: 8px;
		        }

		        .breadth-card .v {
		            margin-top: 6px;
		            font-weight: 950;
		            font-size: 1.12rem;
		            color: var(--text-primary);
		            display: flex;
		            align-items: baseline;
		            justify-content: space-between;
		            gap: 10px;
		        }

		        .breadth-card .hint {
		            margin-top: 6px;
		            font-size: 0.78rem;
		            font-weight: 800;
		            color: var(--text-secondary);
		        }

			        .mini-bar {
			            margin-top: 10px;
			            height: 10px;
			            border-radius: 999px;
			            overflow: hidden;
			            border: 1px solid var(--lg-glass-border);
			            background: color-mix(in srgb, var(--text-secondary) 20%, transparent);
			            display: flex;
			        }

			        [data-theme="dark"] .mini-bar {
			            border-color: var(--lg-glass-border);
			        }

			        .mini-bar > span { height: 100%; }
			        .mini-bar .pos { background: color-mix(in srgb, var(--success) 85%, transparent); }
			        .mini-bar .neg { background: color-mix(in srgb, var(--danger) 85%, transparent); }
			        .mini-bar .neu { background: color-mix(in srgb, var(--text-secondary) 70%, transparent); }

			        .mini-gauge {
			            margin-top: 10px;
			            height: 10px;
			            border-radius: 999px;
			            border: 1px solid var(--lg-glass-border);
			            background: linear-gradient(90deg,
			                color-mix(in srgb, var(--success) 25%, transparent) 0%,
			                color-mix(in srgb, var(--success) 25%, transparent) 35%,
			                color-mix(in srgb, var(--text-secondary) 22%, transparent) 35%,
			                color-mix(in srgb, var(--text-secondary) 22%, transparent) 55%,
			                color-mix(in srgb, var(--danger) 22%, transparent) 55%,
			                color-mix(in srgb, var(--danger) 22%, transparent) 100%
			            );
			            position: relative;
			        }

			        [data-theme="dark"] .mini-gauge {
			            border-color: var(--lg-glass-border);
			        }

			        .mini-gauge .marker {
			            position: absolute;
			            top: -4px;
			            width: 3px;
			            height: 18px;
			            border-radius: 2px;
			            background: var(--text-primary);
			        }

			        [data-theme="dark"] .mini-gauge .marker {
			            background: var(--text-primary);
			        }

			        .mini-osc {
			            margin-top: 10px;
			            height: 12px;
			            border-radius: 999px;
			            border: 1px solid var(--lg-glass-border);
			            background: color-mix(in srgb, var(--text-secondary) 20%, transparent);
			            position: relative;
			            overflow: hidden;
			        }

			        [data-theme="dark"] .mini-osc {
			            border-color: var(--lg-glass-border);
			        }

			        .mini-osc .zero {
			            position: absolute;
			            left: 50%;
			            top: 0;
			            width: 2px;
			            height: 100%;
			            background: color-mix(in srgb, var(--text-secondary) 65%, transparent);
			        }

				        .mini-osc .fill {
				            position: absolute;
				            top: 0;
				            height: 100%;
				            background: color-mix(in srgb, var(--text-secondary) 65%, transparent);
				        }

        .bh-panel {
            margin-top: 14px;
            border: 1px solid var(--lg-glass-border);
            border-radius: var(--lg-radius-card);
            background: var(--lg-surface-semi);
            overflow: hidden;
            max-width: 860px;
            margin-left: auto;
            margin-right: auto;
        }

        [data-theme="dark"] .bh-panel {
            background: var(--lg-surface-semi);
        }

			        .bh-toolbar {
			            display: flex;
			            align-items: center;
			            justify-content: space-between;
			            gap: 12px;
			            padding: 12px 14px;
			            border-bottom: 1px solid var(--glass-border);
			            background: var(--gradient-glass);
			        }

			        .bh-toolbar .title {
			            font-weight: 950;
			            letter-spacing: 0.2px;
			        }

			        .bh-toolbar .right {
			            display: flex;
			            align-items: center;
			            gap: 10px;
			            flex-wrap: wrap;
			            justify-content: flex-end;
			        }

			        .bh-meta {
			            font-weight: 900;
			            font-size: 0.82rem;
			            color: var(--text-secondary);
			        }

			        .bh-body {
			            padding: 12px 14px 14px;
			        }

			        .bh-kpis {
			            display: grid;
			            grid-template-columns: 1.2fr 1fr;
			            gap: 12px;
			            align-items: stretch;
			            margin-bottom: 12px;
			        }

			        @media (max-width: 900px) {
			            .bh-panel { max-width: 100%; }
			            .bh-kpis { grid-template-columns: 1fr; }
			        }

        .bh-card {
            border-radius: var(--lg-radius-card);
            border: 1px solid var(--lg-glass-border);
            background: var(--lg-surface-semi);
            padding: 12px;
        }

			        .bh-card .k {
			            font-weight: 950;
			            font-size: 0.82rem;
			            color: var(--text-secondary);
			            display: flex;
			            align-items: center;
			            justify-content: space-between;
			            gap: 10px;
			        }

			        .bh-card .v {
			            margin-top: 8px;
			            font-weight: 950;
			            font-size: 1.22rem;
			            color: var(--text-primary);
			            display: flex;
			            align-items: baseline;
			            gap: 10px;
			            flex-wrap: wrap;
			        }

				        .bh-chip {
				            display: inline-flex;
				            align-items: center;
				            gap: 6px;
				            padding: 6px 10px;
				            border-radius: 999px;
				            border: 1px solid var(--glass-border);
				            background: var(--lg-surface-ghost);
				            font-weight: 950;
				            font-size: 0.82rem;
				            color: var(--text-primary);
				            white-space: nowrap;
				        }

				        .bh-chip.positive { background: color-mix(in srgb, var(--success) 12%, transparent); }
				        .bh-chip.negative { background: color-mix(in srgb, var(--danger) 12%, transparent); }

				        .bh-gauge {
				            margin-top: 10px;
				            height: 12px;
				            border-radius: 999px;
				            border: 1px solid var(--lg-glass-border);
				            background: linear-gradient(90deg,
				                color-mix(in srgb, var(--danger) 22%, transparent) 0%,
				                color-mix(in srgb, var(--danger) 22%, transparent) 20%,
				                color-mix(in srgb, var(--text-secondary) 20%, transparent) 20%,
				                color-mix(in srgb, var(--text-secondary) 20%, transparent) 50%,
				                color-mix(in srgb, var(--success) 20%, transparent) 50%,
				                color-mix(in srgb, var(--success) 20%, transparent) 80%,
				                color-mix(in srgb, var(--success) 26%, transparent) 80%,
				                color-mix(in srgb, var(--success) 26%, transparent) 100%
				            );
				            position: relative;
				        }

				        [data-theme="dark"] .bh-gauge {
				            border-color: var(--lg-glass-border);
				        }

				        .bh-gauge .marker {
				            position: absolute;
				            top: -4px;
				            width: 3px;
				            height: 20px;
				            border-radius: 2px;
				            background: var(--text-primary);
				        }

				        [data-theme="dark"] .bh-gauge .marker {
				            background: var(--text-primary);
				        }

				        .bh-chart {
				            width: 100%;
				            height: 280px;
				            border-radius: 14px;
				            background: var(--lg-surface-ghost);
				            border: 1px solid var(--lg-glass-border);
				            position: relative;
				            overflow: hidden;
				        }

				        [data-theme="dark"] .bh-chart {
				            border-color: var(--lg-glass-border);
				        }

			        .bh-sparks {
			            margin-top: 12px;
			            display: grid;
			            grid-template-columns: repeat(4, minmax(0, 1fr));
			            gap: 10px;
			        }

			        @media (max-width: 900px) {
			            .bh-sparks { grid-template-columns: repeat(2, minmax(0, 1fr)); }
			        }

			        @media (max-width: 520px) {
			            .bh-sparks { grid-template-columns: 1fr; }
			        }

        .bh-spark {
            border-radius: var(--lg-radius-card);
            border: 1px solid var(--lg-glass-border);
            background: var(--lg-surface-semi);
            padding: 10px;
            cursor: pointer;
            transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease, box-shadow 0.12s ease;
        }
				
					        .bh-spark:hover {
					            border-color: color-mix(in srgb, var(--indigo) 45%, transparent);
					            background: color-mix(in srgb, var(--indigo) 6%, transparent);
					            box-shadow: var(--shadow-md);
					            transform: translateY(-1px);
					        }
				
					        .bh-spark:focus-visible {
					            outline: 3px solid color-mix(in srgb, var(--indigo) 45%, transparent);
					            outline-offset: 2px;
					        }

			        .bh-spark .k {
			            font-weight: 950;
			            font-size: 0.78rem;
			            color: var(--text-secondary);
			            display: flex;
			            justify-content: space-between;
			            gap: 8px;
			        }

				        .bh-spark .spark {
				            margin-top: 8px;
				            height: 70px;
				            border-radius: 12px;
				            border: 1px solid var(--lg-glass-border);
				            background: var(--lg-surface-ghost);
				            overflow: hidden;
				        }

				        [data-theme="dark"] .bh-spark .spark {
				            border-color: var(--lg-glass-border);
				        }

	        .keylevels-panel,
	        .targetlevels-panel {
	            margin-top: 14px;
	            border: 1px solid var(--lg-glass-border);
	            border-radius: var(--lg-radius-card);
	            background: var(--lg-surface-semi);
	            overflow: hidden;
	            max-width: 760px;
	            margin-left: auto;
	            margin-right: auto;
	        }

        [data-theme="dark"] .keylevels-panel,
        [data-theme="dark"] .targetlevels-panel {
            background: var(--lg-surface-semi);
        }

	        .keylevels-toolbar {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 12px;
	            padding: 12px 14px;
	            border-bottom: 1px solid var(--glass-border);
	            background: var(--gradient-glass);
	        }

	        .keylevels-toolbar .title {
	            font-weight: 900;
	            letter-spacing: 0.2px;
	        }

	        .keylevels-body {
	            padding: 12px 14px 14px;
	        }

		        .keylevels-chart {
		            width: 100%;
		            height: 380px;
		            border-radius: 14px;
		            background: var(--lg-surface-ghost);
		            border: 1px solid var(--lg-glass-border);
		            position: relative;
		            overflow: hidden;
		        }

		        [data-theme="dark"] .keylevels-chart {
		            border-color: var(--lg-glass-border);
		        }

	        .keylevels-tags {
	            margin-top: 10px;
	            display: flex;
	            gap: 8px;
	            flex-wrap: wrap;
	        }

		        .keylevels-tag {
	            padding: 6px 10px;
	            border-radius: 999px;
	            font-weight: 900;
	            font-size: 0.8rem;
	            border: 1px solid var(--glass-border);
		            background: color-mix(in srgb, var(--primary) 8%, transparent);
		            color: var(--text-primary);
		        }

		        .keylevels-tag.support {
		            background: color-mix(in srgb, var(--success) 10%, transparent);
		        }

		        .keylevels-tag.resistance {
		            background: color-mix(in srgb, var(--danger) 10%, transparent);
		        }

	        .keylevels-controls {
	            display: flex;
	            align-items: center;
	            gap: 10px;
	            flex-wrap: wrap;
	            justify-content: flex-end;
	        }

		        .keylevels-segment {
	            display: inline-flex;
	            border: 1px solid var(--glass-border);
	            border-radius: 999px;
	            overflow: hidden;
		            background: color-mix(in srgb, var(--primary) 8%, transparent);
		        }

	        .keylevels-segbtn {
	            appearance: none;
	            border: 0;
	            background: transparent;
	            padding: 6px 10px;
	            font-weight: 950;
	            font-size: 0.82rem;
	            color: var(--text-secondary);
	            cursor: pointer;
	            white-space: nowrap;
	        }

		        .keylevels-segbtn.active {
		            background: color-mix(in srgb, var(--primary) 16%, transparent);
		            color: var(--text-primary);
		        }

	        .keylevels-checks {
	            display: flex;
	            gap: 8px;
	            flex-wrap: wrap;
	            align-items: center;
	        }

		        .keylevels-check {
	            display: inline-flex;
	            align-items: center;
	            gap: 6px;
	            padding: 6px 10px;
	            border-radius: 999px;
	            border: 1px solid var(--glass-border);
		            background: var(--lg-surface-ghost);
		            color: var(--text-primary);
		            font-weight: 900;
		            font-size: 0.82rem;
		            cursor: pointer;
		            user-select: none;
		        }

	        .keylevels-check input {
	            width: 14px;
	            height: 14px;
	        }

		        @media (max-width: 900px) {
		            .keylevels-panel, .targetlevels-panel { max-width: 100%; }
		            .keylevels-chart { height: 300px; }
		        }
    </style>
</head>
<body data-theme="light">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        ðŸŒ™
    </button>

    <div class="dashboard">
        <!-- Sidebar 1: Index List (Left) -->
	        <div class="sidebar">
		            <div class="sidebar-header">
		                <h2>ðŸ“Š Index</h2>
		                <div class="date" id="reportDate">--/--/----</div>
		                <div class="plan-note" id="planNote">Lite (Public): Tá»•ng há»£p + VNINDEX, VN30, VN100, VNMIDCAP.</div>
		            </div>

            <div class="search-box">
                <input type="text" class="search-input" placeholder="ðŸ” TÃ¬m chá»‰ sá»‘..." id="searchInput">
            </div>

            <div class="index-list" id="indexList">
                <!-- Indices sáº½ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y -->
            </div>
        </div>

        <!-- Main Content: Single Section Display (Center) -->
        <div class="main-content">
	            <div class="page-header">
	                <h1 id="pageTitle">Chá»n chá»‰ sá»‘ vÃ  má»¥c Ä‘á»ƒ xem</h1>
	                <div class="last-update" id="lastUpdate">Cáº­p nháº­t: --/--/---- --:--</div>
	                <button class="donate-btn" onclick="showDonateModal()">
	                    ðŸ’ Má»i báº¡n cafe / á»¦ng há»™
	                </button>
	            </div>

            <!-- Single Section Content -->
            <div id="singleSectionContent" style="display: none;">
                <!-- Section content sáº½ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y -->
            </div>

            <!-- Empty State -->
	            <div id="emptyState" style="display: block; text-align: center; padding: 100px 20px;">
	                <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ‘ˆ ðŸ‘‰</div>
	                <h2 style="color: var(--text-secondary); margin-bottom: 10px;">ChÆ°a chá»n má»¥c phÃ¢n tÃ­ch</h2>
	                <p style="color: var(--text-secondary); font-size: 0.9rem;">
	                    1. Chá»n chá»‰ sá»‘ á»Ÿ cá»™t <strong>bÃªn trÃ¡i</strong><br>
	                    2. Chá»n má»¥c phÃ¢n tÃ­ch á»Ÿ cá»™t <strong>bÃªn pháº£i</strong>
	                </p>
	            </div>

	            <div class="donate-footer" id="donateFooter">
	                <button class="donate-btn" onclick="showDonateModal()">
	                    ðŸ’ Má»i báº¡n cafe / á»¦ng há»™
	                </button>
	            </div>
	        </div>

        <!-- Sidebar 2: Section Navigation (Right) -->
        <div class="section-nav">
            <div class="section-nav-header">
                <h3 id="sectionNavTitle">Chá»n má»¥c</h3>
                <div class="subtitle">SECTIONS</div>
            </div>

            <div class="section-list" id="sectionList">
                <div class="no-sections">
                    Chá»n má»™t chá»‰ sá»‘ bÃªn trÃ¡i Ä‘á»ƒ xem cÃ¡c má»¥c phÃ¢n tÃ­ch
                </div>
            </div>
        </div>
    </div>

    <button type="button" id="mobileMenuFab" class="mobile-menu-fab" aria-label="Quay láº¡i menu">â˜° Menu</button>

    <script>
	        // Theme Toggle Logic
	        const themeToggle = document.getElementById('themeToggle');
	        const body = document.body;
	        let currentTheme = localStorage.getItem('theme') || 'light';

	        // Disable TradingView links (UI charts are not linked externally)
	        document.addEventListener('click', function (event) {
	            const a = event.target && event.target.closest ? event.target.closest('a') : null;
	            if (!a) return;
	            const href = (a.getAttribute('href') || '').trim();
	            if (!href) return;
	            if (/tradingview\.com/i.test(href)) {
	                event.preventDefault();
	                event.stopPropagation();
	            }
	        }, true);

        // Apply saved theme
        body.setAttribute('data-theme', currentTheme);
        updateThemeIcon(currentTheme);

			        themeToggle.addEventListener('click', () => {
			            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
			            body.setAttribute('data-theme', currentTheme);
			            localStorage.setItem('theme', currentTheme);
			            updateThemeIcon(currentTheme);
		            // Re-init trend charts to match theme
		            document.querySelectorAll('.price-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                const mode = panel.getAttribute('data-mode') || 'line';
		                if (panel.id && idxKey) {
		                    try { initIndexPricePanel(panel.id, idxKey, mode); } catch (_) {}
		                }
		            });
		            document.querySelectorAll('.ohlcv-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                if (panel.id && idxKey) {
		                    try { initIndexOhlcvPanel(panel.id, idxKey); } catch (_) {}
		                }
		            });
		            document.querySelectorAll('.keylevels-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                if (panel.id && idxKey) {
		                    const stored = (window.__uiGlmKeyLevelsStore || {})[panel.id];
		                    try { initKeyLevelsPanel(panel.id, idxKey, stored ? stored.sectionHtml : ''); } catch (_) {}
		                }
		            });
		            document.querySelectorAll('.targetlevels-panel').forEach(panel => {
		                const idxKey = panel.getAttribute('data-index-key');
		                if (panel.id && idxKey) {
		                    const stored = (window.__uiGlmTargetLevelsStore || {})[panel.id];
		                    try { initTargetLevelsPanel(panel.id, idxKey, stored ? stored.sectionHtml : ''); } catch (_) {}
		                }
		            });
			            document.querySelectorAll('.bh-panel').forEach(panel => {
			                if (panel.id) {
			                    try { initBreadthHistoryPanel(panel.id); } catch (_) {}
			                }
			            });
			        });

					        // Mobile: floating back-to-menu button
					        document.getElementById('mobileMenuFab')?.addEventListener('click', () => {
					            try { closeUiModal(); } catch (_) {}
					            try { closeDonateModal(); } catch (_) {}
					            try {
					                if (isMobileViewport()) document.body.classList.remove('mobile-reading');
					                const target = currentIndex ? document.querySelector('.section-nav') : document.querySelector('.sidebar');
					                scrollToElAfterRender(target, 12);
					                setTimeout(() => scrollToElAfterRender(target, 12), 140);
					            } catch (_) {}
					        });

        function updateThemeIcon(theme) {
            themeToggle.textContent = theme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
        }

		        // Data from full_data.js
		        const data = FULL_DATA;

		        // Dynamic report metadata (generated by auto_daily_update.sh)
		        // Use cache-busting fetch so the header updates immediately after deploy (GitHub Pages caches ~10 minutes).
		        (function applyReportMetaAsync() {
		            const apply = (meta) => {
		                try {
		                    if (!meta) return;
		                    const dateEl = document.getElementById('reportDate');
		                    if (dateEl && meta.human_date) dateEl.textContent = meta.human_date;
		                    const lastEl = document.getElementById('lastUpdate');
		                    if (lastEl && meta.human_updated_at) lastEl.textContent = `Cáº­p nháº­t: ${meta.human_updated_at}`;
		                } catch (_) {}
		            };

		            // Fallback (if JSON missing): use any existing global.
		            try { apply(window.UI_GLM_REPORT_META || null); } catch (_) {}

		            try {
		                const ts = Date.now();
		                fetch(`ui_glm_meta.json?ts=${ts}`, { cache: 'no-store' })
		                    .then(r => (r && r.ok) ? r.json() : null)
		                    .then(payload => apply(payload))
		                    .catch(() => {});
		            } catch (_) {}
		        })();

		        // ---------------------------
		        // Lite / Pro access control
		        // ---------------------------
		        // Feature flags
		        // Táº¡m táº¯t logic trÃ­ch xuáº¥t H1â€“H2/R1â€“R2 cho "Má»¨C GIÃ QUAN TRá»ŒNG" vÃ  "GIÃ Má»¤C TIÃŠU"
		        // vÃ¬ output AI cÃ³ thá»ƒ khÃ´ng Ä‘á»“ng nháº¥t giá»¯a cÃ¡c láº§n cháº¡y.
		        const UI_GLM_DISABLE_LEVELS_EXTRACTION = true;

		        const UI_GLM_PLAN = {
		            LITE: 'lite',
		        };

	        const UI_GLM_PUBLIC_BUILD = true;

	        const UI_GLM_LITE_ALLOWED_INDICES = new Set(['overview', 'vnindex', 'vn30', 'vn100', 'vnmidcap']);
	        const UI_GLM_LITE_HIDDEN_SECTIONS = new Set([
	            'MÃ” HÃŒNH GIÃ - MÃ” HÃŒNH Náº¾N',
	            'MARKET BREADTH & TÃ‚M LÃ THá»Š TRÆ¯á»œNG',
            'Lá»ŠCH Sá»¬ & XU HÆ¯á»šNG BREADTH',
        ].map(s => s.trim().toUpperCase()));

	        function getPlanPreference() {
	            return UI_GLM_PLAN.LITE;
	        }

	        function isProUnlocked() {
	            return false;
	        }

	        function getEffectivePlan() {
	            return UI_GLM_PLAN.LITE;
	        }

	        function setPlanPreference(plan) {
	            // public Lite build: no-op
	        }

	        function renderPlanToggle() {
	            const noteEl = document.getElementById('planNote');
	            if (!noteEl) return;
	            noteEl.textContent = 'Lite (Public): Tá»•ng há»£p + VNINDEX, VN30, VN100, VNMIDCAP.';
	        }

	        function unlockProAndApply() {
	            openPlanChooserModal();
	        }

	        function lockToLiteAndApply() {
	            applyPlanToUi();
	        }

	        function openProPasswordModal({ onSuccess, onCancel, showLiteSuggestion = true } = {}) {
	            openPlanChooserModal();
	        }

	        function shouldShowPlanChooserOnStartup() {
	            return false;
	        }

	        function openPlanChooserModal() {
	            const bodyHtml = `
	                <div class="plan-chooser">
	                    <div style="font-weight:950;letter-spacing:0.2px;">Lite (Public)</div>
	                    <div style="color:var(--text-secondary);font-weight:800;font-size:0.9rem;line-height:1.6;margin-top:10px;">
	                        Trang nÃ y chá»‰ public báº£n Lite Ä‘á»ƒ trÃ¡nh rá»§i ro lá»™ thÃ´ng tin.<br/>
	                        Báº¡n Ä‘ang xem: <strong>Tá»”NG Há»¢P</strong> + <strong>VNINDEX</strong>, <strong>VN30</strong>, <strong>VN100</strong>, <strong>VNMIDCAP</strong>.
	                    </div>
	                    <div style="margin-top:12px;">
	                        <button type="button" class="plan-btn" onclick="closeUiModal()">OK</button>
	                    </div>
	                </div>
	            `;
	            const modal = document.getElementById('uiModal');
	            if (modal) modal.dataset.modalType = 'plan';
	            openUiModal({ tone: 'neutral', title: 'Lite', subtitle: 'Báº£n public', bodyHtml, large: false });
	        }

	        function tryOpenPlanChooserWhenReady() {
	            // public Lite build: no-op
	        }

	        function isIndexAllowedForCurrentPlan(indexKey) {
	            return UI_GLM_LITE_ALLOWED_INDICES.has(String(indexKey || '').trim().toLowerCase());
	        }

	        function filterSectionsForCurrentPlan(sections) {
	            return (sections || []).filter(s => {
	                const title = normalizeTitle(s && s.title ? s.title : '');
	                return !UI_GLM_LITE_HIDDEN_SECTIONS.has(title);
	            });
	        }

        function applyPlanToUi() {
            renderPlanToggle();
            renderSidebar();

            if (currentIndex && !isIndexAllowedForCurrentPlan(currentIndex)) {
                currentIndex = null;
                currentSectionIndex = null;
            }

            // Re-render right section list based on current selection (if any).
            if (currentIndex && isIndexAllowedForCurrentPlan(currentIndex)) {
                renderSectionList(currentIndex);
            } else {
                document.getElementById('sectionList').innerHTML = '<div class="no-sections">Chá»n chá»‰ sá»‘ Ä‘á»ƒ xem</div>';
                document.getElementById('sectionNavTitle').textContent = 'Má»¥c phÃ¢n tÃ­ch';
                document.getElementById('pageTitle').textContent = 'Chá»n chá»‰ sá»‘ vÃ  má»¥c Ä‘á»ƒ xem';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('singleSectionContent').style.display = 'none';
            }
        }

        // Render sidebar
        function renderSidebar() {
            const all = [
                { key: 'overview', name: 'Tá»”NG Há»¢P' },
                { key: 'vnindex', name: 'VNINDEX' },
                { key: 'vn30', name: 'VN30' },
                { key: 'vn100', name: 'VN100' },
                { key: 'vnmidcap', name: 'VNMIDCAP' },
                { key: 'vnreal', name: 'VNREAL' },
                { key: 'vnit', name: 'VNIT' },
                { key: 'vnheal', name: 'VNHEAL' },
                { key: 'vnfin', name: 'VNFIN' },
                { key: 'vnene', name: 'VNENE' },
                { key: 'vncons', name: 'VNCONS' },
                { key: 'vnmat', name: 'VNMAT' },
                { key: 'vncond', name: 'VNCOND' },
                { key: 'vnsml', name: 'VNSML' },
                { key: 'vnfinselect', name: 'VNFINSELECT' },
                { key: 'vndiamond', name: 'VNDIAMOND' }
            ];

            const indices = all.filter(i => isIndexAllowedForCurrentPlan(i.key));

            const container = document.getElementById('indexList');
            container.innerHTML = indices.map(idx => `
                <div class="index-item ${idx.key === 'vnindex' ? 'active' : ''}"
                     onclick="selectIndex('${idx.key}')"
                     data-index="${idx.key}">
                    <span class="name">${idx.name}</span>
                </div>
            `).join('');
        }

        // State
        let currentIndex = null;
        let currentSectionIndex = null;

        function _getToneFromChange(changePct) {
            if (changePct == null || !Number.isFinite(changePct)) return 'neutral';
            if (changePct > 0) return 'positive';
            if (changePct < 0) return 'negative';
            return 'neutral';
        }

        function _updateBodyOverflow() {
            const donateModal = document.getElementById('donateModal');
            const uiModal = document.getElementById('uiModal');
            const donateOpen = donateModal && donateModal.style.display === 'block';
            const uiOpen = uiModal && uiModal.style.display === 'block';
            document.body.style.overflow = (donateOpen || uiOpen) ? 'hidden' : 'auto';
        }

        function openUiModal({ tone = 'neutral', title = '', subtitle = '', bodyHtml = '', large = false } = {}) {
            const modal = document.getElementById('uiModal');
            const body = document.getElementById('uiModalBody');
            const titleEl = document.getElementById('uiModalTitle');
            const subtitleEl = document.getElementById('uiModalSubtitle');

            if (!modal || !body || !titleEl || !subtitleEl) return;

            modal.classList.remove('positive', 'negative', 'neutral');
            modal.classList.add(tone === 'positive' ? 'positive' : (tone === 'negative' ? 'negative' : 'neutral'));

            titleEl.textContent = title || '';
            subtitleEl.textContent = subtitle || '';
            body.innerHTML = `<div class="${large ? 'ui-large' : ''}">${bodyHtml || ''}</div>`;

            modal.style.display = 'block';
            _updateBodyOverflow();
        }

	        function closeUiModal() {
	            const modal = document.getElementById('uiModal');
	            if (!modal) return;
	            const modalType = modal.dataset ? modal.dataset.modalType : '';
	            if (modalType === 'plan') {
	                try { delete modal.dataset.modalType; } catch (_) {}
	            }
	            modal.style.display = 'none';
	            const body = document.getElementById('uiModalBody');
	            if (body) body.innerHTML = '';
            _updateBodyOverflow();
        }

        function openIndexPopup(indexKey) {
            const idx = data[indexKey];
            const metrics = parseIndexMetrics(indexKey) || {};
            const tone = _getToneFromChange(metrics.changePct);

            const price = metrics.priceText || 'N/A';
            const change = metrics.changeText || 'N/A';
            const volText = metrics.volumeText || (metrics.volumeValue != null ? formatCompactNumber(metrics.volumeValue) : 'N/A');

            // Normalize bars within the summary set for nicer visuals.
            const rows = getSummaryIndexRows();
            const usableChange = rows.filter(r => r.changePct != null);
            const usableVol = rows.filter(r => r.volumeValue != null);
            const maxAbsChange = usableChange.length ? Math.max(...usableChange.map(r => Math.abs(r.changePct))) : 1;
            const maxVolume = usableVol.length ? Math.max(...usableVol.map(r => r.volumeValue)) : 1;

            const changeW = metrics.changePct == null ? 0 : Math.max(8, Math.round(100 * Math.min(Math.abs(metrics.changePct) / maxAbsChange, 1)));
            const volW = metrics.volumeValue == null ? 0 : Math.max(8, Math.round(100 * Math.min(metrics.volumeValue / maxVolume, 1)));

            const cls = tone;
            const subtitle = idx && idx.title ? idx.title : '';

            const bodyHtml = `
                <div class="ui-actions">
                    <button type="button" onclick="selectIndex('${indexKey}'); closeUiModal();">Má»Ÿ phÃ¢n tÃ­ch</button>
                    <button type="button" onclick="closeUiModal()">ÄÃ³ng</button>
                </div>
                <div class="ui-metrics">
                    <div class="ui-metric"><div class="k">GiÃ¡</div><div class="v">${price}</div></div>
                    <div class="ui-metric"><div class="k">Thay Ä‘á»•i</div><div class="v"><span class="chip ${cls}">${change}</span></div></div>
                    <div class="ui-metric"><div class="k">Khá»‘i lÆ°á»£ng</div><div class="v">${volText}</div></div>
                </div>
                <div class="idx-bars" style="margin-top: 0;">
                    <div class="mini-bar">
                        <div class="label">Change</div>
                        <div class="bar-track"><div class="bar-fill ${cls}" style="width:${changeW}%"></div></div>
                    </div>
                    <div class="mini-bar">
                        <div class="label">Volume</div>
                        <div class="bar-track"><div class="bar-fill neutral" style="width:${volW}%"></div></div>
                    </div>
                </div>
            `;

            const title = (indexKey || '').toUpperCase();
            openUiModal({ tone, title, subtitle, bodyHtml, large: false });
        }

	        function openVnindexStockPopupFromEl(el) {
	            if (!el || !el.dataset) return;

	            const symbol = el.dataset.symbol || 'N/A';
	            const price = el.dataset.price || 'N/A';
	            const value = el.dataset.value || 'N/A';
	            const volume = el.dataset.volume || 'N/A';

	            const changePct = Number(el.dataset.changePct);
	            const tone = _getToneFromChange(Number.isFinite(changePct) ? changePct : null);
	            const cls = tone;
	            const changeStr = Number.isFinite(changePct) ? ((changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%') : 'N/A';

	            const metaAll = (typeof window !== 'undefined' && window.UI_GLM_COMPANY_META) ? window.UI_GLM_COMPANY_META : null;
	            const meta = metaAll && symbol && metaAll[symbol] ? metaAll[symbol] : null;
	            const companyName = meta && meta.name ? String(meta.name) : 'N/A';
	            const sectorRaw = meta && meta.sector ? String(meta.sector) : 'N/A';
	            const sectorParts = sectorRaw && sectorRaw.includes('/') ? sectorRaw.split('/') : null;
	            const sectorVi = sectorParts && sectorParts[1] ? sectorParts[1] : sectorRaw;
	            const sectorEn = sectorParts && sectorParts[0] ? sectorParts[0] : '';

	            function _sparklinePath(values, width, height, pad) {
	                const pts = (values || []).map(v => Number(v)).filter(v => Number.isFinite(v));
	                if (pts.length < 2) return '';
	                const min = Math.min(...pts);
	                const max = Math.max(...pts);
	                const span = (max - min) || 1;
	                const n = pts.length;
	                const w = Math.max(10, width - pad * 2);
	                const h = Math.max(10, height - pad * 2);
	                return pts.map((v, i) => {
	                    const x = pad + (n === 1 ? 0 : (i * w / (n - 1)));
	                    const y = pad + (h - ((v - min) / span) * h);
	                    return `${x.toFixed(1)},${y.toFixed(1)}`;
	                }).join(' ');
	            }

	            function _renderSparkline(values, tone) {
	                const pts = (values || []).map(v => Number(v)).filter(v => Number.isFinite(v));
	                if (pts.length < 2) return '';
	                const w = 420;
	                const h = 68;
	                const pad = 6;
	                const poly = _sparklinePath(pts, w, h, pad);
	                if (!poly) return '';
	                const last = pts[pts.length - 1];
	                const first = pts[0];
	                const dPct = first ? ((last - first) / first) * 100 : null;
	                const deltaStr = dPct == null || !Number.isFinite(dPct) ? '' : `(${dPct >= 0 ? '+' : ''}${dPct.toFixed(2)}%)`;
	                return `
	                    <div class="sparkline-wrap">
	                        <div class="sparkline-header">
	                            <div class="sparkline-title">GiÃ¡ 20 phiÃªn</div>
	                            <div class="sparkline-sub">Close: ${escapeHtml(last.toFixed(2))} ${escapeHtml(deltaStr)}</div>
	                        </div>
	                        <svg class="sparkline-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="Sparkline 20 phiÃªn">
	                            <path class="sparkline-grid" d="M0 ${h - 1} H${w}" />
	                            <polyline class="sparkline-line ${tone}" points="${poly}"></polyline>
	                        </svg>
	                    </div>
	                `;
	            }

	            const p20 = (typeof window !== 'undefined' && window.UI_GLM_PRICE_20D && window.UI_GLM_PRICE_20D.series) ? window.UI_GLM_PRICE_20D.series : null;
	            const p20Series = p20 && symbol && p20[symbol] && Array.isArray(p20[symbol].c) ? p20[symbol].c : null;
	            const sparklineHtml = p20Series ? _renderSparkline(p20Series, tone) : '';

	            const bodyHtml = `
	                <div class="ui-actions">
	                    <button type="button" onclick="closeUiModal()">ÄÃ³ng</button>
	                </div>
	                <div class="ui-metrics">
	                    <div class="ui-metric"><div class="k">GiÃ¡</div><div class="v">${escapeHtml(price)}</div></div>
	                    <div class="ui-metric"><div class="k">Thay Ä‘á»•i</div><div class="v"><span class="chip ${cls}">${escapeHtml(changeStr)}</span></div></div>
	                    <div class="ui-metric"><div class="k">GiÃ¡ trá»‹ GD</div><div class="v">${escapeHtml(value)}</div></div>
	                </div>
	                <div class="ui-metrics">
	                    <div class="ui-metric"><div class="k">Doanh nghiá»‡p</div><div class="v">${escapeHtml(companyName)}</div></div>
	                    <div class="ui-metric"><div class="k">NgÃ nh</div><div class="v">${escapeHtml(sectorVi)}${sectorEn ? `<span style="color: var(--text-secondary); font-weight: 800;"> (${escapeHtml(sectorEn)})</span>` : ''}</div></div>
	                    <div class="ui-metric"><div class="k">MÃ£</div><div class="v">${escapeHtml(symbol)}</div></div>
	                </div>
	                <div class="ui-metrics">
	                    <div class="ui-metric"><div class="k">Khá»‘i lÆ°á»£ng</div><div class="v">${escapeHtml(volume)}</div></div>
	                    <div class="ui-metric"><div class="k">Nguá»“n</div><div class="v">HOSE monthly DB</div></div>
	                </div>
	                ${sparklineHtml}
	            `;

	            openUiModal({ tone, title: symbol, subtitle: 'Stock heatmap', bodyHtml, large: false });
	        }

        function openBlockPopup(btnEl) {
            if (!btnEl) return;
            const block = btnEl.closest('.block');
            if (!block) return;
            const title = block.getAttribute('data-popup-title') || 'Chi tiáº¿t';
            const body = block.querySelector('.block-body');
            const bodyHtml = body ? body.innerHTML : '';
            openUiModal({ tone: 'neutral', title, subtitle: '', bodyHtml, large: true });
        }

        // Process sections to extract what-if content
	        function processSections(indexData) {
	            const processedSections = [];
	            const whatIfSections = [];

            indexData.sections.forEach((section) => {
                const titleLower = section.title.toLowerCase();
                const contentLower = section.content.toLowerCase();

                const isWhatIfTitle =
                    titleLower.includes('what-if') ||
                    titleLower.includes('ká»‹ch báº£n') ||
                    (titleLower.includes('Ä‘iá»u kiá»‡n') && titleLower.includes('sai'));

                if (isWhatIfTitle) {
                    whatIfSections.push(section);
                } else if (contentLower.includes('ká»‹ch báº£n') && contentLower.includes('what-if')) {
                    const splitPattern = /ká»‹ch\s+báº£n[\s\S]{0,50}?what-if/i;
                    const splitMatch = section.content.match(splitPattern);

                    if (splitMatch && splitMatch.index !== undefined) {
                        const splitIndex = splitMatch.index;
                        const mainContent = section.content.substring(0, splitIndex).trim();
                        const whatIfContent = section.content.substring(splitIndex).trim();

                        processedSections.push({
                            ...section,
                            content: mainContent
                        });

                        whatIfSections.push({
                            title: 'Ká»‹ch Báº£n What-if',
                            content: whatIfContent,
                            alert: false
                        });
                    } else {
                        const keywordIndex = contentLower.indexOf('ká»‹ch báº£n');
                        if (keywordIndex !== -1) {
                            const whatIfIndex = contentLower.indexOf('what-if', keywordIndex);
                            if (whatIfIndex !== -1) {
                                const originalContent = section.content;
                                const actualKeywordIndex = originalContent.toLowerCase().indexOf('ká»‹ch báº£n');
                                const actualWhatIfIndex = originalContent.toLowerCase().indexOf('what-if', actualKeywordIndex);

                                const mainContent = originalContent.substring(0, actualWhatIfIndex).trim();
                                const whatIfContent = originalContent.substring(actualWhatIfIndex).trim();

                                processedSections.push({
                                    ...section,
                                    content: mainContent
                                });

                                whatIfSections.push({
                                    title: 'Ká»‹ch Báº£n What-if',
                                    content: whatIfContent,
                                    alert: false
                                });
                            } else {
                                processedSections.push(section);
                            }
                        } else {
                            processedSections.push(section);
                        }
                    }
                } else {
                    processedSections.push(section);
                }
            });

	            return [...processedSections, ...whatIfSections];
	        }

	        function indexKeyToHeatmapIndexName(indexKey) {
	            const map = {
	                vn30: 'VN30',
	                vn100: 'VN100',
	                vnmidcap: 'VNMID',
	                vnsml: 'VNSML',
	                vnfinselect: 'VNFINSELECT',
	                vndiamond: 'VNDIAMOND',
	                vnreal: 'VNREAL',
	                vnit: 'VNIT',
	                vnheal: 'VNHEAL',
	                vnfin: 'VNFIN',
	                vnene: 'VNENE',
	                vncons: 'VNCONS',
	                vnmat: 'VNMAT',
	                vncond: 'VNCOND',
	            };
	            return map[indexKey] || null;
	        }

	        function getIndexHeatmapPayload(indexKey) {
	            const idxName = indexKeyToHeatmapIndexName(indexKey);
	            const payload = (typeof window !== 'undefined' && window.UI_GLM_INDEX_HEATMAPS) ? window.UI_GLM_INDEX_HEATMAPS : null;
	            const indices = payload && payload.indices ? payload.indices : null;
	            const asof = payload && payload.asof ? payload.asof : '';
	            const idxData = idxName && indices && indices[idxName] ? indices[idxName] : null;
	            if (!idxName || !idxData) return null;
	            return {
	                indexName: idxName,
	                asof,
	                gainers: Array.isArray(idxData.gainers) ? idxData.gainers : [],
	                losers: Array.isArray(idxData.losers) ? idxData.losers : [],
	                countPos: idxData.count_pos,
	                countNeg: idxData.count_neg,
	            };
	        }

	        function getSectionsForIndex(indexKey) {
	            const indexData = data[indexKey];
	            const base = filterSectionsForCurrentPlan(processSections(indexData));
	            if (!indexKey || indexKey === 'overview' || indexKey === 'vnindex') return base;

	            const payload = getIndexHeatmapPayload(indexKey);
	            if (!payload) return base;
	            if (isMobileViewport()) return base;

	            return base.concat([
	                {
	                    title: 'ðŸ”¥ Heatmap cá»• phiáº¿u TÄ‚NG GIÃ',
	                    icon: 'ðŸ”¥',
	                    content: '',
	                    alert: false,
	                    __uiType: 'heatmap_gainers',
	                },
	                {
	                    title: 'ðŸ”¥ Heatmap cá»• phiáº¿u GIáº¢M GIÃ',
	                    icon: 'ðŸ”¥',
	                    content: '',
	                    alert: false,
	                    __uiType: 'heatmap_losers',
	                }
	            ]);
	        }

        // ---------------------------
        // Overview extras: summary table + heatmaps (inside `Tá»”NG QUAN THá»Š TRÆ¯á»œNG`)
        // ---------------------------

        function normalizeTitle(title) {
            return (title || '').replace(/`/g, '').trim().toUpperCase();
        }

        function isMobileViewport() {
            try {
                return !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
            } catch (_) {
                return false;
            }
        }

        function cssVar(name, fallback = '') {
            try {
                const v = getComputedStyle(document.body).getPropertyValue(name).trim();
                return v || fallback;
            } catch (_) {
                return fallback;
            }
        }

		        function scrollWindowToEl(el, yPad = 12) {
		            if (!el) return;
		            try {
		                const scroller = document.scrollingElement || document.documentElement;
	                const top = Math.max(0, scroller.scrollTop + el.getBoundingClientRect().top - (yPad || 0));
	                try { scroller.scrollTo({ top, behavior: 'smooth' }); } catch (_) {}
	                try { window.scrollTo({ top, behavior: 'smooth' }); } catch (_) {}
	            } catch (_) {
	                try { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) {}
	            }
	        }

	        function scrollToElAfterRender(el, yPad = 12) {
	            if (!el) return;
	            const reduceMotion =
	                !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
	            const behavior = reduceMotion ? 'auto' : 'smooth';
	            const run = () => {
	                try {
	                    const scroller = document.scrollingElement || document.documentElement;
	                    const top = Math.max(0, scroller.scrollTop + el.getBoundingClientRect().top - (yPad || 0));
	                    try { scroller.scrollTo({ top, behavior }); } catch (_) {}
	                    try { window.scrollTo({ top, behavior }); } catch (_) {}
	                } catch (_) {
	                    try { el.scrollIntoView({ behavior, block: 'start' }); } catch (_) {}
	                }
	            };
            try {
                if (typeof requestAnimationFrame === 'function') {
                    requestAnimationFrame(() => requestAnimationFrame(run));
                } else {
                    setTimeout(run, 0);
                }
            } catch (_) {
                run();
            }
        }

	        function htmlToPlainText(html) {
	            const div = document.createElement('div');
	            div.innerHTML = html || '';
	            return (div.textContent || div.innerText || '').replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
	        }

	        function escapeHtml(text) {
	            return String(text == null ? '' : text)
	                .replace(/&/g, '&amp;')
	                .replace(/</g, '&lt;')
	                .replace(/>/g, '&gt;')
	                .replace(/\"/g, '&quot;')
	                .replace(/'/g, '&#39;');
	        }

	        function parseCompactNumberToFloat(text) {
	            if (!text) return null;
	            const raw = String(text).trim();
	            const m = raw.match(/^([0-9]+(?:[.,][0-9]+)?)\s*([KMB]|triá»‡u|tá»·)?$/i);
            if (!m) {
                // Fallback: strip commas
                const n = Number(raw.replace(/,/g, ''));
                return Number.isFinite(n) ? n : null;
            }
            const val = Number(String(m[1]).replace(/,/g, '.'));
            if (!Number.isFinite(val)) return null;
            const unit = (m[2] || '').toLowerCase();
            if (unit === 'k') return val * 1_000;
            if (unit === 'm' || unit === 'triá»‡u') return val * 1_000_000;
            if (unit === 'b' || unit === 'tá»·') return val * 1_000_000_000;
            return val;
        }

        function formatCompactNumber(num) {
            if (num == null || !Number.isFinite(num)) return 'N/A';
            const abs = Math.abs(num);
            if (abs >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1) + 'B';
            if (abs >= 1_000_000) return (num / 1_000_000).toFixed(1) + 'M';
            if (abs >= 1_000) return (num / 1_000).toFixed(1) + 'K';
            return String(Math.round(num));
        }

	        function parseIndexMetrics(indexKey) {
	            // Prefer deterministic metrics from index OHLCV export (market monthly DB)
	            // to avoid brittle regex parsing from AI text (especially VNSML / VNFINSELECT).
	            try {
	                const ohlcv = getIndexOhlcvPayload(indexKey);
	                if (ohlcv && Array.isArray(ohlcv.bars) && ohlcv.bars.length >= 2) {
	                    const bars = ohlcv.bars;
	                    const last = bars[bars.length - 1] || null;
	                    const prev = bars[bars.length - 2] || null;
	                    const lastClose = last && Number(last.c);
	                    const prevClose = prev && Number(prev.c);
	                    const lastVol = last && Number(last.v);
	
	                    let changePct = null;
	                    let changeText = null;
	                    if (Number.isFinite(lastClose) && Number.isFinite(prevClose) && prevClose !== 0) {
	                        changePct = (lastClose / prevClose - 1) * 100;
	                        changeText = (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%';
	                    }
	
	                    const priceText = Number.isFinite(lastClose) ? lastClose.toLocaleString(undefined, { maximumFractionDigits: 2 }) : null;
	                    const volumeValue = Number.isFinite(lastVol) ? lastVol : null;
	                    const volumeText = volumeValue != null ? formatCompactNumber(volumeValue) : null;
	                    return { priceText, changePct, changeText, volumeText, volumeValue };
	                }
	            } catch (_) {}

	            const idx = data[indexKey];
	            if (!idx || !Array.isArray(idx.sections)) return null;
	            const text = idx.sections.map(s => htmlToPlainText(s.content)).join('\n');

            const priceMatch = text.match(/GiÃ¡\s*hiá»‡n\s*táº¡i\s*(?:\(|:)?\s*([0-9][0-9.,]*)/i);
            const priceText = priceMatch ? String(priceMatch[1]).replace(/[,\.\)\]\s]+$/g, '').trim() : null;

            let changePct = null;
            let changeText = null;
            const changeMatch =
                text.match(/GiÃ¡\s*hiá»‡n\s*táº¡i[\s\S]{0,180}?(tÄƒng|giáº£m)\s*([+-]?\d+(?:\.\d+)?)\s*%/i) ||
                text.match(/\b(tÄƒng|giáº£m)\s*([+-]?\d+(?:\.\d+)?)\s*%/i);

            if (changeMatch) {
                const dir = (changeMatch[1] || '').toLowerCase();
                const raw = Number(changeMatch[2]);
                if (Number.isFinite(raw)) {
                    changePct = dir === 'giáº£m' ? -Math.abs(raw) : Math.abs(raw);
                    changeText = (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%';
                }
            }

            const volMatch =
                text.match(/Khá»‘i\s+lÆ°á»£ng(?:\s+phiÃªn)?\s+hiá»‡n\s+táº¡i\s*(?:\(|:)?\s*([0-9][0-9,\.]*\s*(?:[KMB]|triá»‡u|tá»·)?)?/i) ||
                text.match(/thanh\s*khoáº£n[^\n]{0,60}?\s+([0-9][0-9,\.]*\s*(?:triá»‡u|tá»·|[KMB])?)/i);

            const volumeText = volMatch ? String(volMatch[1] || '').trim() : null;
            const volumeValue = volumeText ? parseCompactNumberToFloat(volumeText.replace(/cá»•\s*phiáº¿u/i, '').trim()) : null;

            return { priceText, changePct, changeText, volumeText, volumeValue };
        }

	        function getSummaryIndexRows() {
	            const keys = [
	                ['vnindex', 'VNINDEX'],
	                ['vn30', 'VN30'],
                ['vn100', 'VN100'],
                ['vnmidcap', 'VNMIDCAP'],
                ['vnsml', 'VNSML'],
                ['vnfinselect', 'VNFINSELECT'],
                ['vndiamond', 'VNDIAMOND'],
                ['vnreal', 'VNREAL'],
                ['vnit', 'VNIT'],
                ['vnheal', 'VNHEAL'],
                ['vnfin', 'VNFIN'],
                ['vnene', 'VNENE'],
                ['vncons', 'VNCONS'],
                ['vnmat', 'VNMAT'],
                ['vncond', 'VNCOND'],
            ];

	            return keys.map(([key, label]) => ({ key, label, ...(parseIndexMetrics(key) || {}) }));
	        }

	        function renderSummaryCards(rows) {
	            const cards = rows.map(r => {
	                const cls =
	                    r.changePct == null ? 'neutral' :
	                    (r.changePct > 0 ? 'positive' : (r.changePct < 0 ? 'negative' : 'neutral'));

	                const change = r.changeText || 'â€”';

	                return `
	                    <button type="button" class="idx-card idx-card-btn" onclick="openIndexPopup('${r.key}')">
	                        <div class="idx-top">
	                            <div class="idx-code">${r.label}</div>
	                            <div class="idx-change"><span class="chip ${cls}">${change}</span></div>
	                        </div>
	                    </button>
	                `;
	            }).join('');

	            return `<div class="idx-cards">${cards}</div>`;
	        }

		        function renderIndexHeatmap(rows) {
		            const tiles = rows.map(r => {
		                const change = r.changeText || 'N/A';
		                const vol = r.volumeText || 'N/A';
		                const title = `${r.label} | ${change} | Vol ${vol}`;
		                return `
		                    <button type="button" class="heatmap-tile heatmap-tile-btn" title="${escapeHtml(title)}" onclick="openIndexPopup('${r.key}')">
		                        <div class="symbol">${r.label}</div>
		                        <div class="metric">${change}</div>
		                    </button>
		                `;
		            }).join('');

            return `<div class="heatmap-index-grid">${tiles}</div>`;
        }

	        function renderStockHeatmapTable(points, title) {
	            if (!points || !points.length) {
	                return `
	                    <div class="block heatmap-block">
	                        <div class="block-header">${escapeHtml(title)}</div>
	                        <div class="block-body"><div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u.</p></div></div>
	                    </div>
	                `;
	            }

	            const changeSeries = points
	                .map(p => Number(p && p.change_pct))
	                .filter(v => Number.isFinite(v));
	            const maxAbsChange = (changeSeries.length ? Math.max(...changeSeries.map(v => Math.abs(v))) : 0) || 1;
	            const cols = 6;
	            const rows = Math.ceil(points.length / cols);

            let html = '';
            let idx = 0;
            for (let r = 0; r < rows; r++) {
                let rowHtml = '';
                for (let c = 0; c < cols; c++) {
                    if (idx >= points.length) {
                        rowHtml += '<td></td>';
                        continue;
                    }
	                    const p = points[idx++];
		                    const symbol = (p && p.symbol != null ? String(p.symbol) : '').trim();
		                    const changePct = Number(p && p.change_pct);
		                    const changeOk = Number.isFinite(changePct);
		                    const changeFactor = changeOk ? Math.min(Math.abs(changePct) / maxAbsChange, 1) : 0;
		                    const sizePercent = 60 + Math.round(40 * changeFactor);
		                    const changeStr = changeOk ? ((changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%') : 'N/A';
		                    const priceStr = (p && p.price != null && Number.isFinite(Number(p.price))) ? Number(p.price).toFixed(2) : 'N/A';
		                    const valueStr = p && p.value != null && Number.isFinite(Number(p.value)) ? formatCompactNumber(Number(p.value)) : 'N/A';
		                    const volumeStr = p && p.volume != null && Number.isFinite(Number(p.volume)) ? formatCompactNumber(Number(p.volume)) : 'N/A';
	                    const metaAll = (typeof window !== 'undefined' && window.UI_GLM_COMPANY_META) ? window.UI_GLM_COMPANY_META : null;
	                    const meta = metaAll && symbol && metaAll[symbol] ? metaAll[symbol] : null;
	                    const sectorRaw = meta && meta.sector ? String(meta.sector) : '';
	                    const sectorParts = sectorRaw && sectorRaw.includes('/') ? sectorRaw.split('/') : null;
	                    const sectorVi = sectorParts && sectorParts[1] ? sectorParts[1] : sectorRaw;
	                    const tooltip = `${symbol || 'N/A'} | ${changeStr}${sectorVi ? ' | ' + sectorVi : ''}`;

		                    rowHtml += `
		                        <td class="heatmap-cell" title="${escapeHtml(tooltip)}">
		                            <button type="button" class="heatmap-cell-btn"
		                                    data-symbol="${escapeHtml(symbol || 'N/A')}"
		                                    data-change-pct="${changeOk ? String(changePct) : ''}"
		                                    data-price="${escapeHtml(priceStr)}"
	                                    data-value="${escapeHtml(valueStr)}"
	                                    data-volume="${escapeHtml(volumeStr)}"
	                                    onclick="openVnindexStockPopupFromEl(this)">
	                                <div class="heatmap-symbol" style="width:${sizePercent}%">${escapeHtml(symbol || 'N/A')}</div>
	                                <div class="heatmap-metric" style="width:${sizePercent}%">${changeStr}</div>
	                            </button>
	                        </td>
	                    `;
                }
                html += `<tr>${rowHtml}</tr>`;
            }

	            return `
	                <div class="block heatmap-block" data-popup-title="${escapeHtml(title)}">
	                    <div class="block-header">
	                        <span>${escapeHtml(title)}</span>
	                        <button type="button" class="block-expand" onclick="openBlockPopup(this)">Xem lá»›n</button>
	                    </div>
	                    <div class="block-body">
	                        <table class="heatmap-table" role="presentation" cellpadding="0" cellspacing="0">
	                            ${html}
	                        </table>
	                    </div>
	                </div>
	            `;
	        }

	        function renderIndexHeatmapSection(indexKey, kind) {
	            const payload = getIndexHeatmapPayload(indexKey);
	            if (!payload) {
	                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u heatmap cho index nÃ y.</p></div>`;
	            }

	            const dateText = payload.asof ? ` (date: ${payload.asof})` : '';
	            const points = kind === 'gainers' ? payload.gainers : payload.losers;
	            const title =
	                kind === 'gainers'
	                    ? `ðŸ”¥ Heatmap cá»• phiáº¿u TÄ‚NG GIÃ${dateText}`
	                    : `ðŸ”¥ Heatmap cá»• phiáº¿u GIáº¢M GIÃ${dateText}`;

	            return `<div class="overview-extras" style="margin-top: 0;">${renderStockHeatmapTable(points, title)}</div>`;
	        }

		        function getIndexOhlcvPayload(indexKey) {
		            const payload = (typeof window !== 'undefined' && window.UI_GLM_INDEX_OHLCV) ? window.UI_GLM_INDEX_OHLCV : null;
		            const indices = payload && payload.indices ? payload.indices : null;
		            const idx = indices && indexKey ? indices[indexKey] : null;
		            if (!idx || !Array.isArray(idx.bars) || !idx.bars.length) return null;
		            return {
		                asof: payload.asof || '',
		                name: idx.name || '',
		                method: idx.method || '',
		                constituents: idx.constituents || null,
		                bars: idx.bars,
		            };
		        }

			        function extractKeyPriceZonesFromHtml(html) {
			            const el = document.createElement('div');
			            el.innerHTML = html || '';
			            const text = (el.textContent || '').replace(/\s+/g, ' ').trim();
			            if (!text) return [];

			            const parseNumber = (raw) => {
			                if (!raw) return null;
			                let s = String(raw).trim();
			                s = s.replace(/\s/g, '');
			                s = s.replace(/[()]/g, '');
			                s = s.replace(/[^0-9,.\-â€“~]/g, '');
			                if (!s) return null;

			                const hasComma = s.includes(',');
			                const hasDot = s.includes('.');
			                if (hasComma && hasDot) {
			                    s = s.replace(/,/g, '');
			                } else if (hasComma && !hasDot) {
			                    const parts = s.split(',');
			                    const last = parts[parts.length - 1] || '';
			                    if (last.length !== 3) s = s.replace(/,/g, '.');
			                    else s = s.replace(/,/g, '');
			                } else if (!hasComma && hasDot) {
			                    const parts = s.split('.');
			                    const last = parts[parts.length - 1] || '';
			                    if (last.length === 3 && parts.length > 1) s = s.replace(/\./g, '');
			                }
			                const v = Number(s);
			                return Number.isFinite(v) ? v : null;
			            };

			            const parseRange = (raw) => {
			                if (!raw) return null;
			                const s = String(raw).replace(/[â€“~]/g, '-');
			                const m = s.match(/([0-9][0-9,.\s]*)\s*(?:-|Ä‘áº¿n|to)\s*([0-9][0-9,.\s]*)/i);
			                if (!m) return null;
			                const a = parseNumber(m[1]);
			                const b = parseNumber(m[2]);
			                if (a == null || b == null) return null;
			                const low = Math.min(a, b);
			                const high = Math.max(a, b);
			                if (!Number.isFinite(low) || !Number.isFinite(high) || low === high) return null;
			                return { low, high };
			            };

			            const zones = [];
			            const pushZone = (z) => {
			                if (!z) return;
			                const key = `${z.kind}|${z.label}|${z.low ?? ''}|${z.high ?? ''}|${z.price ?? ''}`;
			                zones.__seen = zones.__seen || new Set();
			                if (zones.__seen.has(key)) return;
			                zones.__seen.add(key);
			                zones.push(z);
			            };

			            // Focused core extractor: H1â€“H3 and R1â€“R3 from the "Má»¨C GIÃ QUAN TRá»ŒNG" section.
			            // Prefer ranges (zones) over single lines.
			            const hrRe = /\b(H|R)\s*(\d{1,2})\s*\(([^)]{1,80})\)/gi;
			            let m;
			            while ((m = hrRe.exec(text)) !== null) {
			                const idx = Number(m[2]);
			                if (![1, 2, 3].includes(idx)) continue;
			                const kind = (m[1] || '').toUpperCase() === 'H' ? 'support' : 'resistance';
			                const label = `${(m[1] || '').toUpperCase()}${idx}`;
			                const inside = (m[3] || '').trim();
			                const r = parseRange(inside);
			                if (r) {
			                    pushZone({ kind, label, low: r.low, high: r.high });
			                    continue;
			                }
			                const n = parseNumber(inside);
			                if (n != null) pushZone({ kind, label, price: n });
			            }

			            if (zones.__seen) delete zones.__seen;

			            const cleaned = zones.filter(z => {
			                const v = (z.price != null) ? z.price : ((z.low + z.high) / 2);
			                return typeof v === 'number' && Number.isFinite(v) && v > 0 && v < 1e7;
			            });
			            const rank = (k) => (k === 'support' ? 0 : 1);
			            cleaned.sort((a, b) => {
			                const ra = rank(a.kind), rb = rank(b.kind);
			                if (ra !== rb) return ra - rb;
			                const va = (a.price != null ? a.price : ((a.low + a.high) / 2));
			                const vb = (b.price != null ? b.price : ((b.low + b.high) / 2));
			                return va - vb;
			            });
			            return cleaned;
			        }

		        function renderKeyLevelsPanelHtml(panelId, indexKey) {
		            const payload = getIndexOhlcvPayload(indexKey);
		            if (!payload) {
		                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u giÃ¡ cho index nÃ y.</p></div>`;
		            }
		            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
		            const metaRight = payload.name ? `Index: ${escapeHtml(payload.name)}` : '';
		            return `
		                <div class="keylevels-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
		                    <div class="keylevels-toolbar">
		                        <div class="title">Biá»ƒu Ä‘á»“ giÃ¡ &amp; vÃ¹ng quan trá»ng</div>
		                        <div class="keylevels-controls">
		                            <div class="keylevels-segment" data-role="side">
		                                <button class="keylevels-segbtn active" data-side="both" type="button">Cáº£ hai</button>
		                                <button class="keylevels-segbtn" data-side="support" type="button">BÃªn Mua</button>
		                                <button class="keylevels-segbtn" data-side="resistance" type="button">BÃªn BÃ¡n</button>
		                            </div>
		                            <div class="keylevels-checks" data-role="levels">
		                                ${['H1','H2','H3','R1','R2','R3'].map(l => `
		                                    <label class="keylevels-check">
		                                        <input type="checkbox" data-level="${l}" checked />
		                                        <span>${l}</span>
		                                    </label>
		                                `).join('')}
		                            </div>
		                        </div>
		                    </div>
		                    <div class="keylevels-body">
		                        <div class="keylevels-chart" data-role="chart"></div>
		                        <div class="keylevels-tags" data-role="tags"></div>
		                        <div class="ohlcv-meta" style="margin-top:10px;">
		                            <div>${metaLeft}</div>
		                            <div>${metaRight}</div>
		                        </div>
		                    </div>
		                </div>
		            `;
		        }

			        function initKeyLevelsPanel(panelId, indexKey, sectionHtml) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
		            const payload = getIndexOhlcvPayload(indexKey);
		            if (!payload) return;
		            const chartEl = panelEl.querySelector('[data-role="chart"]');
		            const tagsEl = panelEl.querySelector('[data-role="tags"]');
		            if (!chartEl || typeof LightweightCharts === 'undefined') return;

		            const barsAll = payload.bars || [];
		            const bars = barsAll.slice(-Math.min(200, barsAll.length));
		            if (bars.length < 5) return;

		            const allZones = extractKeyPriceZonesFromHtml(sectionHtml || '');

		            const sideEl = panelEl.querySelector('[data-role="side"]');
		            const levelsEl = panelEl.querySelector('[data-role="levels"]');
		            const getSelectedSide = () => {
		                const btn = sideEl ? sideEl.querySelector('.keylevels-segbtn.active') : null;
		                const v = btn ? btn.getAttribute('data-side') : 'both';
		                return v || 'both';
		            };
		            const getSelectedLevels = () => {
		                const set = new Set();
		                if (!levelsEl) return set;
		                levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
		                    if (inp.checked) set.add(inp.getAttribute('data-level'));
		                });
		                return set;
		            };

		            const filterZones = () => {
		                const side = getSelectedSide();
		                const levels = getSelectedLevels();
		                return allZones.filter(z => {
		                    if (levels.size && !levels.has(z.label)) return false;
		                    if (side === 'support') return z.kind === 'support';
		                    if (side === 'resistance') return z.kind === 'resistance';
		                    return true;
		                });
		            };

		            const renderTags = (zones) => {
		                if (!tagsEl) return;
		                if (!zones.length) {
		                    tagsEl.innerHTML = `<span class="keylevels-tag">KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c H1â€“H3/R1â€“R3 tá»« bÃ¡o cÃ¡o.</span>`;
		                    return;
		                }
		                const toText = (z) => {
		                    if (z.low != null && z.high != null) return `${z.label}: ${z.low.toLocaleString()}â€“${z.high.toLocaleString()}`;
		                    return `${z.label}: ${(z.price ?? 0).toLocaleString()}`;
		                };
		                tagsEl.innerHTML = zones.map(z =>
		                    `<span class="keylevels-tag ${z.kind}">${escapeHtml(toText(z))}</span>`
		                ).join('');
		            };

		            const theme = document.body.getAttribute('data-theme') || 'light';
		            const isDark = theme === 'dark';
		            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
		            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
		            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';

		            const draw = () => {
		                const zones = filterZones();
		                renderTags(zones);

		                if (panelEl.__uiGlmKeyChart) {
		                    try { panelEl.__uiGlmKeyChart.remove(); } catch (_) {}
		                    panelEl.__uiGlmKeyChart = null;
		                }
		                const chart = LightweightCharts.createChart(chartEl, {
		                    layout: {
		                        background: { type: 'solid', color: chartBg },
		                        textColor: textCol,
		                        attributionLogo: false,
		                        fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
		                        fontSize: 12,
		                    },
		                    grid: {
		                        vertLines: { color: gridCol },
		                        horzLines: { color: gridCol },
		                    },
		                    rightPriceScale: { borderVisible: false },
		                    timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
		                    crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
		                    handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
		                    handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
		                    height: chartEl.clientHeight || 380,
		                    width: chartEl.clientWidth || 700,
		                });
			                panelEl.__uiGlmKeyChart = chart;

			                const lineCol = cssVar('--primary-light', isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)');
			                const line = chart.addLineSeries({
			                    color: lineCol,
			                    lineWidth: 2,
			                });
			                line.setData(bars.map(b => ({ time: b.d, value: b.c })));

		                const makeLine = (price, color, title, axisVisible, width, style) => {
		                    try {
		                        return line.createPriceLine({
		                            price,
		                            color,
		                            lineWidth: width,
		                            lineStyle: style,
		                            axisLabelVisible: axisVisible,
		                            title: title || '',
		                        });
		                    } catch (_) {
		                        return null;
		                    }
		                };

			                const supportCol = cssVar('--chart-level-support', 'rgba(16,185,129,0.92)');
			                const resistCol = cssVar('--chart-level-resist', 'rgba(239,68,68,0.92)');
			                const supportSoft = cssVar('--chart-up-soft', 'rgba(16,185,129,0.45)');
			                const resistSoft = cssVar('--chart-down-soft', 'rgba(239,68,68,0.45)');

			                for (const z of zones) {
			                    const color = z.kind === 'support' ? supportCol : resistCol;
			                    const soft = z.kind === 'support' ? supportSoft : resistSoft;
			                    const style = LightweightCharts.LineStyle.Dashed;
			                    if (z.low != null && z.high != null) {
			                        const mid = (z.low + z.high) / 2;
			                        makeLine(z.low, soft, '', false, 1, style);
			                        makeLine(z.high, soft, '', false, 1, style);
			                        makeLine(mid, color, z.label || '', true, 2, style);
			                    } else if (z.price != null) {
			                        makeLine(z.price, color, z.label || '', true, 2, style);
			                    }
		                }

		                chart.timeScale().fitContent();

		                if (panelEl.__uiGlmKeyResizeObs) {
		                    try { panelEl.__uiGlmKeyResizeObs.disconnect(); } catch (_) {}
		                    panelEl.__uiGlmKeyResizeObs = null;
		                }
		                const ro = new ResizeObserver(() => {
		                    try {
		                        chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
		                        chart.timeScale().fitContent();
		                    } catch (_) {}
		                });
		                ro.observe(chartEl);
		                panelEl.__uiGlmKeyResizeObs = ro;
		            };

		            const bindControls = () => {
		                if (sideEl) {
		                    sideEl.querySelectorAll('.keylevels-segbtn[data-side]').forEach(btn => {
		                        btn.addEventListener('click', () => {
		                            sideEl.querySelectorAll('.keylevels-segbtn').forEach(b => b.classList.remove('active'));
		                            btn.classList.add('active');
		                            draw();
		                        });
		                    });
		                }
		                if (levelsEl) {
		                    levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
		                        inp.addEventListener('change', () => draw());
		                    });
		                }
		            };

			            bindControls();
			            draw();
			        }

			        function extractTargetPriceZonesFromHtml(html) {
			            const base = extractKeyPriceZonesFromHtml(html);
			            const keep = new Set(['H1', 'H2', 'R1', 'R2']);
			            return (Array.isArray(base) ? base : []).filter(z => z && keep.has(z.label));
			        }

			        function renderTargetLevelsPanelHtml(panelId, indexKey) {
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) {
			                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u giÃ¡ cho index nÃ y.</p></div>`;
			            }
			            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
			            const metaRight = payload.name ? `Index: ${escapeHtml(payload.name)}` : '';
			            return `
			                <div class="targetlevels-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="keylevels-toolbar">
			                        <div class="title">Biá»ƒu Ä‘á»“ giÃ¡ &amp; vÃ¹ng má»¥c tiÃªu</div>
			                        <div class="keylevels-controls">
			                            <div class="keylevels-segment" data-role="side">
			                                <button class="keylevels-segbtn active" data-side="both" type="button">Cáº£ hai</button>
			                                <button class="keylevels-segbtn" data-side="support" type="button">BÃªn Mua</button>
			                                <button class="keylevels-segbtn" data-side="resistance" type="button">BÃªn BÃ¡n</button>
			                            </div>
			                            <div class="keylevels-checks" data-role="levels">
			                                ${['H1','H2','R1','R2'].map(l => `
			                                    <label class="keylevels-check">
			                                        <input type="checkbox" data-level="${l}" checked />
			                                        <span>${l}</span>
			                                    </label>
			                                `).join('')}
			                            </div>
			                        </div>
			                    </div>
			                    <div class="keylevels-body">
			                        <div class="keylevels-chart" data-role="chart"></div>
			                        <div class="keylevels-tags" data-role="tags"></div>
			                        <div class="ohlcv-meta" style="margin-top:10px;">
			                            <div>${metaLeft}</div>
			                            <div>${metaRight}</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function initTargetLevelsPanel(panelId, indexKey, sectionHtml) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) return;
			            const chartEl = panelEl.querySelector('[data-role="chart"]');
			            const tagsEl = panelEl.querySelector('[data-role="tags"]');
			            if (!chartEl || typeof LightweightCharts === 'undefined') return;

			            const barsAll = payload.bars || [];
			            const bars = barsAll.slice(-Math.min(200, barsAll.length));
			            if (bars.length < 5) return;

			            const allZones = extractTargetPriceZonesFromHtml(sectionHtml || '');

			            const sideEl = panelEl.querySelector('[data-role="side"]');
			            const levelsEl = panelEl.querySelector('[data-role="levels"]');
			            const getSelectedSide = () => {
			                const btn = sideEl ? sideEl.querySelector('.keylevels-segbtn.active') : null;
			                const v = btn ? btn.getAttribute('data-side') : 'both';
			                return v || 'both';
			            };
			            const getSelectedLevels = () => {
			                const set = new Set();
			                if (!levelsEl) return set;
			                levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
			                    if (inp.checked) set.add(inp.getAttribute('data-level'));
			                });
			                return set;
			            };

			            const filterZones = () => {
			                const side = getSelectedSide();
			                const levels = getSelectedLevels();
			                return allZones.filter(z => {
			                    if (levels.size && !levels.has(z.label)) return false;
			                    if (side === 'support') return z.kind === 'support';
			                    if (side === 'resistance') return z.kind === 'resistance';
			                    return true;
			                });
			            };

			            const renderTags = (zones) => {
			                if (!tagsEl) return;
			                if (!zones.length) {
			                    tagsEl.innerHTML = `<span class="keylevels-tag">KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c H1â€“H2/R1â€“R2 tá»« bÃ¡o cÃ¡o.</span>`;
			                    return;
			                }
			                const toText = (z) => {
			                    if (z.low != null && z.high != null) return `${z.label}: ${z.low.toLocaleString()}â€“${z.high.toLocaleString()}`;
			                    return `${z.label}: ${(z.price ?? 0).toLocaleString()}`;
			                };
			                tagsEl.innerHTML = zones.map(z =>
			                    `<span class="keylevels-tag ${z.kind}">${escapeHtml(toText(z))}</span>`
			                ).join('');
			            };

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';

			            const draw = () => {
			                const zones = filterZones();
			                renderTags(zones);

			                if (panelEl.__uiGlmTargetChart) {
			                    try { panelEl.__uiGlmTargetChart.remove(); } catch (_) {}
			                    panelEl.__uiGlmTargetChart = null;
			                }
			                const chart = LightweightCharts.createChart(chartEl, {
			                    layout: {
			                        background: { type: 'solid', color: chartBg },
			                        textColor: textCol,
			                        attributionLogo: false,
			                        fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                        fontSize: 12,
			                    },
			                    grid: {
			                        vertLines: { color: gridCol },
			                        horzLines: { color: gridCol },
			                    },
			                    rightPriceScale: { borderVisible: false },
			                    timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
			                    crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
			                    handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                    handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                    height: chartEl.clientHeight || 380,
			                    width: chartEl.clientWidth || 700,
			                });
			                panelEl.__uiGlmTargetChart = chart;

				                const lineCol = cssVar('--primary-light', isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)');
				                const line = chart.addLineSeries({
				                    color: lineCol,
				                    lineWidth: 2,
				                });
			                line.setData(bars.map(b => ({ time: b.d, value: b.c })));

			                const makeLine = (price, color, title, axisVisible, width, style) => {
			                    try {
			                        return line.createPriceLine({
			                            price,
			                            color,
			                            lineWidth: width,
			                            lineStyle: style,
			                            axisLabelVisible: axisVisible,
			                            title: title || '',
			                        });
			                    } catch (_) {
			                        return null;
			                    }
			                };

			                const supportCol = cssVar('--chart-level-support', 'rgba(16,185,129,0.92)');
			                const resistCol = cssVar('--chart-level-resist', 'rgba(239,68,68,0.92)');
			                const supportSoft = cssVar('--chart-up-soft', 'rgba(16,185,129,0.45)');
			                const resistSoft = cssVar('--chart-down-soft', 'rgba(239,68,68,0.45)');

			                for (const z of zones) {
			                    const color = z.kind === 'support' ? supportCol : resistCol;
			                    const soft = z.kind === 'support' ? supportSoft : resistSoft;
			                    const style = LightweightCharts.LineStyle.Dashed;
			                    if (z.low != null && z.high != null) {
			                        const mid = (z.low + z.high) / 2;
			                        makeLine(z.low, soft, '', false, 1, style);
			                        makeLine(z.high, soft, '', false, 1, style);
			                        makeLine(mid, color, z.label || '', true, 2, style);
			                    } else if (z.price != null) {
			                        makeLine(z.price, color, z.label || '', true, 2, style);
			                    }
			                }

			                chart.timeScale().fitContent();

			                if (panelEl.__uiGlmTargetResizeObs) {
			                    try { panelEl.__uiGlmTargetResizeObs.disconnect(); } catch (_) {}
			                    panelEl.__uiGlmTargetResizeObs = null;
			                }
			                const ro = new ResizeObserver(() => {
			                    try {
			                        chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
			                        chart.timeScale().fitContent();
			                    } catch (_) {}
			                });
			                ro.observe(chartEl);
			                panelEl.__uiGlmTargetResizeObs = ro;
			            };

			            const bindControls = () => {
			                if (sideEl) {
			                    sideEl.querySelectorAll('.keylevels-segbtn[data-side]').forEach(btn => {
			                        btn.addEventListener('click', () => {
			                            sideEl.querySelectorAll('.keylevels-segbtn').forEach(b => b.classList.remove('active'));
			                            btn.classList.add('active');
			                            draw();
			                        });
			                    });
			                }
			                if (levelsEl) {
			                    levelsEl.querySelectorAll('input[type="checkbox"][data-level]').forEach(inp => {
			                        inp.addEventListener('change', () => draw());
			                    });
			                }
			            };

			            bindControls();
			            draw();
			        }

			        function renderIndexPricePanelHtml(panelId, indexKey, mode = 'line') {
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) {
			                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u giÃ¡ cho index nÃ y.</p></div>`;
			            }

			            const title = mode === 'candles' ? 'Biá»ƒu Ä‘á»“ náº¿n (giÃ¡)' : 'Biá»ƒu Ä‘á»“ giÃ¡ (Close)';
			            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
			            const metaRight = payload.name ? `Index: ${escapeHtml(payload.name)}` : '';

			            return `
			                <div class="price-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}" data-mode="${escapeHtml(mode)}">
			                    <div class="price-toolbar">
			                        <div class="title">${escapeHtml(title)}</div>
			                        <div class="note">100 phiÃªn (cá»‘ Ä‘á»‹nh)</div>
			                    </div>
			                    <div class="price-body">
			                        <div class="price-chart" data-role="chart"></div>
			                        <div class="ohlcv-meta" style="margin-top:10px;">
			                            <div>${metaLeft}</div>
			                            <div>${metaRight}</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function initIndexPricePanel(panelId, indexKey, mode = 'line') {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) return;
			            const chartEl = panelEl.querySelector('[data-role="chart"]');
			            if (!chartEl || typeof LightweightCharts === 'undefined') return;

			            const barsAll = payload.bars || [];
			            const bars = barsAll.slice(-Math.min(100, barsAll.length));
			            if (bars.length < 2) return;

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';
				            const upCol = cssVar('--chart-up', 'rgba(16,185,129,0.95)');
				            const downCol = cssVar('--chart-down', 'rgba(239,68,68,0.95)');
				            const wickCol = cssVar('--chart-wick', isDark ? 'rgba(226,232,240,0.55)' : 'rgba(15,23,42,0.35)');

			            if (panelEl.__uiGlmPriceChart) {
			                try { panelEl.__uiGlmPriceChart.remove(); } catch (_) {}
			                panelEl.__uiGlmPriceChart = null;
			            }

			            const chart = LightweightCharts.createChart(chartEl, {
			                layout: {
			                    background: { type: 'solid', color: chartBg },
			                    textColor: textCol,
			                    attributionLogo: false,
			                    fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                    fontSize: 12,
			                },
			                grid: {
			                    vertLines: { color: gridCol },
			                    horzLines: { color: gridCol },
			                },
			                rightPriceScale: { borderVisible: false },
			                timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
			                crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
			                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                height: chartEl.clientHeight || 220,
			                width: chartEl.clientWidth || 700,
			            });
			            panelEl.__uiGlmPriceChart = chart;

				            if (String(mode || 'line') === 'candles') {
				                const candles = chart.addCandlestickSeries({
				                    upColor: upCol,
				                    downColor: downCol,
				                    borderUpColor: upCol,
				                    borderDownColor: downCol,
				                    wickUpColor: wickCol,
				                    wickDownColor: wickCol,
				                });
				                candles.setData(bars.map(b => ({ time: b.d, open: b.o, high: b.h, low: b.l, close: b.c })));
				            } else {
				                const lineCol = cssVar('--primary-light', isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)');
				                const line = chart.addLineSeries({
				                    color: lineCol,
				                    lineWidth: 2,
				                });
				                line.setData(bars.map(b => ({ time: b.d, value: b.c })));
				            }

			            chart.timeScale().fitContent();

			            if (panelEl.__uiGlmPriceResizeObs) {
			                try { panelEl.__uiGlmPriceResizeObs.disconnect(); } catch (_) {}
			                panelEl.__uiGlmPriceResizeObs = null;
			            }
			            const ro = new ResizeObserver(() => {
			                try {
			                    chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
			                    chart.timeScale().fitContent();
			                } catch (_) {}
			            });
			            ro.observe(chartEl);
			            panelEl.__uiGlmPriceResizeObs = ro;
			        }

			        function getMarketBreadthSnapshotPayload() {
			            const payload =
			                (typeof window !== 'undefined' && window.UI_GLM_MARKET_BREADTH_SNAPSHOT)
			                    ? window.UI_GLM_MARKET_BREADTH_SNAPSHOT
			                    : null;
			            if (!payload || typeof payload !== 'object') return null;
			            if (payload.advancing == null || payload.declining == null) return null;
			            return payload;
			        }

			        function getBreadthHistoryPayload() {
			            const payload =
			                (typeof window !== 'undefined' && window.UI_GLM_BREADTH_HISTORY)
			                    ? window.UI_GLM_BREADTH_HISTORY
			                    : null;
			            if (!payload || typeof payload !== 'object') return null;
			            if (!Array.isArray(payload.series) || payload.series.length < 30) return null;
			            if (!payload.summary || typeof payload.summary !== 'object') return null;
			            return payload;
			        }

			        function renderBreadthHistoryPanelHtml(panelId, indexKey) {
			            const payload = getBreadthHistoryPayload();
			            if (!payload) {
			                return `<div class="info-box"><p>ChÆ°a cÃ³ dá»¯ liá»‡u breadth history (thiáº¿u file export).</p></div>`;
			            }
			            const asof = payload.asof || '';
			            const s = payload.summary || {};
			            const cur = s.current || {};
			            const pct = Number(s.percentile_ma20 || 0);
			            const vs1w = (s.vs_1w == null) ? null : Number(s.vs_1w);
			            const vs1m = (s.vs_1m == null) ? null : Number(s.vs_1m);
			            const chipCls = (v) => (v == null ? '' : (v >= 0 ? 'positive' : 'negative'));
			            const fmtPp = (v) => (v == null ? 'N/A' : `${v >= 0 ? '+' : ''}${v.toFixed(1)}pp`);

			            return `
			                <div class="bh-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="bh-toolbar">
			                        <div class="title">ðŸ“œ Lá»‹ch sá»­ &amp; xu hÆ°á»›ng Breadth</div>
			                        <div class="right">
			                            <div class="bh-meta">As-of: ${escapeHtml(asof)}</div>
			                            <div class="keylevels-checks" data-role="bh-levels">
			                                ${[
			                                    ['MA5','pct_ma5', false],
			                                    ['MA20','pct_ma20', true],
			                                    ['MA50','pct_ma50', false],
			                                    ['MA200','pct_ma200', false],
			                                ].map(([label, key, checked]) => `
			                                    <label class="keylevels-check">
			                                        <input type="checkbox" data-bh="${key}" ${checked ? 'checked' : ''} />
			                                        <span>${label}</span>
			                                    </label>
			                                `).join('')}
			                            </div>
			                        </div>
			                    </div>
			                    <div class="bh-body">
			                        <div class="bh-kpis">
			                            <div class="bh-card">
			                                <div class="k">
			                                    <span>Percentile breadth (MA20, ~2y)</span>
			                                    <span class="bh-chip">${Number(s.pct_ma20 || 0).toFixed(1)}%</span>
			                                </div>
			                                <div class="v">
			                                    <span>${pct.toFixed(1)}%</span>
			                                    <span class="bh-chip ${chipCls(vs1w)}">vs 1w: ${fmtPp(vs1w)}</span>
			                                    <span class="bh-chip ${chipCls(vs1m)}">vs 1m: ${fmtPp(vs1m)}</span>
			                                </div>
			                                <div class="bh-gauge" aria-hidden="true">
			                                    <span class="marker" style="left: calc(${Math.max(0, Math.min(100, pct)).toFixed(2)}% - 1px)"></span>
			                                </div>
			                            </div>
			                            <div class="bh-card">
			                                <div class="k">
			                                    <span>Cáº¥u trÃºc breadth Ä‘a khung</span>
			                                    <span class="bh-chip">(% mÃ£ &gt; MA)</span>
			                                </div>
			                                <div class="v" style="font-size: 1.02rem;">
			                                    <span class="bh-chip">MA5: ${Number(cur.pct_ma5 || 0).toFixed(1)}%</span>
			                                    <span class="bh-chip">MA20: ${Number(cur.pct_ma20 || 0).toFixed(1)}%</span>
			                                    <span class="bh-chip">MA50: ${Number(cur.pct_ma50 || 0).toFixed(1)}%</span>
			                                    <span class="bh-chip">MA200: ${Number(cur.pct_ma200 || 0).toFixed(1)}%</span>
			                                </div>
			                                <div style="margin-top:8px; color: var(--text-secondary); font-weight: 800; font-size: 0.86rem;">
			                                    DÃ¹ng checkbox phÃ­a trÃªn Ä‘á»ƒ xem â€œribbonâ€ MA Breadth.
			                                </div>
			                            </div>
			                        </div>

			                        <div class="bh-chart" data-role="bh-main"></div>

			                        <div class="bh-sparks">
				                            ${[
				                                ['MA5', 'pct_ma5'],
				                                ['MA20', 'pct_ma20'],
				                                ['MA50', 'pct_ma50'],
				                                ['MA200', 'pct_ma200'],
				                            ].map(([label, key]) => `
				                                <div class="bh-spark" role="button" tabindex="0"
				                                     data-bh-spark="${key}" data-bh-label="${label}"
				                                     onclick="openBreadthHistoryDetailFromEl(this)">
				                                    <div class="k"><span>${label}</span><span>${Number(cur[key] || 0).toFixed(1)}%</span></div>
				                                    <div class="spark" data-role="spark"></div>
				                                    <div style="margin-top:6px; color: var(--text-secondary); font-weight: 800; font-size: 0.74rem;">Nháº¥n Ä‘á»ƒ xem chi tiáº¿t</div>
				                                </div>
				                            `).join('')}
				                        </div>
				                    </div>
				                </div>
			            `;
			        }

				        function initBreadthHistoryPanel(panelId) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getBreadthHistoryPayload();
			            if (!payload) return;
			            const series = payload.series || [];
			            if (!Array.isArray(series) || series.length < 30) return;
			            if (typeof LightweightCharts === 'undefined') return;

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';

			            const levelsEl = panelEl.querySelector('[data-role="bh-levels"]');
			            const mainEl = panelEl.querySelector('[data-role="bh-main"]');
			            if (!mainEl) return;

			            const getSelected = () => {
			                const set = new Set();
			                if (!levelsEl) return set;
			                levelsEl.querySelectorAll('input[type="checkbox"][data-bh]').forEach(inp => {
			                    if (inp.checked) set.add(inp.getAttribute('data-bh'));
			                });
			                return set;
			            };

			            const buildLineData = (key) => {
			                return series
			                    .filter(r => r && r.d && r[key] != null && Number.isFinite(Number(r[key])))
			                    .map(r => ({ time: r.d, value: Number(r[key]) }));
			            };

				            const drawMain = () => {
				                if (panelEl.__uiGlmBhMainChart) {
				                    try { panelEl.__uiGlmBhMainChart.remove(); } catch (_) {}
				                    panelEl.__uiGlmBhMainChart = null;
				                }
				                const chart = LightweightCharts.createChart(mainEl, {
				                    layout: {
				                        background: { type: 'solid', color: chartBg },
				                        textColor: textCol,
			                        attributionLogo: false,
			                        fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                        fontSize: 12,
			                    },
			                    grid: {
			                        vertLines: { color: gridCol },
			                        horzLines: { color: gridCol },
			                    },
			                    rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.12, bottom: 0.12 } },
			                    timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
			                    crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
			                    handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                    handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                    height: mainEl.clientHeight || 280,
			                    width: mainEl.clientWidth || 760,
			                });
			                panelEl.__uiGlmBhMainChart = chart;

				                const colors = {
				                    pct_ma5: cssVar('--info', isDark ? 'rgba(34,211,238,0.95)' : 'rgba(6,182,212,0.95)'),
				                    pct_ma20: cssVar('--primary-light', isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)'),
				                    pct_ma50: cssVar('--purple', isDark ? 'rgba(167,139,250,0.95)' : 'rgba(139,92,246,0.95)'),
				                    pct_ma200: cssVar('--chart-up', 'rgba(16,185,129,0.95)'),
				                };

			                const selected = getSelected();
			                const keys = Array.from(selected.size ? selected : new Set(['pct_ma20']));
			                for (const k of keys) {
			                    const data = buildLineData(k);
			                    if (data.length < 2) continue;
			                    const line = chart.addLineSeries({ color: colors[k] || colors.pct_ma20, lineWidth: 2 });
			                    line.setData(data);
			                }

			                // Regime guide lines.
			                try {
			                    const base = chart.addLineSeries({ color: 'rgba(148,163,184,0.0)' });
			                    [20, 50, 80].forEach((lvl) => {
			                        base.createPriceLine({
			                            price: lvl,
			                            color: gridCol,
			                            lineWidth: 1,
			                            lineStyle: LightweightCharts.LineStyle.Dotted,
			                            axisLabelVisible: true,
			                            title: `${lvl}%`,
			                        });
			                    });
			                    base.setData([]);
			                } catch (_) {}

			                chart.timeScale().fitContent();

			                if (panelEl.__uiGlmBhMainResizeObs) {
			                    try { panelEl.__uiGlmBhMainResizeObs.disconnect(); } catch (_) {}
			                    panelEl.__uiGlmBhMainResizeObs = null;
			                }
			                const ro = new ResizeObserver(() => {
			                    try {
			                        chart.applyOptions({ width: mainEl.clientWidth, height: mainEl.clientHeight });
			                        chart.timeScale().fitContent();
			                    } catch (_) {}
			                });
			                ro.observe(mainEl);
			                panelEl.__uiGlmBhMainResizeObs = ro;
			            };

			            const drawSparks = () => {
			                const sparks = panelEl.querySelectorAll('[data-bh-spark]');
			                sparks.forEach((box) => {
			                    const key = box.getAttribute('data-bh-spark');
			                    const el = box.querySelector('[data-role=\"spark\"]');
			                    if (!key || !el) return;

			                    if (box.__uiGlmSparkChart) {
			                        try { box.__uiGlmSparkChart.remove(); } catch (_) {}
			                        box.__uiGlmSparkChart = null;
			                    }

			                    const data = buildLineData(key).slice(-Math.min(80, series.length));
			                    if (data.length < 2) return;

			                    const chart = LightweightCharts.createChart(el, {
			                        layout: { background: { type: 'solid', color: chartBg }, textColor: textCol, attributionLogo: false, fontSize: 10 },
			                        grid: { vertLines: { visible: false }, horzLines: { visible: false } },
			                        rightPriceScale: { visible: false },
			                        leftPriceScale: { visible: false },
			                        timeScale: { visible: false },
			                        crosshair: { mode: LightweightCharts.CrosshairMode.Hidden },
			                        handleScroll: false,
			                        handleScale: false,
			                        height: el.clientHeight || 70,
			                        width: el.clientWidth || 160,
			                    });
			                    box.__uiGlmSparkChart = chart;
			                    const line = chart.addLineSeries({ color: isDark ? 'rgba(226,232,240,0.80)' : 'rgba(15,23,42,0.70)', lineWidth: 2 });
			                    line.setData(data);
			                    chart.timeScale().fitContent();

			                    if (box.__uiGlmSparkResizeObs) {
			                        try { box.__uiGlmSparkResizeObs.disconnect(); } catch (_) {}
			                        box.__uiGlmSparkResizeObs = null;
			                    }
			                    const ro = new ResizeObserver(() => {
			                        try {
			                            chart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
			                            chart.timeScale().fitContent();
			                        } catch (_) {}
			                    });
			                    ro.observe(el);
			                    box.__uiGlmSparkResizeObs = ro;
			                });
			            };

			            const bindControls = () => {
			                if (!levelsEl) return;
			                levelsEl.querySelectorAll('input[type=\"checkbox\"][data-bh]').forEach(inp => {
			                    inp.addEventListener('change', () => drawMain());
			                });
			            };

				            bindControls();
				            drawMain();
				            drawSparks();

				            // Keyboard support for clickable MA cards.
				            panelEl.querySelectorAll('.bh-spark[role="button"]').forEach(card => {
				                card.addEventListener('keydown', (e) => {
				                    if (e.key === 'Enter' || e.key === ' ') {
				                        e.preventDefault();
				                        openBreadthHistoryDetailFromEl(card);
				                    }
				                });
				            });
				        }

				        function openBreadthHistoryDetailFromEl(el) {
				            const payload = getBreadthHistoryPayload();
				            if (!payload || typeof LightweightCharts === 'undefined') {
				                openUiModal({
				                    tone: 'neutral',
				                    title: 'Breadth history',
				                    subtitle: 'KhÃ´ng cÃ³ dá»¯ liá»‡u',
				                    bodyHtml: `<div class="info-box"><p>ChÆ°a cÃ³ dá»¯ liá»‡u breadth history Ä‘á»ƒ hiá»ƒn thá»‹.</p></div>`,
				                });
				                return;
				            }

				            const key = (el && el.getAttribute) ? (el.getAttribute('data-bh-spark') || '') : '';
				            const label = (el && el.getAttribute) ? (el.getAttribute('data-bh-label') || key) : key;
				            if (!key) return;

				            const series = Array.isArray(payload.series) ? payload.series : [];
				            const pts = series
				                .filter(r => r && r.d && r[key] != null && Number.isFinite(Number(r[key])))
				                .map(r => ({ d: r.d, v: Number(r[key]) }));
				            if (pts.length < 2) {
				                openUiModal({
				                    tone: 'neutral',
				                    title: `Breadth ${escapeHtml(label)}`,
				                    subtitle: 'KhÃ´ng Ä‘á»§ dá»¯ liá»‡u',
				                    bodyHtml: `<div class="info-box"><p>KhÃ´ng Ä‘á»§ dá»¯ liá»‡u Ä‘á»ƒ váº½ biá»ƒu Ä‘á»“ cho ${escapeHtml(label)}.</p></div>`,
				                });
				                return;
				            }

				            const last = pts[pts.length - 1];
				            const current = last.v;
				            const values = pts.map(p => p.v);
				            const below = values.filter(v => v <= current).length;
				            const percentile = values.length ? (100 * (below / values.length)) : 0;

				            const prev = (n) => (pts.length > n ? pts[pts.length - 1 - n].v : null);
				            const d1w = prev(5) == null ? null : (current - prev(5));
				            const d1m = prev(20) == null ? null : (current - prev(20));
				            const chipCls = (v) => (v == null ? '' : (v >= 0 ? 'positive' : 'negative'));
				            const fmtPp = (v) => (v == null ? 'N/A' : `${v >= 0 ? '+' : ''}${v.toFixed(1)}pp`);

				            const chartId = `bh_detail_${key}_${Date.now()}`;
				            const explain = `Breadth ${label} = % cá»• phiáº¿u Ä‘Ã³ng cá»­a > ${label} (trÃªn toÃ n HOSE).`;

				            openUiModal({
				                tone: 'neutral',
				                title: `Breadth ${escapeHtml(label)}`,
				                subtitle: `As-of: ${escapeHtml(payload.asof || last.d || '')}`,
				                bodyHtml: `
				                    <div class="ui-metrics" style="margin-bottom: 12px;">
				                        <div class="ui-metric"><div class="k">Hiá»‡n táº¡i</div><div class="v">${escapeHtml(current.toFixed(1))}%</div></div>
				                        <div class="ui-metric"><div class="k">Percentile</div><div class="v">${escapeHtml(percentile.toFixed(1))}%</div></div>
				                        <div class="ui-metric"><div class="k">vs 1w</div><div class="v"><span class="bh-chip ${chipCls(d1w)}">${escapeHtml(fmtPp(d1w))}</span></div></div>
				                        <div class="ui-metric"><div class="k">vs 1m</div><div class="v"><span class="bh-chip ${chipCls(d1m)}">${escapeHtml(fmtPp(d1m))}</span></div></div>
				                    </div>
				                    <div class="info-box" style="margin-bottom: 12px;">
				                        <p><strong>Diá»…n giáº£i:</strong> ${escapeHtml(explain)}</p>
				                        <p style="margin-top:6px;"><strong>NgÆ°á»¡ng tham chiáº¿u:</strong> 20 / 50 / 80 (percent)</p>
				                    </div>
				                    <div class="bh-chart" id="${chartId}" style="height: 320px;"></div>
				                `,
				            });

				            setTimeout(() => initBreadthHistoryDetailChart(chartId, key), 0);
				        }

				        function initBreadthHistoryDetailChart(chartId, key) {
				            const payload = getBreadthHistoryPayload();
				            const el = document.getElementById(chartId);
				            if (!payload || !el || typeof LightweightCharts === 'undefined') return;

				            const series = Array.isArray(payload.series) ? payload.series : [];
				            const data = series
				                .filter(r => r && r.d && r[key] != null && Number.isFinite(Number(r[key])))
				                .map(r => ({ time: r.d, value: Number(r[key]) }));
				            if (data.length < 2) return;

				            const theme = document.body.getAttribute('data-theme') || 'light';
				            const isDark = theme === 'dark';
				            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
				            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
				            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';

				            try { if (el.__uiGlmBhDetailChart) el.__uiGlmBhDetailChart.remove(); } catch (_) {}

				            const chart = LightweightCharts.createChart(el, {
				                layout: {
				                    background: { type: 'solid', color: chartBg },
				                    textColor: textCol,
				                    attributionLogo: false,
				                    fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
				                    fontSize: 12,
				                },
				                grid: {
				                    vertLines: { color: gridCol },
				                    horzLines: { color: gridCol },
				                },
				                rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.12, bottom: 0.12 } },
				                timeScale: { borderVisible: false, rightOffset: 6, fixLeftEdge: true, fixRightEdge: true },
				                crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
				                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
				                handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
				                height: el.clientHeight || 320,
				                width: el.clientWidth || 760,
				            });
				            el.__uiGlmBhDetailChart = chart;

				            const line = chart.addLineSeries({
				                color: isDark ? 'rgba(96,165,250,0.95)' : 'rgba(59,130,246,0.95)',
				                lineWidth: 2,
				            });
				            line.setData(data);

				            const guideCol = isDark ? 'rgba(226,232,240,0.25)' : 'rgba(15,23,42,0.20)';
				            [20, 50, 80].forEach((lvl) => {
				                try {
				                    line.createPriceLine({
				                        price: lvl,
				                        color: guideCol,
				                        lineWidth: 1,
				                        lineStyle: LightweightCharts.LineStyle.Dashed,
				                        axisLabelVisible: false,
				                        title: '',
				                    });
				                } catch (_) {}
				            });

				            chart.timeScale().fitContent();

				            try { if (el.__uiGlmBhDetailResizeObs) el.__uiGlmBhDetailResizeObs.disconnect(); } catch (_) {}
				            const ro = new ResizeObserver(() => {
				                try {
				                    chart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
				                    chart.timeScale().fitContent();
				                } catch (_) {}
				            });
				            ro.observe(el);
				            el.__uiGlmBhDetailResizeObs = ro;
				        }

			        function parseBreadthMetricsFromReportHtml(sectionHtml) {
			            try {
			                const root = document.createElement('div');
			                root.innerHTML = sectionHtml || '';
			                const text = (root.textContent || '').replace(/\s+/g, ' ').trim();
			                if (!text) return null;

			                const parseNum = (raw) => {
			                    if (raw == null) return null;
			                    const v = Number(String(raw).replace(/,/g, '.'));
			                    return Number.isFinite(v) ? v : null;
			                };
			                const parseInt = (raw) => {
			                    if (raw == null) return null;
			                    const v = Number(String(raw).replace(/[^\d]/g, ''));
			                    return Number.isFinite(v) ? v : null;
			                };

			                let adv = null, dec = null, advPct = null;
			                let m = text.match(/\bA\s*\/\s*D\s*([0-9]{1,5})\s*\/\s*([0-9]{1,5})\b/i);
			                if (m) {
			                    adv = parseInt(m[1]);
			                    dec = parseInt(m[2]);
			                } else {
			                    m = text.match(/ch(?:á»‰|i)\s*c(?:Ã³|o)\s*([0-9]{1,5})\s*m(?:Ã£|a)\s*t(?:Äƒ|a)ng[^.]{0,120}?([0-9]{1,5})\s*m(?:Ã£|a)\s*gi(?:áº£|a)m/i);
			                    if (m) {
			                        adv = parseInt(m[1]);
			                        dec = parseInt(m[2]);
			                    }
			                }
			                m = text.match(/t(?:á»·|i)\s*l(?:á»‡|e)\s*t(?:Äƒ|a)ng[^0-9]{0,30}([0-9]+(?:[.,][0-9]+)?)\s*%/i);
			                if (m) advPct = parseNum(m[1]);

			                m = text.match(/\bTRIN\b[^0-9]{0,20}([0-9]+(?:[.,][0-9]+)?)\b/i);
			                const trin = m ? parseNum(m[1]) : null;

			                m = text.match(/volume\s*ratio[^0-9]{0,30}([0-9]+(?:[.,][0-9]+)?)\s*x?/i);
			                const volumeRatio = m ? parseNum(m[1]) : null;

			                const hasAny = (adv != null && dec != null) || trin != null || volumeRatio != null;
			                if (!hasAny) return null;

			                // Reconstruct total/unchanged if possible (keeps UI consistent with report text).
			                let total = null;
			                if (adv != null && advPct != null && advPct > 0) {
			                    total = Math.round((adv * 100) / advPct);
			                }
			                let unchanged = null;
			                if (total != null && adv != null && dec != null) {
			                    unchanged = total - adv - dec;
			                    if (!Number.isFinite(unchanged) || unchanged < 0) unchanged = null;
			                }

			                return { adv, dec, unchanged, total, trin, volumeRatio };
			            } catch (_) {
			                return null;
			            }
			        }

			        function extractBreadthEvidenceHtml(sectionHtml, kind) {
			            try {
			                const root = document.createElement('div');
			                root.innerHTML = sectionHtml || '';
			                const ps = Array.from(root.querySelectorAll('p'));
			                const stripLeadingIndex = (t) => {
			                    const s = String(t || '').trim();
			                    // Remove leading numbering like "1.", "2)", "3 -", "4:"
			                    return s.replace(/^\s*\d+\s*[\.\)\-:]\s*/g, '').trim();
			                };
			                const texts = ps
			                    .map(p => stripLeadingIndex((p.textContent || '').replace(/\s+/g, ' ')))
			                    .filter(Boolean);
			                if (!texts.length) return `<p>KhÃ´ng tÃ¬m tháº¥y Ä‘oáº¡n text liÃªn quan trong bÃ¡o cÃ¡o.</p>`;

			                const pickBy = (re) => texts.filter(t => re.test(t));
			                let picked = [];
			                if (kind === 'ad') {
			                    picked = pickBy(/tá»·\s*lá»‡\s*tÄƒng\/giáº£m|advance\/decline|\bA\/D\b/i);
			                } else if (kind === 'trin') {
			                    picked = pickBy(/\bTRIN\b/i);
			                } else if (kind === 'vr') {
			                    picked = pickBy(/volume\s*ratio/i);
			                } else if (kind === 'mcc') {
			                    picked = pickBy(/mcclellan/i);
			                }

			                // Limit to a few paragraphs to keep popup compact.
			                const out = (picked.length ? picked : []).slice(0, 3);
			                if (!out.length) return `<p>KhÃ´ng tÃ¬m tháº¥y Ä‘oáº¡n text liÃªn quan trong bÃ¡o cÃ¡o.</p>`;

			                return out.map(t => `<p>${escapeHtml(t)}</p>`).join('');
			            } catch (_) {
			                return `<p>KhÃ´ng tÃ¬m tháº¥y Ä‘oáº¡n text liÃªn quan trong bÃ¡o cÃ¡o.</p>`;
			            }
			        }

				        function buildBreadthSnapshotPanelHtml(panelId, indexKey, payload) {
				            if (!payload) return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u breadth snapshot (1 ngÃ y).</p></div>`;

				            const adv = payload.adv;
				            const dec = payload.dec;
				            const unchanged = payload.unchanged;
				            const total = payload.total;
				            const trin = payload.trin;
				            const volumeRatio = payload.volumeRatio;
				            const mcclellan = payload.mcclellan;

				            const totalKnown = (adv != null && dec != null)
				                ? (adv + dec + (unchanged != null ? unchanged : 0))
				                : null;
				            const denom = total != null ? total : (totalKnown != null ? totalKnown : null);

			            const pct = (x) => (denom && x != null ? Math.max(0, Math.min(100, 100 * (x / denom))) : 0);
			            const advPct = pct(adv);
			            const decPct = pct(dec);
			            const unPct = pct(unchanged);

			            const clamp01 = (v) => Math.max(0, Math.min(1, v));
					            const trinPos = trin == null ? 0.5 : clamp01(trin / 4.0);
					            const vrPos = volumeRatio == null ? 0.5 : clamp01(volumeRatio / 2.0);
					            const oscPos = mcclellan == null ? 0.5 : clamp01((mcclellan + 100) / 200);
					            const upMid = cssVar('--chart-up-mid', 'rgba(16,185,129,0.70)');
					            const downMid = cssVar('--chart-down-mid', 'rgba(239,68,68,0.70)');

			            const fmt2 = (v) => (v == null ? 'N/A' : Number(v).toFixed(2));
			            const fmt0 = (v) => (v == null ? 'N/A' : Number(v).toLocaleString());

			            return `
			                <div class="breadth-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="breadth-toolbar">
			                        <div class="title">Snapshot breadth (1 ngÃ y)</div>
			                        <div class="note">Nháº¥n Ä‘á»ƒ xem chi tiáº¿t</div>
			                    </div>
			                    <div class="breadth-grid">
			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="ad" data-adv="${adv ?? ''}" data-dec="${dec ?? ''}" data-unchanged="${unchanged ?? ''}" data-total="${total ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ“ˆ A/D (Advance/Decline)</div>
			                            <div class="v"><span>${fmt0(adv)}/${fmt0(dec)}</span><span>${denom ? `Total: ${fmt0(denom)}` : ''}</span></div>
			                            <div class="mini-bar" aria-hidden="true">
			                                <span class="pos" style="width:${advPct.toFixed(1)}%"></span>
			                                <span class="neu" style="width:${unPct.toFixed(1)}%"></span>
			                                <span class="neg" style="width:${decPct.toFixed(1)}%"></span>
			                            </div>
			                            <div class="hint">Tá»· lá»‡ tÄƒng/giáº£m + unchanged</div>
			                        </div>

			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="trin" data-trin="${trin ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ§­ TRIN</div>
			                            <div class="v"><span>${fmt2(trin)}</span><span>${trin != null ? (trin > 1.2 ? 'Ãp lá»±c bÃ¡n' : (trin < 0.8 ? 'Ãp lá»±c mua' : 'Trung tÃ­nh')) : 'N/A'}</span></div>
			                            <div class="mini-gauge" aria-hidden="true">
			                                <span class="marker" style="left: calc(${(trinPos * 100).toFixed(2)}% - 1px)"></span>
			                            </div>
			                            <div class="hint">NgÆ°á»¡ng tham chiáº¿u: 0.8 / 1.0 / 1.2 / 2.0+</div>
			                        </div>

			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="vr" data-volume-ratio="${volumeRatio ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ’§ Volume Ratio</div>
			                            <div class="v"><span>${volumeRatio != null ? `${fmt2(volumeRatio)}x` : 'N/A'}</span><span>${volumeRatio != null ? (volumeRatio > 1.2 ? 'UpVol trá»™i' : (volumeRatio < 0.8 ? 'DownVol trá»™i' : 'CÃ¢n báº±ng')) : 'N/A'}</span></div>
			                            <div class="mini-gauge" aria-hidden="true">
			                                <span class="marker" style="left: calc(${(vrPos * 100).toFixed(2)}% - 1px)"></span>
			                            </div>
			                            <div class="hint">AdvVol / DecVol (snapshot)</div>
			                        </div>

			                        <div class="breadth-card" role="button" tabindex="0"
			                             data-kind="mcc" data-mcclellan="${mcclellan ?? ''}"
			                             onclick="openBreadthDetailFromEl(this)">
			                            <div class="k">ðŸ“Š McClellan Oscillator</div>
			                            <div class="v"><span>${mcclellan != null ? fmt2(mcclellan) : 'N/A'}</span><span>${mcclellan != null ? (mcclellan > 0 ? 'DÆ°Æ¡ng' : (mcclellan < 0 ? 'Ã‚m' : '0')) : 'N/A'}</span></div>
				                            <div class="mini-osc" aria-hidden="true">
				                                <span class="zero"></span>
				                                <span class="fill" style="${mcclellan == null ? 'display:none;' : (mcclellan >= 0 ? `left:50%; width:${((oscPos - 0.5) * 200).toFixed(1)}%; background: ${upMid};` : `left:${(oscPos * 100).toFixed(1)}%; width:${((0.5 - oscPos) * 200).toFixed(1)}%; background: ${downMid};`)}"></span>
				                            </div>
			                            <div class="hint">Snapshot value quanh 0</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function openBreadthDetailFromEl(el) {
			            try {
			                const kind = el.getAttribute('data-kind') || '';
			                const sectionHtml = (typeof window !== 'undefined' && window.__uiGlmBreadthSectionHtml) ? window.__uiGlmBreadthSectionHtml : '';
			                const evidenceHtml = extractBreadthEvidenceHtml(sectionHtml, kind);
			                const evidenceBlock = `
			                    <div style="height: 10px;"></div>
			                    <div class="info-box">
			                        <p><strong>TrÃ­ch Ä‘oáº¡n bÃ¡o cÃ¡o:</strong></p>
			                        ${evidenceHtml}
			                    </div>
			                `;
			                if (kind === 'ad') {
			                    const adv = el.getAttribute('data-adv') || 'N/A';
			                    const dec = el.getAttribute('data-dec') || 'N/A';
			                    const unchanged = el.getAttribute('data-unchanged') || 'N/A';
			                    const total = el.getAttribute('data-total') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'Advance/Decline (A/D)',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">MÃ£ tÄƒng</div><div class="v">${escapeHtml(adv)}</div></div>
			                                <div class="ui-metric"><div class="k">MÃ£ giáº£m</div><div class="v">${escapeHtml(dec)}</div></div>
			                                <div class="ui-metric"><div class="k">Unchanged</div><div class="v">${escapeHtml(unchanged)}</div></div>
			                                <div class="ui-metric"><div class="k">Total</div><div class="v">${escapeHtml(total)}</div></div>
			                            </div>
			                            <div style="margin-top:10px; color: var(--text-secondary); font-weight: 800; font-size: 0.9rem;">
			                                Advance/Decline pháº£n Ã¡nh Ä‘á»™ rá»™ng thá»‹ trÆ°á»ng trong ngÃ y.
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                    return;
			                }
			                if (kind === 'trin') {
			                    const trin = el.getAttribute('data-trin') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'TRIN',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">TRIN</div><div class="v">${escapeHtml(trin)}</div></div>
			                                <div class="ui-metric"><div class="k">Gá»£i Ã½</div><div class="v">0.8â€“1.2: trung tÃ­nh</div></div>
			                                <div class="ui-metric"><div class="k">BÃªn mua</div><div class="v">&lt; 0.8</div></div>
			                                <div class="ui-metric"><div class="k">BÃªn bÃ¡n</div><div class="v">&gt; 1.2</div></div>
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                    return;
			                }
			                if (kind === 'vr') {
			                    const vr = el.getAttribute('data-volume-ratio') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'Volume Ratio',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">Volume Ratio</div><div class="v">${escapeHtml(vr)}${vr !== 'N/A' ? 'x' : ''}</div></div>
			                                <div class="ui-metric"><div class="k">CÃ´ng thá»©c</div><div class="v">AdvVol / DecVol</div></div>
			                                <div class="ui-metric"><div class="k">Diá»…n giáº£i</div><div class="v">&lt;0.8: down-volume trá»™i</div></div>
			                                <div class="ui-metric"><div class="k">Trung tÃ­nh</div><div class="v">0.8â€“1.2</div></div>
			                                <div class="ui-metric"><div class="k">Up-volume</div><div class="v">&gt;1.2</div></div>
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                    return;
			                }
			                if (kind === 'mcc') {
			                    const v = el.getAttribute('data-mcclellan') || 'N/A';
			                    openUiModal({
			                        tone: 'neutral',
			                        title: 'McClellan Oscillator',
			                        subtitle: 'Snapshot (1 ngÃ y)',
			                        bodyHtml: `
			                            <div class="ui-metrics">
			                                <div class="ui-metric"><div class="k">GiÃ¡ trá»‹</div><div class="v">${escapeHtml(v)}</div></div>
			                                <div class="ui-metric"><div class="k">Diá»…n giáº£i</div><div class="v">DÆ°Æ¡ng: breadth cáº£i thiá»‡n</div></div>
			                                <div class="ui-metric"><div class="k">Ã‚m</div><div class="v">breadth suy yáº¿u</div></div>
			                                <div class="ui-metric"><div class="k">0</div><div class="v">cÃ¢n báº±ng</div></div>
			                            </div>
			                            ${evidenceBlock}
			                        `,
			                    });
			                }
			            } catch (_) {}
			        }

			        function renderIndexOhlcvPanelHtml(panelId, indexKey) {
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) {
			                return `<div class="info-box"><p>KhÃ´ng cÃ³ dá»¯ liá»‡u OHLCV cho index nÃ y.</p></div>`;
			            }

			            const metaLeft = payload.asof ? `As-of: ${escapeHtml(payload.asof)}` : '';
			            const metaRight = payload.constituents ? `Constituents: ${escapeHtml(payload.constituents)} (${escapeHtml(payload.name)})` : '';
			            const metaNote = 'Trá»¥c Y: GiÃ¡ (OHLC).';

			            return `
			                <div class="ohlcv-panel" id="${panelId}" data-index-key="${escapeHtml(indexKey)}">
			                    <div class="ohlcv-toolbar">
			                        <div class="title">Biá»ƒu Ä‘á»“ náº¿n &amp; khá»‘i lÆ°á»£ng</div>
			                        <div class="ohlcv-controls">
			                            <div class="fixed">100 phiÃªn (cá»‘ Ä‘á»‹nh)</div>
			                        </div>
			                    </div>
			                    <div class="ohlcv-body">
			                        <div class="ohlcv-chart" data-role="chart"></div>
			                        <div class="ohlcv-tooltip" data-role="tooltip" style="display:none;"></div>
			                        <div class="ohlcv-meta">
			                            <div>${metaLeft}</div>
			                            <div>${metaRight}</div>
			                            <div>${metaNote}</div>
			                        </div>
			                    </div>
			                </div>
			            `;
			        }

			        function initIndexOhlcvPanel(panelId, indexKey) {
			            const panelEl = document.getElementById(panelId);
			            if (!panelEl) return;
			            const payload = getIndexOhlcvPayload(indexKey);
			            if (!payload) return;

			            const chartEl = panelEl.querySelector('[data-role="chart"]');
			            const tooltipEl = panelEl.querySelector('[data-role="tooltip"]');
			            if (!chartEl || typeof LightweightCharts === 'undefined') return;

			            const barsAll = payload.bars || [];
			            const bars = barsAll.slice(-Math.min(100, barsAll.length));
			            if (bars.length < 2) return;

			            const theme = document.body.getAttribute('data-theme') || 'light';
			            const isDark = theme === 'dark';
			            const chartBg = isDark ? 'rgba(2,6,23,0.0)' : 'rgba(255,255,255,0.0)';
			            const textCol = isDark ? 'rgba(226,232,240,0.85)' : 'rgba(15,23,42,0.75)';
			            const gridCol = isDark ? 'rgba(148,163,184,0.16)' : 'rgba(148,163,184,0.28)';
				            const upCol = cssVar('--chart-up', 'rgba(16,185,129,0.95)');
				            const downCol = cssVar('--chart-down', 'rgba(239,68,68,0.95)');
				            const upColSoft = cssVar('--chart-up-soft', 'rgba(16,185,129,0.45)');
				            const downColSoft = cssVar('--chart-down-soft', 'rgba(239,68,68,0.45)');
				            const wickCol = cssVar('--chart-wick', isDark ? 'rgba(226,232,240,0.55)' : 'rgba(15,23,42,0.35)');

			            // Cleanup previous instance if exists
			            if (panelEl.__uiGlmChart) {
			                try { panelEl.__uiGlmChart.remove(); } catch (_) {}
			                panelEl.__uiGlmChart = null;
			            }

			            const chart = LightweightCharts.createChart(chartEl, {
			                layout: {
			                    background: { type: 'solid', color: chartBg },
			                    textColor: textCol,
			                    attributionLogo: false,
			                    fontFamily: '-apple-system, system-ui, Segoe UI, Roboto, Arial',
			                    fontSize: 12,
			                },
			                grid: {
			                    vertLines: { color: gridCol },
			                    horzLines: { color: gridCol },
			                },
			                rightPriceScale: {
			                    borderVisible: false,
			                },
			                timeScale: {
			                    borderVisible: false,
			                    rightOffset: 4,
			                    fixLeftEdge: true,
			                    fixRightEdge: true,
			                },
			                crosshair: {
			                    mode: LightweightCharts.CrosshairMode.Magnet,
			                },
			                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
			                handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
			                height: chartEl.clientHeight || 260,
			                width: chartEl.clientWidth || 600,
			            });
			            panelEl.__uiGlmChart = chart;

				            const candle = chart.addCandlestickSeries({
				                upColor: upCol,
				                downColor: downCol,
				                borderUpColor: upCol,
				                borderDownColor: downCol,
				                wickUpColor: wickCol,
				                wickDownColor: wickCol,
				            });

			            const volume = chart.addHistogramSeries({
			                priceFormat: { type: 'volume' },
			                priceScaleId: '',
			                scaleMargins: { top: 0.78, bottom: 0 },
			            });

			            const candleData = bars.map(b => ({ time: b.d, open: b.o, high: b.h, low: b.l, close: b.c }));
			            candle.setData(candleData);
				            const volData = bars.map(b => ({
				                time: b.d,
				                value: b.v || 0,
				                color: (b.c >= b.o) ? upColSoft : downColSoft,
				            }));
			            volume.setData(volData);
			            chart.timeScale().fitContent();

			            if (tooltipEl) {
			                const fmt = (x) => (typeof x === 'number' && Number.isFinite(x)) ? x.toLocaleString(undefined, { maximumFractionDigits: 2 }) : 'N/A';
			                const fmtVol = (x) => (typeof x === 'number' && Number.isFinite(x)) ? x.toLocaleString(undefined, { maximumFractionDigits: 0 }) : 'N/A';
			                const setTip = (t, o, h, l, c, v) => {
			                    tooltipEl.innerHTML = `<div style="font-weight:900;margin-bottom:4px;">${escapeHtml(String(t || ''))}</div>` +
			                        `<div>O: ${escapeHtml(fmt(o))}  H: ${escapeHtml(fmt(h))}  L: ${escapeHtml(fmt(l))}  C: ${escapeHtml(fmt(c))}</div>` +
			                        `<div style="margin-top:4px;">Vol: ${escapeHtml(fmtVol(v))}</div>`;
			                };
			                const last = bars[bars.length - 1];
			                setTip(last.d, last.o, last.h, last.l, last.c, last.v);
			                chart.subscribeCrosshairMove((param) => {
			                    if (!param || !param.time || !param.point) {
			                        tooltipEl.style.display = 'none';
			                        return;
			                    }
			                    tooltipEl.style.display = 'block';
			                    const t = param.time;
			                    const cData = param.seriesData.get(candle);
			                    const vData = param.seriesData.get(volume);
			                    if (cData) {
			                        setTip(t, cData.open, cData.high, cData.low, cData.close, vData ? vData.value : null);
			                    }
			                });
			                // Hide tooltip when leaving the chart area
			                chartEl.addEventListener('mouseleave', () => {
			                    tooltipEl.style.display = 'none';
			                });
			            }

			            // resize: per-panel observer
			            if (panelEl.__uiGlmResizeObs) {
			                try { panelEl.__uiGlmResizeObs.disconnect(); } catch (_) {}
			                panelEl.__uiGlmResizeObs = null;
			            }
			            const ro = new ResizeObserver(() => {
			                try {
			                    chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
			                    chart.timeScale().fitContent();
			                } catch (_) {}
			            });
			            ro.observe(chartEl);
			            panelEl.__uiGlmResizeObs = ro;
			        }

        function buildIndexSummaryHtml() {
            const rows = getSummaryIndexRows();
            const cardsHtml = renderSummaryCards(rows);
            return `
                <div class="overview-extras">
                    <div class="block">
                        <div class="block-header">ðŸ“Š THá»NG KÃŠ CÃC CHá»ˆ Sá»</div>
                        <div class="block-body">${cardsHtml}</div>
                    </div>
                </div>
            `;
        }

	        function buildMarketOverviewExtrasHtml() {
	            try {
	                const isMobile = isMobileViewport();
	                const rows = getSummaryIndexRows();
	                const summaryCards = renderSummaryCards(rows);

	                const stockData = window.UI_GLM_VNINDEX_HEATMAP || null;
	                const gainers = stockData && Array.isArray(stockData.gainers) ? stockData.gainers : [];
	                const losers = stockData && Array.isArray(stockData.losers) ? stockData.losers : [];
	                const dateText = stockData && stockData.date ? ` (date: ${stockData.date})` : '';

	                const gainersBlock = isMobile ? '' : renderStockHeatmapTable(
	                    gainers,
	                    `ðŸ”¥ Heatmap cá»• phiáº¿u VNINDEX TÄ‚NG GIÃ (giÃ¡ & giÃ¡ trá»‹ giao dá»‹ch)${dateText}`
	                );

	                const losersBlock = isMobile ? '' : renderStockHeatmapTable(
	                    losers,
	                    `ðŸ”¥ Heatmap cá»• phiáº¿u VNINDEX GIáº¢M GIÃ (giÃ¡ & giÃ¡ trá»‹ giao dá»‹ch)${dateText}`
	                );

	                const mobileNote = isMobile
	                    ? `<div class="info-box"><p><strong>Heatmap</strong> Ä‘ang Ä‘Æ°á»£c áº©n trÃªn mobile Ä‘á»ƒ tá»‘i Æ°u khÃ´ng gian hiá»ƒn thá»‹. Vui lÃ²ng má»Ÿ trÃªn desktop Ä‘á»ƒ xem.</p></div>`
	                    : '';

	                return `
	                    <div class="overview-extras">
	                        <div class="block">
	                            <div class="block-header">ðŸ“Š THá»NG KÃŠ CÃC CHá»ˆ Sá»</div>
	                            <div class="block-body">${summaryCards}</div>
	                        </div>
	                        ${mobileNote}
	                        ${gainersBlock}
	                        ${losersBlock}
	                    </div>
	                `;
	            } catch (err) {
	                const message = (err && err.message) ? err.message : String(err);
	                return `
	                    <div class="overview-extras">
	                        <div class="block">
	                            <div class="block-header">âš ï¸ Lá»—i render heatmap</div>
	                            <div class="block-body">
	                                <div class="info-box">
	                                    <p>KhÃ´ng render Ä‘Æ°á»£c heatmap do lá»—i JS.</p>
	                                    <p><strong>Chi tiáº¿t:</strong> ${escapeHtml(message)}</p>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                `;
	            }
	        }

	        function tryAutoSelectFromUrl() {
	            try {
	                const params = new URLSearchParams(window.location.search || '');
	                const indexKey = (params.get('index') || '').trim();
	                if (!indexKey) return;

	                if (!isIndexAllowedForCurrentPlan(indexKey)) return;

	                const sectionIndexRaw = params.get('section');
	                const sectionTitleRaw = params.get('sectionTitle');

	                if (!data || !data[indexKey]) return;
	                selectIndex(indexKey);

	                const indexData = data[indexKey];
	                const sections = getSectionsForIndex(indexKey);

	                if (sectionTitleRaw) {
	                    const target = normalizeTitle(decodeURIComponent(sectionTitleRaw));
	                    const foundIndex = sections.findIndex(s => normalizeTitle(s.title) === target);
	                    if (foundIndex >= 0) selectSection(foundIndex);
	                    return;
	                }

	                if (sectionIndexRaw != null && sectionIndexRaw !== '') {
	                    const sectionIndex = Number(sectionIndexRaw);
	                    if (Number.isFinite(sectionIndex) && sectionIndex >= 0 && sectionIndex < sections.length) {
	                        selectSection(sectionIndex);
	                    }
	                }
	            } catch (e) {
	                // no-op
	            }
	        }

	        function tryAutoOpenStockPopupFromUrl() {
	            try {
	                if (!document.getElementById('uiModal')) {
	                    setTimeout(tryAutoOpenStockPopupFromUrl, 50);
	                    return;
	                }

	                const params = new URLSearchParams(window.location.search || '');
	                const symbol = (params.get('stockPopup') || '').trim().toUpperCase();
	                if (!symbol) return;

	                const stockData = (typeof window !== 'undefined' && window.UI_GLM_VNINDEX_HEATMAP) ? window.UI_GLM_VNINDEX_HEATMAP : null;
	                if (!stockData) {
	                    setTimeout(tryAutoOpenStockPopupFromUrl, 50);
	                    return;
	                }

	                const pool = []
	                    .concat(Array.isArray(stockData.gainers) ? stockData.gainers : [])
	                    .concat(Array.isArray(stockData.losers) ? stockData.losers : []);
	                const p = pool.find(x => x && String(x.symbol || '').toUpperCase() === symbol);
	                if (!p) return;

	                const btn = document.createElement('button');
	                btn.dataset.symbol = String(p.symbol || symbol);
	                btn.dataset.changePct = String(p.change_pct ?? '');
	                btn.dataset.price = (p.price != null && Number.isFinite(Number(p.price))) ? Number(p.price).toFixed(2) : 'N/A';
	                btn.dataset.value = (p.value != null && Number.isFinite(Number(p.value))) ? formatCompactNumber(Number(p.value)) : 'N/A';
	                btn.dataset.volume = (p.volume != null && Number.isFinite(Number(p.volume))) ? formatCompactNumber(Number(p.volume)) : 'N/A';
	                openVnindexStockPopupFromEl(btn);
	            } catch (e) {
	                // no-op
	            }
	        }

	        // Render section list in middle column
	        function renderSectionList(indexKey) {
	            const index = data[indexKey];
	            if (!index || !index.sections) {
	                document.getElementById('sectionList').innerHTML = '<div class="no-sections">KhÃ´ng cÃ³ dá»¯ liá»‡u</div>';
	                return;
	            }

            // Update section nav header
            document.getElementById('sectionNavTitle').textContent = index.title.split('-')[0].trim();

	            const sections = getSectionsForIndex(indexKey);
	            const container = document.getElementById('sectionList');

            let html = '';
            sections.forEach((section, idx) => {
                const isWhatIf = section.title.toLowerCase().includes('what-if') ||
                                section.title.toLowerCase().includes('ká»‹ch báº£n');
                const isConclusion = section.title.toLowerCase().includes('káº¿t luáº­n');

                html += `
                    <div class="section-item ${isWhatIf ? 'whatif' : ''} ${isConclusion ? 'conclusion-section' : ''}"
                         onclick="selectSection(${idx})"
                         data-section="${idx}">
                        <span class="icon">${section.icon || (isWhatIf ? 'âš ï¸' : (isConclusion ? 'ðŸ“Œ' : 'ðŸ“Š'))}</span>
                        <span class="title">${section.title.replace(/`/g, '')}</span>
                    </div>
                `;
            });

	            container.innerHTML = html;
	        }

        // Select and display a single section
		        function selectSection(sectionIndex) {
		            if (!currentIndex) return;

	            const index = data[currentIndex];
	            const sections = getSectionsForIndex(currentIndex);
	            const section = sections[sectionIndex];

	            if (!section) return;

            currentSectionIndex = sectionIndex;

            // Update active state in section list
            document.querySelectorAll('.section-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`[data-section="${sectionIndex}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // Update page title
            document.getElementById('pageTitle').textContent = section.title.replace(/`/g, '');

	            // Show content, hide empty state
	            document.getElementById('emptyState').style.display = 'none';
	            const contentDiv = document.getElementById('singleSectionContent');
	            contentDiv.style.display = 'block';
	            try {
	                if (isMobileViewport()) document.body.classList.add('mobile-reading');
	            } catch (_) {}

				            const isUiHeatmapSection = section.__uiType === 'heatmap_gainers' || section.__uiType === 'heatmap_losers';
				            const normalizedSectionTitle = normalizeTitle(section.title);
				            const isKeyLevelsSection = normalizedSectionTitle === 'Má»¨C GIÃ QUAN TRá»ŒNG';
				            const isTargetLevelsSection = normalizedSectionTitle === 'GIÃ Má»¤C TIÃŠU';
				            const levelsExtractionEnabled = !UI_GLM_DISABLE_LEVELS_EXTRACTION;
					            const isTrendChartSection =
					                normalizedSectionTitle === 'XU HÆ¯á»šNG GIÃ' ||
					                normalizedSectionTitle === 'XU HÆ¯á»šNG KHá»I LÆ¯á»¢NG';
				            const isBreadthSentimentSection = normalizedSectionTitle === 'MARKET BREADTH & TÃ‚M LÃ THá»Š TRÆ¯á»œNG';
				            const isBreadthHistorySection = normalizedSectionTitle === 'Lá»ŠCH Sá»¬ & XU HÆ¯á»šNG BREADTH';
				            const isPriceContextSection =
				                normalizedSectionTitle.includes('WHAT-IF') ||
				                normalizedSectionTitle === 'CUNG-Cáº¦U' ||
				                (normalizedSectionTitle.includes('MÃ” HÃŒNH') && normalizedSectionTitle.includes('Náº¾N'));
			            const pricePanelMode =
			                (normalizedSectionTitle.includes('MÃ” HÃŒNH') && normalizedSectionTitle.includes('Náº¾N'))
			                    ? 'candles'
			                    : 'line';

	            // Clean and format content
	            const formatter = new ContentFormatter();
	            let cleanContent = section.content
	                .replace(/\\n/g, '\n')
	                .replace(/\\t/g, '')
	                .replace(/\s+/g, ' ')
	                .replace(/<\/p>\s*<p>/g, '</p><p>')
	                .replace(/<p>\s*/g, '<p>')
	                .replace(/\s*<\/p>/g, '</p>')
	                .trim();

            // Render content
            const isWhatIf = section.title.toLowerCase().includes('what-if') ||
                            section.title.toLowerCase().includes('ká»‹ch báº£n');

	            if (isUiHeatmapSection) {
	                const heatmapHtml = renderIndexHeatmapSection(
	                    currentIndex,
	                    section.__uiType === 'heatmap_gainers' ? 'gainers' : 'losers'
	                );
	                contentDiv.innerHTML = `
	                    <div class="section-card">
	                        <div class="section-body">
	                            ${heatmapHtml}
	                        </div>
	                    </div>
	                `;
			            } else if (isWhatIf) {
			                const pricePanelId = isPriceContextSection ? `price_${currentIndex}_${sectionIndex}` : null;
			                const pricePanelHtml = isPriceContextSection ? renderIndexPricePanelHtml(pricePanelId, currentIndex, pricePanelMode) : '';
			                contentDiv.innerHTML = `
			                    <div class="whatif-card">
			                        <div class="whatif-card-body">
			                            ${formatter.format(cleanContent)}
			                            ${isPriceContextSection ? `<div style="height: 12px;"></div>${pricePanelHtml}` : ''}
			                        </div>
			                    </div>
			                `;
			                if (isPriceContextSection && pricePanelId) {
			                    setTimeout(() => initIndexPricePanel(pricePanelId, currentIndex, pricePanelMode), 0);
			                }
				            } else if (isKeyLevelsSection && levelsExtractionEnabled) {
				                const panelId = `keylevels_${currentIndex}_${sectionIndex}`;
				                const panelHtml = renderKeyLevelsPanelHtml(panelId, currentIndex);

				                window.__uiGlmKeyLevelsStore = window.__uiGlmKeyLevelsStore || {};
				                window.__uiGlmKeyLevelsStore[panelId] = { sectionHtml: cleanContent };

		                contentDiv.innerHTML = `
		                    <div class="section-card">
		                        <div class="section-body">
		                            ${formatter.format(cleanContent)}
		                            <div style="height: 12px;"></div>
		                            ${panelHtml}
		                        </div>
		                    </div>
				                `;
				                setTimeout(() => initKeyLevelsPanel(panelId, currentIndex, cleanContent), 0);
				            } else if (isTargetLevelsSection && levelsExtractionEnabled) {
				                const panelId = `targetlevels_${currentIndex}_${sectionIndex}`;
				                const panelHtml = renderTargetLevelsPanelHtml(panelId, currentIndex);

				                window.__uiGlmTargetLevelsStore = window.__uiGlmTargetLevelsStore || {};
				                window.__uiGlmTargetLevelsStore[panelId] = { sectionHtml: cleanContent };

			                contentDiv.innerHTML = `
			                    <div class="section-card">
			                        <div class="section-body">
			                            ${formatter.format(cleanContent)}
			                            <div style="height: 12px;"></div>
			                            ${panelHtml}
			                        </div>
			                    </div>
			                `;
			                setTimeout(() => initTargetLevelsPanel(panelId, currentIndex, cleanContent), 0);
				            } else if (isTrendChartSection) {
				                const panelId = `ohlcv_${currentIndex}_${sectionIndex}`;
				                const panelHtml = renderIndexOhlcvPanelHtml(panelId, currentIndex);

		                contentDiv.innerHTML = `
		                    <div class="section-card">
		                        <div class="section-body">
		                            ${formatter.format(cleanContent)}
		                            <div style="height: 12px;"></div>
		                            ${panelHtml}
		                        </div>
		                    </div>
			                `;
			                setTimeout(() => initIndexOhlcvPanel(panelId, currentIndex), 0);
			            } else if (isBreadthHistorySection) {
			                const panelId = `breadthhist_${currentIndex}_${sectionIndex}`;
			                const panelHtml = renderBreadthHistoryPanelHtml(panelId, currentIndex);
			                contentDiv.innerHTML = `
			                    <div class="section-card">
			                        <div class="section-body">
			                            ${formatter.format(cleanContent)}
			                            <div style="height: 12px;"></div>
			                            ${panelHtml}
			                        </div>
			                    </div>
			                `;
			                setTimeout(() => initBreadthHistoryPanel(panelId), 0);
			            } else {
			                const isMarketOverview =
			                    currentIndex === 'overview' &&
			                    normalizeTitle(section.title) === 'Tá»”NG QUAN THá»Š TRÆ¯á»œNG';
		                const extras = isMarketOverview ? buildMarketOverviewExtrasHtml() : '';

	                const isRanking =
	                    currentIndex === 'overview' &&
	                    normalizeTitle(section.title) === 'Xáº¾P Háº NG';
	                const rankingExtras = isRanking ? buildIndexSummaryHtml() : '';
		                const pricePanelId = isPriceContextSection ? `price_${currentIndex}_${sectionIndex}` : null;
		                const pricePanelHtml = isPriceContextSection ? renderIndexPricePanelHtml(pricePanelId, currentIndex, pricePanelMode) : '';
			                const breadthPanelId = isBreadthSentimentSection ? `breadth_${currentIndex}_${sectionIndex}` : null;
			                const breadthSnap = isBreadthSentimentSection ? getMarketBreadthSnapshotPayload() : null;
			                const breadthPayload = isBreadthSentimentSection && breadthSnap
			                    ? {
			                        adv: breadthSnap.advancing,
			                        dec: breadthSnap.declining,
			                        unchanged: breadthSnap.unchanged,
			                        total: breadthSnap.total_stocks,
			                        trin: breadthSnap.trin,
			                        volumeRatio: breadthSnap.volume_ratio,
			                        mcclellan: breadthSnap.mcclellan,
			                        mcclellan_type: breadthSnap.mcclellan_type || '',
			                    }
			                    : null;
			                const breadthPanelHtml = isBreadthSentimentSection ? buildBreadthSnapshotPanelHtml(breadthPanelId, currentIndex, breadthPayload) : '';
		                if (isBreadthSentimentSection) {
		                    window.__uiGlmBreadthSectionHtml = cleanContent || '';
		                }

		                contentDiv.innerHTML = `
		                    <div class="section-card ${section.alert ? 'alert' : ''}">
		                        <div class="section-body">
	                            ${formatter.format(cleanContent)}
	                            ${extras}
	                            ${rankingExtras}
	                            ${isPriceContextSection ? `<div style="height: 12px;"></div>${pricePanelHtml}` : ''}
	                            ${isBreadthSentimentSection ? `<div style="height: 12px;"></div>${breadthPanelHtml}` : ''}
	                        </div>
	                    </div>
		                `;
		                if (isPriceContextSection && pricePanelId) {
		                    setTimeout(() => initIndexPricePanel(pricePanelId, currentIndex, pricePanelMode), 0);
		                }
		            }
		        }

	            // Mobile: after render, bring content into view (iOS: needs rAF + a retry after layout settles).
	            try {
	                if (isMobileViewport()) {
	                    const target = contentDiv || document.querySelector('#singleSectionContent') || document.querySelector('.main-content');
	                    scrollToElAfterRender(target, 8);
	                    setTimeout(() => scrollToElAfterRender(target, 8), 140);
	                    setTimeout(() => scrollToElAfterRender(target, 8), 420);
	                }
	            } catch (_) {}

        // Select index (left sidebar)
	        function selectIndex(key) {
	            if (!isIndexAllowedForCurrentPlan(key)) {
	                openPlanChooserModal();
	                return;
	            }

	            currentIndex = key;
	            currentSectionIndex = null;
	            try {
	                if (isMobileViewport()) document.body.classList.remove('mobile-reading');
	            } catch (_) {}

            // Update active state in index list
            document.querySelectorAll('.index-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-index="${key}"]`).classList.add('active');

            // Render section list
            renderSectionList(key);

            // Mobile: after selecting an index, bring the section list into view.
            try {
                if (isMobileViewport()) scrollToElAfterRender(document.querySelector('.section-nav'));
            } catch (_) {}

            // Reset main content
            document.getElementById('pageTitle').textContent = 'Chá»n má»¥c phÃ¢n tÃ­ch Ä‘á»ƒ xem';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('singleSectionContent').style.display = 'none';
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.index-item').forEach(item => {
                const name = item.querySelector('.name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        });

				        // Initialize (Lite public build)
				        applyPlanToUi();
				        setTimeout(() => {
				            tryAutoSelectFromUrl();
				            tryAutoOpenStockPopupFromUrl();
				        }, 0);
				        // Don't auto-select any index by default - let user choose

        // ========== DONATE MODAL FUNCTIONS ==========
        function showDonateModal() {
            const modal = document.getElementById('donateModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeDonateModal() {
            const modal = document.getElementById('donateModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Enable scrolling
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const donateModal = document.getElementById('donateModal');
            if (event.target === donateModal) closeDonateModal();

            const uiModal = document.getElementById('uiModal');
            if (event.target === uiModal) closeUiModal();
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key !== 'Escape') return;
            closeDonateModal();
            closeUiModal();
        });
    </script>

    <!-- UI Modal (cards + heatmaps) -->
    <div id="uiModal" class="ui-modal neutral">
        <div class="ui-modal-content">
            <button class="ui-close" onclick="closeUiModal()">&times;</button>
            <div class="ui-title" id="uiModalTitle"></div>
            <div class="ui-subtitle" id="uiModalSubtitle"></div>
            <div id="uiModalBody"></div>
        </div>
    </div>

    <!-- Donate Modal -->
    <div id="donateModal" class="donate-modal">
        <div class="donate-modal-content">
            <button class="donate-close" onclick="closeDonateModal()">&times;</button>

            <h2>ðŸ’ Má»i báº¡n má»™t ly cafe!</h2>

            <div class="donate-intro">
                ChÃ o báº¡n! ðŸ‘‹<br>
                Cáº£m Æ¡n báº¡n Ä‘Ã£ sá»­ dá»¥ng dashboard. Náº¿u báº¡n tháº¥y <strong>há»¯u Ã­ch</strong>,<br>
                má»™t ly cafe nhá» sáº½ giÃºp tÃ´i cÃ³ thÃªm Ä‘á»™ng lá»±c Ä‘á»ƒ phÃ¡t triá»ƒn thÃªm tÃ­nh nÄƒng má»›i! âœ¨
            </div>

            <div class="donate-options">
                <!-- MoMo -->
                <div class="donate-card">
                    <h3>ðŸ”µ MoMo</h3>
                    <img src="images/donate/momo_qr.jpg" alt="MoMo QR Code" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <p style="display: none; color: var(--warning);">ChÆ°a thÃªm QR code MoMo</p>
                    <p><strong>Email:</strong> stevetransg@gmail.com</p>
                    <p style="font-size: 0.85rem; margin-top: 12px; color: var(--text-secondary);">
                        ðŸ“± Scan QR hoáº·c chuyá»ƒn khoáº£n
                    </p>
                </div>
            </div>

            <div class="donate-note">
                ðŸ’– <strong>Cáº£m Æ¡n báº¡n tháº­t nhiá»u!</strong><br><br>
                Má»i sá»± á»§ng há»™ dÃ¹ nhá» Ä‘á»u lÃ  Ä‘á»™ng lá»±c lá»›n Ä‘á»ƒ tÃ´i tiáº¿p tá»¥c phÃ¡t triá»ƒn vÃ  cáº£i thiá»‡n dashboard má»—i ngÃ y! ðŸš€
            </div>

            <div class="donate-hearts">
                ðŸ’• ðŸŒ¸ âœ¨ ðŸŒ· ðŸ’—
            </div>
        </div>
    </div>
</body>
</html>
